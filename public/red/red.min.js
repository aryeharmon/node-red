/**
 * Copyright JS Foundation and other contributors, http://js.foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 **/
var RED={};RED.events=function(){var e={};return{on:function(t,n){e[t]=e[t]||[],e[t].push(n)},off:function(t,n){var o=e[t];if(o)for(var i=0;i<o.length;i++)if(o[i]===n)return void o.splice(i,1)},emit:function(t,n){if(e[t])for(var o=0;o<e[t].length;o++)try{e[t][o](n)}catch(e){console.log("RED.events.emit error: ["+t+"] "+e.toString()),console.log(e)}}}}(),RED.i18n={init:function(e){i18n.init({resGetPath:"locales/__ns__?lng=__lng__",dynamicLoad:!1,load:"current",ns:{namespaces:["editor","node-red","jsonata","infotips"],defaultNs:"editor"},fallbackLng:["en-US"],useCookie:!1},function(){e()}),RED._=function(){return i18n.t.apply(null,arguments)}},loadCatalog:function(e,t){var n=i18n.functions.toLanguages(i18n.detectLanguage()),o=n.length;n.forEach(function(n){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/"+e+"?lng="+n,success:function(i){i18n.addResourceBundle(n,e,i),0==--o&&t()}})})},loadNodeCatalogs:function(e){var t=i18n.functions.toLanguages(i18n.detectLanguage()),n=t.length;t.forEach(function(t){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"locales/nodes?lng="+t,success:function(o){Object.keys(o).forEach(function(e){i18n.addResourceBundle(t,e,o[e])}),0==--n&&e()}})})}},RED.settings=function(){var e={},t=function(){try{return"localStorage"in window&&null!==window.localStorage}catch(e){return!1}},n=function(t){$.ajax({headers:{Accept:"application/json"},dataType:"json",cache:!1,url:"settings",success:function(n){!function(t){for(var n in e)e.hasOwnProperty(n)&&RED.settings.hasOwnProperty(n)&&delete RED.settings[n];for(n in t)t.hasOwnProperty(n)&&(RED.settings[n]=t[n]);e=t}(n),RED.settings.user&&!RED.settings.user.anonymous||RED.settings.remove("auth-tokens"),console.log("Node-RED: "+n.version),t()},error:function(e,o,i){401===e.status?(/[?&]access_token=(.*?)(?:$|&)/.test(window.location.search)&&(window.location.search=""),RED.user.login(function(){n(t)})):console.log("Unexpected error:",e.status,o)}})};return{init:function(e){var t=/[?&]access_token=(.*?)(?:$|&)/.exec(window.location.search);if(t){var o=t[1];RED.settings.set("auth-tokens",{access_token:o}),window.location.search=""}$.ajaxSetup({beforeSend:function(e,t){if(!/^\s*(https?:|\/|\.)/.test(t.url)){var n=RED.settings.get("auth-tokens");n&&e.setRequestHeader("Authorization","Bearer "+n.access_token),e.setRequestHeader("Node-RED-API-Version","v2")}}}),n(e)},load:n,set:function(e,n){t()&&localStorage.setItem(e,JSON.stringify(n))},get:function(e){if(t())return JSON.parse(localStorage.getItem(e))},remove:function(e){t()&&localStorage.removeItem(e)},theme:function(e,t){if(!RED.settings.editorTheme)return t;var n=e.split("."),o=RED.settings.editorTheme;try{for(var i=0;i<n.length;i++)o=o[n[i]];return void 0===o?t:o}catch(e){return t}}}}(),RED.user=function(){function e(){$("#btn-usermenu-submenu li").remove(),RED.settings.user.anonymous?RED.menu.addItem("btn-usermenu",{id:"usermenu-item-login",label:RED._("menu.label.login"),onselect:function(){RED.user.login({cancelable:!0},function(){RED.settings.load(function(){RED.notify(RED._("user.loggedInAs",{name:RED.settings.user.username}),"success"),e()})})}}):(RED.menu.addItem("btn-usermenu",{id:"usermenu-item-username",label:"<b>"+RED.settings.user.username+"</b>"}),RED.menu.addItem("btn-usermenu",{id:"usermenu-item-logout",label:RED._("menu.label.logout"),onselect:function(){RED.user.logout()}}))}return{init:function(){if(RED.settings.user&&(!RED.settings.editorTheme||!RED.settings.editorTheme.hasOwnProperty("userMenu"))){var t=$('<li><a id="btn-usermenu" class="button hide" data-toggle="dropdown" href="#"></a></li>').prependTo(".header-toolbar");RED.settings.user.image?$('<span class="user-profile"></span>').css({backgroundImage:"url("+RED.settings.user.image+")"}).appendTo(t.find("a")):$('<i class="fa fa-user"></i>').appendTo(t.find("a")),RED.menu.init({id:"btn-usermenu",options:[]}),e()}},login:function(t,n){"function"==typeof t&&(n=t,t={});var o=$('<div id="node-dialog-login" class="hide"><div style="display: inline-block;width: 250px; vertical-align: top; margin-right: 10px; margin-bottom: 20px;"><img id="node-dialog-login-image" src=""/></div><div style="display: inline-block; width: 250px; vertical-align: bottom; margin-left: 10px; margin-bottom: 20px;"><form id="node-dialog-login-fields" class="form-horizontal" style="margin-bottom: 0px;"></form></div></div>');o.dialog({autoOpen:!1,dialogClass:"ui-dialog-no-close",modal:!0,closeOnEscape:!!t.cancelable,width:600,resizable:!1,draggable:!1}),$("#node-dialog-login-fields").empty(),$.ajax({dataType:"json",url:"auth/login",success:function(i){var a=0;if("credentials"==i.type){for(;a<i.prompts.length;a++){var s=i.prompts[a],r=$("<div/>",{class:"form-row"});$('<label for="node-dialog-login-'+s.id+'">'+RED._(s.label)+":</label><br/>").appendTo(r);var d=$('<input style="width: 100%" id="node-dialog-login-'+s.id+'" type="'+s.type+'" tabIndex="'+(a+1)+'"/>').appendTo(r);a<i.prompts.length-1&&d.keypress(function(){var e=r;return function(t){13==t.keyCode&&(e.next("div").find("input").focus(),t.preventDefault())}}()),r.appendTo("#node-dialog-login-fields")}$('<div class="form-row" style="text-align: right; margin-top: 10px;"><span id="node-dialog-login-failed" style="line-height: 2em;float:left;" class="hide">'+RED._("user.loginFailed")+'</span><img src="red/images/spin.svg" style="height: 30px; margin-right: 10px; " class="login-spinner hide"/>'+(t.cancelable?'<a href="#" id="node-dialog-login-cancel" style="margin-right: 20px;" tabIndex="'+(a+1)+'">'+RED._("common.label.cancel")+"</a>":"")+'<input type="submit" id="node-dialog-login-submit" style="width: auto;" tabIndex="'+(a+2)+'" value="'+RED._("user.login")+'"></div>').appendTo("#node-dialog-login-fields"),$("#node-dialog-login-submit").button(),$("#node-dialog-login-fields").submit(function(o){$("#node-dialog-login-submit").button("option","disabled",!0),$("#node-dialog-login-failed").hide(),$(".login-spinner").show();for(var a={client_id:"node-red-editor",grant_type:"password",scope:""},s=0;s<i.prompts.length;s++){var r=i.prompts[s];a[r.id]=$("#node-dialog-login-"+r.id).val()}$.ajax({url:"auth/token",type:"POST",data:a}).done(function(o,i,a){RED.settings.set("auth-tokens",o),$("#node-dialog-login").dialog("destroy").remove(),t.updateMenu&&e(),n()}).fail(function(e,t,n){RED.settings.remove("auth-tokens"),$("#node-dialog-login-failed").show()}).always(function(){$("#node-dialog-login-submit").button("option","disabled",!1),$(".login-spinner").hide()}),o.preventDefault()})}else if("strategy"==i.type)for(a=0;a<i.prompts.length;a++){s=i.prompts[a],r=$("<div/>",{class:"form-row",style:"text-align: center"}).appendTo("#node-dialog-login-fields");var l=$('<a href="#"></a>',{style:"padding: 10px"}).appendTo(r).click(function(){document.location=s.url});if(s.image)$("<img>",{src:s.image}).appendTo(l);else if(s.label){var c=$("<span></span>").text(s.label);s.icon&&($("<i></i>",{class:"fa fa-2x "+s.icon,style:"vertical-align: middle"}).appendTo(l),c.css({verticalAlign:"middle",marginLeft:"8px"})),c.appendTo(l)}l.button()}t.cancelable&&$("#node-dialog-login-cancel").button().click(function(e){$("#node-dialog-login").dialog("destroy").remove()});var p=i.image||"red/images/node-red-256.png";$("#node-dialog-login-image").load(function(){o.dialog("open")}).attr("src",p)}})},logout:function(){var e=RED.settings.get("auth-tokens"),t=e?e.access_token:"";$.ajax({url:"auth/revoke",type:"POST",data:{token:t}}).done(function(e,t,n){RED.settings.remove("auth-tokens"),e&&e.redirect?document.location.href=e.redirect:document.location.reload(!0)}).fail(function(e,t,n){401===e.status?document.location.reload(!0):console.log(t)})}}}(),RED.comms=function(){var e,t=null,n=null,o=null,i=10,a={},s=!1,r=0,d=!1;return{connect:function l(){d=!0;var c=location.hostname,p=location.port;0!==p.length&&(c=c+":"+p),c=(c+=document.location.pathname)+("/"==c.slice(-1)?"":"/")+"comms",c="ws"+("https:"==document.location.protocol?"s":"")+"://"+c;var u=RED.settings.get("auth-tokens");function f(){for(var t in a)a.hasOwnProperty(t)&&e.send(JSON.stringify({subscribe:t}))}s=null!=u,(e=new WebSocket(c)).onopen=function(){r=0,t&&(n=setTimeout(function(){t.close(),t=null},1e3)),s?e.send(JSON.stringify({auth:u.access_token})):f()},e.onmessage=function(e){var t=JSON.parse(e.data);if(s&&t.auth)"ok"===t.auth?(s=!1,f()):"fail"===t.auth&&(d=!1,RED.user.login({updateMenu:!0},function(){l()}));else if(t.topic)for(var n in a)if(a.hasOwnProperty(n)&&new RegExp("^"+n.replace(/([\[\]\?\(\)\\\\$\^\*\.|])/g,"\\$1").replace(/\+/g,"[^/]+").replace(/\/#$/,"(/.*)?")+"$").test(t.topic)){var o=a[n];if(o)for(var i=0;i<o.length;i++)o[i](t.topic,t.data)}},e.onclose=function(){d&&(n&&(clearTimeout(n),n=null),++r<10?(setTimeout(l,1e3),r>5&&null==t&&(t=RED.notify(RED._("notification.errors.lostConnection"),"error",!0))):r<20?setTimeout(l,2e3):(i=60,o=setInterval(function(){if(0==--i)t.update(RED._("notification.errors.lostConnection")),clearInterval(o),l();else{var e=RED._("notification.errors.lostConnectionReconnect",{time:i})+' <a href="#">'+RED._("notification.errors.lostConnectionTry")+"</a>";t.update(e),$(t).find("a").click(function(e){e.preventDefault(),t.update(RED._("notification.errors.lostConnection")),clearInterval(o),l()})}},1e3)))}},subscribe:function(t,n){null==a[t]&&(a[t]=[]),a[t].push(n),e&&1==e.readyState&&e.send(JSON.stringify({subscribe:t}))},unsubscribe:function(e,t){if(a[e]){for(var n=0;n<a[e].length;n++)if(a[e][n]===t){a[e].splice(n,1);break}0===a[e].length&&delete a[e]}}}}(),RED.text={},RED.text.bidi=function(){var e="",t="‪",n="‫",o="‬";function i(t){return"auto"==e?function(e){for(var t,n,o=e.length,i=0;i<o;i++){if((n=e.charCodeAt(i))>=1488&&n<=1535||n>=1536&&n<=1631||n>=1642&&n<=1775||n>=1786&&n<=2047||n>=64285&&n<=65023||n>=65136&&n<=65276)return!0;if((t=e.charCodeAt(i))>64&&t<91||t>96&&t<123)return!1}return!1}(t)?"rtl":"ltr":e}function a(){$(this).attr("dir",i($(this).val()))}return{setTextDirection:function(t){e=t,RED.nodes.eachNode(function(e){e.dirty=!0}),RED.view.redraw(),RED.palette.refresh(),$("#workspace").find("span.bidiAware").each(function(){$(this).attr("dir",i($(this).html()))}),$("#sidebar").find("span.bidiAware").each(function(){$(this).attr("dir",i($(this).text()))})},enforceTextDirectionWithUCC:function(e){if(e){var a=i(e);if("ltr"==a)return t+e+o;if("rtl"==a)return n+e+o}return e},resolveBaseTextDir:i,prepareInput:function(e){e.on("keyup",a).on("paste",a).on("cut",a),a.call(e)}}}(),RED.text.format=function(){var e=function(e){this.content="",this.actual="",this.textDirection="",this.localGui="",this.isVisible=!0,this.isSeparator=!1,this.isParsed=!1,this.keep=!1,this.inBounds=!1,this.inPoints=!1;var t="";for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t])},t=function(){function t(e){if(!e)return!1;void 0===e.start&&(e.start=""),void 0===e.end&&(e.end=""),void 0!==e.startAfter?(e.start=e.startAfter,e.after=!0):e.after=!1,void 0!==e.endBefore?(e.end=e.endBefore,e.before=!0):e.before=!1;var t=parseInt(e.startPos,10);isNaN(t)?e.usePos=!1:e.usePos=!0;var n=parseInt(e.length,10);return isNaN(n)?e.useLength=!1:e.useLength=!0,e.loops=void 0===e.loops||!!e.loops,!0}function n(e,t){var n={};for(var o in t)t.hasOwnProperty(o)&&(n[o]=t[o]);var i=e.content,a=n.usePos&&n.startPos<i.length;a&&(n.start="",n.loops=!1),n.bStart=a?n.startPos:n.start.length>0?i.indexOf(n.start):0;var s=n.useLength&&n.length>0&&n.bStart+n.length<i.length;return s&&(n.end=""),n.bEnd=s?n.bStart+n.length:n.end.length>0?i.indexOf(n.end,n.bStart+n.start.length)+1:i.length,n.after||(n.start=""),n.before||(n.end=""),n}return{handleSubcontents:function(t,n,o,i,a){if(!o.content||"string"!=typeof o.content||0===o.content.length)return t;var s=!0;void 0!==o.loops&&(s=!!o.loops);for(var r=0;!(r>=t.length);r++)if(!(t[r].isParsed||t.keep||t[r].isSeparator)){var d=t[r].content,l=d.indexOf(o.content);if(!(l<0)){var c,p=0;if(o.continued)do{p++,c=d.indexOf(o.content,l+p*o.content.length)}while(0===c);else p=1;if(c=l+p*o.content.length,t.splice(r,1),l>0&&(t.splice(r,0,new e({content:d.substring(0,l),localGui:n.dir,keep:!0})),r++),t.splice(r,0,new e({content:d.substring(l,c),textDirection:o.subDir,localGui:n.dir})),c<d.length&&t.splice(r+1,0,new e({content:d.substring(c,d.length),localGui:n.dir,keep:!0})),!s)break}}},handleBounds:function(o,i,a,s,r){for(var d=0;d<a.length;d++)if(t(a[d]))for(var l=0;!(l>=o.length);l++)if(!(o[l].isParsed||o[l].inBounds||o.keep||o[l].isSeparator)){var c=n(o[l],a[d]),p=c.bStart,u=c.bEnd;if(!(p<0||u<0)){var f=o[l].content;if(o.splice(l,1),p>0&&(o.splice(l,0,new e({content:f.substring(0,p),localGui:i.dir,keep:!0})),l++),c.start&&(o.splice(l,0,new e({content:c.start,localGui:i.dir,isSeparator:!0})),l++),o.splice(l,0,new e({content:f.substring(p+c.start.length,u-c.end.length),textDirection:c.subDir,localGui:i.dir,inBounds:!0})),c.end&&(l++,o.splice(l,0,new e({content:c.end,localGui:i.dir,isSeparator:!0}))),u+c.end.length<f.length&&o.splice(l+1,0,new e({content:f.substring(u+c.end.length,f.length),localGui:i.dir,keep:!0})),!c.loops)break}}for(d=0;d<o.length;d++)o[d].inBounds=!1;return o},handleCases:function(e,t,n,o,i){if(0===n.length)return e;var a={};for(var s in t)t.hasOwnProperty(s)&&(a[s]=t[s]);for(var r=0;r<n.length;r++)n[r].handler&&"function"==typeof n[r].handler.handle||(n[r].handler=t.commonHandler),n[r].args?(a.cases=n[r].args.cases,a.points=n[r].args.points,a.bounds=n[r].args.bounds,a.subs=n[r].args.subs):(a.cases=[],a.points=[],a.bounds=[],a.subs={}),n[r].handler.handle(o,e,a,i);return e},handlePoints:function(t,n,o,i,a){for(var s=0;s<o.length;s++)for(var r=0;!(r>=t.length);r++)if(!(t[r].isParsed||t[r].keep||t[r].isSeparator)){var d=t[r].content,l=d.indexOf(o[s]);l>=0&&(t.splice(r,1),l>0&&(t.splice(r,0,new e({content:d.substring(0,l),textDirection:n.subDir,localGui:n.dir,inPoints:!0})),r++),t.splice(r,0,new e({content:o[s],localGui:n.dir,isSeparator:!0})),l+o[s].length+1<=d.length&&t.splice(r+1,0,new e({content:d.substring(l+o[s].length),textDirection:n.subDir,localGui:n.dir,inPoints:!0})))}for(s=0;s<t.length;s++)t[s].keep?t[s].keep=!1:t[s].inPoints&&(t[s].isParsed=!0,t[s].inPoints=!1);return t}}}(),n={handle:function(e,n,o,i){var a=[];Array.isArray(o.cases)&&(a=o.cases);var s=[];void 0!==o.points&&(Array.isArray(o.points)?s=o.points:"string"==typeof o.points&&(s=o.points.split("")));var r={};"object"==typeof o.subs&&(r=o.subs);var d=[];return Array.isArray(o.bounds)&&(d=o.bounds),t.handleBounds(n,o,d,e,i),t.handleSubcontents(n,o,r,e,i),t.handleCases(n,o,a,e,i),t.handlePoints(n,o,s,e,i),n}},o={LRE:"‪",RLE:"‫",PDF:"‬",LRM:"‎",RLM:"‏",LRO:"‭",RLO:"‮",getLocaleDetails:function(e){if(e||(e="undefined"==typeof navigator?"":navigator.language||navigator.userLanguage||""),e=e.toLowerCase(),(o=(n=e)?n.split("-")[0]:"")&&!(o.length<2)&&["iw","he","ar","fa","ur"].some(function(e){return e===o})){var t=e.split("-");return{lang:t[0],country:t[1]?t[1]:""}}var n,o;return{lang:"not-bidi"}},removeUcc:function(e){return e?e.replace(/[\u200E\u200F\u202A-\u202E]/g,""):e},removeTags:function(e){return e?e.replace(/<[^<]*>/g,""):e},getDirection:function(e,t,n,o){if("auto"!==t&&/^(rtl|ltr)$/i.test(t))return t;n=/^(rtl|ltr)$/i.test(n)?n:"ltr";var i=o?e.split("").reverse().join(""):e,a=/[A-Za-z\u05d0-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(i);return a?a[0]<="z"?"ltr":"rtl":n},hasArabicChar:function(e){return!!/[\u0600-\u065f\u066a-\u06ef\u06fa-\u07ff\ufb1d-\ufdff\ufe70-\ufefc]/.exec(e)},showMarks:function(e,t){for(var n="",o=0;o<e.length;o++){var i=""+e.charAt(o);switch(i){case"‎":n+="<LRM>";break;case"‏":n+="<RLM>";break;case"‪":n+="<LRE>";break;case"‫":n+="<RLE>";break;case"‭":n+="<LRO>";break;case"‮":n+="<RLO>";break;case"‬":n+="<PDF>";break;default:n+=i}}var a=void 0!==t&&/^(rtl|ltr)$/i.test(t)?"rtl"===t?"‮":"‭":"";return a+n+(""===a?"":"‬")},hideMarks:function(e){return e.replace(/<LRM>/g,this.LRM).replace(/<RLM>/g,this.RLM).replace(/<LRE>/g,this.LRE).replace(/<RLE>/g,this.RLE).replace(/<LRO>/g,this.LRO).replace(/<RLO>/g,this.RLO).replace(/<PDF>/g,this.PDF)},showTags:function(e){return"<xmp>"+e+"</xmp>"},hideTags:function(e){return e.replace(/<xmp>/g,"").replace(/<\/xmp>/g,"")}},i=function(){var t={};function i(e,t){var o=Array.isArray(e)?e[0]:e;return o.guiDir||(o.guiDir="ltr"),o.dir||(o.dir=o.guiDir),t?(void 0===o.points&&(o.points=[]),o.cases||(o.cases=[]),o.bounds||(o.bounds=[]),o.commonHandler=n,o):o}function a(t,o,a){if(!t||!o)return new e({content:""});var s=i(o,!0),r=[new e({content:t,actual:t,localGui:s.dir})],d=n.handle;return s.handler&&"function"==typeof s.handler&&(d=s.handler.handle),d(t,r,s,a),r}function s(e,t,n){var a=i(t,!1);return n?function(e,t,n){for(var i="",a="",s=0;s<e.length;s++)if(e[s].isVisible){var r=e[s].textDirection,d=e[s].localGui;if(""!==d&&""===a?i+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>":""===a||""!==d&&d===a&&!stop||(i+="</bdi>"+(s==e.length-1&&""!==d?"":"<span style='unicode-bidi: embed; direction: "+("rtl"===t.dir?"rtl":"ltr")+";'></span>"),""!==d&&(i+="<bdi dir='"+("rtl"===d?"rtl":"ltr")+"'>")),"auto"===r&&(r=o.getDirection(e[s].content,r,t.guiDir)),/^(rtl|ltr)$/i.test(r)?(i+="<bdi dir='"+("rtl"===r?"rtl":"ltr")+"'>"+e[s].content+"</bdi>",r):(i+=e[s].content,o.getDirection(e[s].content,r,t.guiDir,!0)),s<e.length-1){var l=d&&e[s+1].localGui?d:t.dir;i+="<span style='unicode-bidi: embed; direction: "+("rtl"===l?"rtl":"ltr")+";'></span>"}else""!==a&&(i+="</bdi>");a=d,stop=!1}else stop=!0;var c="auto"===t.dir?o.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;c!==t.guiDir&&(i="<bdi dir='"+("rtl"===c?"rtl":"ltr")+"'>"+i+"</bdi>");return i}(e,a):function(e,t,n){for(var i="",a="",s=!1,r=0;r<e.length;r++)if(e[r].isVisible){var d=e[r].textDirection,l=e[r].localGui;if(""!==l&&""===a?i+="rtl"===l?o.RLE:o.LRE:""===a||""!==l&&l===a&&!s||(i+=o.PDF+(r==e.length-1&&""!==l?"":"rtl"===t.dir?o.RLM:o.LRM),""!==l&&(i+="rtl"===l?o.RLE:o.LRE)),"auto"===d&&(d=o.getDirection(e[r].content,d,t.guiDir)),/^(rtl|ltr)$/i.test(d)?(i+=("rtl"===d?o.RLE:o.LRE)+e[r].content+o.PDF,d):(i+=e[r].content,o.getDirection(e[r].content,d,t.guiDir,!0)),r<e.length-1){var c=l&&e[r+1].localGui?l:t.dir;i+="rtl"===c?o.RLM:o.LRM}else""!==a&&(i+=o.PDF);a=l,s=!1}else s=!0;var p="auto"===t.dir?o.getDirection(e[0].actual,t.dir,t.guiDir):t.dir;p!==t.guiDir&&(i=("rtl"===p?o.RLE:o.LRE)+i+o.PDF);return i}(e,a)}return t.parseAndDisplayStructure=function(e,t,n,o){return e&&t?s(a(e,t,o),t,n):e},t.parseStructure=a,t.displayStructure=s,t.restore=function(e,t){return e},t}(),a={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",subs:{content:">",continued:!0,subDir:n?"rtl":"ltr"},cases:[{args:{subs:{content:"<",continued:!0,subDir:n?"ltr":"rtl"}}}]};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},s={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:","};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},r=function(){return{format:function(e,t,a,s,r,d){var l={guiDir:a?"rtl":"ltr",dir:function(e,t){if("ar"!==o.getLocaleDetails(t).lang)return"ltr";var n=e.indexOf("@");return n>0&&n<e.length-1&&o.hasArabicChar(e.substring(n+1))?"rtl":"ltr"}(e,r),points:"<>.:,;@",cases:[{handler:n,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"(",endBefore:")"}],points:""}}]};return d?i.parseStructure(e,l,!!s,r):i.parseAndDisplayStructure(e,l,!!s,r)}}}(),d={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"/\\:."};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},l={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:" /%^&[]<>=!?~:.,|()+-*{}"};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},c={format:function(e,t,o,a,s,r){var d={guiDir:o?"rtl":"ltr",dir:"ltr",points:"\t!#%&()*+,-./:;<=>?|[]{}",cases:[{handler:n,args:{bounds:[{startAfter:"/*",endBefore:"*/"},{startAfter:"--",end:"\n"},{startAfter:"--"}]}},{handler:n,args:{subs:{content:" ",continued:!0}}},{handler:n,args:{bounds:[{startAfter:"'",endBefore:"'"},{startAfter:'"',endBefore:'"'}]}}]};return r?i.parseStructure(e,d,!!a,s):i.parseAndDisplayStructure(e,d,!!a,s)}},p={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:"_"};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},u={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:"ltr",points:":?#/@.[]="};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},f={format:function(e,t,n,o,a,s){var r={guiDir:n?"rtl":"ltr",dir:t.dir?t.dir:n?"rtl":"ltr",points:" ,.!?;:"};return s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},h={format:function(e,t,o,a,s,r){var d={guiDir:o?"rtl":"ltr",dir:"ltr",points:" /[]<>=!:@.|()+-*",cases:[{handler:n,args:{bounds:[{startAfter:'"',endBefore:'"'},{startAfter:"'",endBefore:"'"}],points:""}}]};return r?i.parseStructure(e,d,!!a,s):i.parseAndDisplayStructure(e,d,!!a,s)}},g={format:function(e,t,n,o,a,s){var r={},d="",l=Array.isArray(t)?t[0]:t;for(d in l)l.hasOwnProperty(d)&&(r[d]=l[d]);return r.guiDir=n?"rtl":"ltr",r.dir=r.dir?r.dir:r.guiDir,s?i.parseStructure(e,r,!!o,a):i.parseAndDisplayStructure(e,r,!!o,a)}},v=(function(){var e={msgLang:"en",msgDir:"",phLang:"",phDir:"",phPacking:["{","}"],phStt:{type:"none",args:{}},guiDir:""},t=!1;function n(e){return"he"===e||"iw"===e||"ar"===e?"rtl":"ltr"}function o(e){0===e.msgDir.length&&(e.msgDir=n(e.msgLang)),e.msgDir="ltr"!==e.msgDir&&"rtl"!==e.msgDir&&"auto"!=e.msgDir?"ltr":e.msgDir,0===e.guiDir.length&&(e.guiDir=e.msgDir),e.guiDir="rtl"!==e.guiDir?"ltr":"rtl",0===e.phDir.length&&(e.phDir=0===e.phLang.length?e.msgDir:n(e.phLang)),e.phDir="ltr"!==e.phDir&&"rtl"!==e.phDir&&"auto"!=e.phDir?"ltr":e.phDir,"string"==typeof e.phPacking&&(e.phPacking=e.phPacking.split("")),e.phPacking.length<2&&(e.phPacking=["{","}"])}}(),null);function m(e){switch(e){case"breadcrumb":return a;case"comma":return s;case"email":return r;case"filepath":return d;case"formula":return l;case"sql":return c;case"underscore":return p;case"url":return u;case"word":return f;case"xpath":return h;default:return g}}function b(e,t,n,i,a){if(!e||1!=e.nodeType)return!1;v||(v=document.createEvent("Event")).initEvent("TF",!0,!0),e.setAttribute("data-tf-type",t);var s="undefined"===n?"{}":JSON.stringify(Array.isArray(n)?n[0]:n);e.setAttribute("data-tf-args",s);var r="ltr";if("undefined"===i&&(e.dir?r=e.dir:e.style&&e.style.direction&&(r=e.style.direction),i="rtl"===r.toLowerCase()),e.setAttribute("data-tf-dir",i),e.setAttribute("data-tf-locale",o.getLocaleDetails(a).lang),function(e){var t=window.navigator.userAgent;if(t.indexOf("MSIE")>=0||t.indexOf("Trident")>=0||t.indexOf("Edge")>=0)return!1;var n=document.createElement(e.tagName);n.contentEditable=!0;var o="oninput"in n;return o||(n.setAttribute("oninput","return;"),o="function"==typeof n.oninput),n=null,o}(e)){e.oninput;e.oninput=function(e){y(e.target)}}else e.onkeyup=function(t){y(t.target),e.dispatchEvent(v)},e.onmouseup=function(t){y(t.target),e.dispatchEvent(v)};return y(e),!0}function y(e){var t=e.textContent||"",n=document.getSelection();if(0===t.length||!n||n.rangeCount<=0)e.dispatchEvent(v);else{var o,i,a=n.getRangeAt(0),s=a.cloneRange();o=a.startContainer,i=a.startOffset;var r=0;3===o.nodeType&&(r+=i),s.setStart(e,0),s.setEndBefore(o);var d=document.createElement("div");d.appendChild(s.cloneContents()),r+=d.textContent.length,e.innerHTML=m(e.getAttribute("data-tf-type")).format(t,JSON.parse(e.getAttribute("data-tf-args")),"true"===e.getAttribute("data-tf-dir"),!0,e.getAttribute("data-tf-locale"));var l=e,c=e,p=0,u=!1;for(n.removeAllRanges(),a.setStart(e,0),a.setEnd(e,0);c;){if(3===c.nodeType){if(p+c.nodeValue.length>=r){a.setStart(c,r-p);break}p+=c.nodeValue.length,c=c.nextSibling}else{if(c.hasChildNodes()){c=(l=c).firstChild;continue}c=c.nextSibling}for(;!c;){if(l===e){u=!0;break}c=l.nextSibling,l=l.parentNode}if(u)break}n.addRange(a),e.dispatchEvent(v)}}return{getHtml:function(e,t,n,o,i){return m(t).format(e,n,o,!0,i)},attach:function(e,t,n,o,i){return b(e,t,n,o,i)}}}(),RED.state={DEFAULT:0,MOVING:1,JOINING:2,MOVING_ACTIVE:3,ADDING:4,EDITING:5,EXPORT:6,IMPORT:7,IMPORT_DRAGGING:8,QUICK_JOINING:9},RED.nodes=function(){var e,t,o=[],a={},s=[],r={},d=[],l={},c=null,p=!1;var u,f,h,g,v,m,b=(u={},f=[],h={},g={},v={tab:{defaults:{label:{value:""},disabled:{value:!1},info:{value:""}}}},m={setModulePendingUpdated:function(e,t){u[e].pending_version=t,RED.events.emit("registry:module-updated",{module:e,version:t})},getModule:function(e){return u[e]},getNodeSetForType:function(e){return m.getNodeSet(g[e])},getModuleList:function(){return u},getNodeList:function(){return f},getNodeTypes:function(){return Object.keys(v)},setNodeList:function(e){f=[];for(var t=0;t<e.length;t++){var n=e[t];m.addNodeSet(n)}},addNodeSet:function(e){e.added=!1,h[e.id]=e;for(var t=0;t<e.types.length;t++)g[e.types[t]]=e.id;f.push(e),u[e.module]=u[e.module]||{name:e.module,version:e.version,local:e.local,sets:{}},e.pending_version&&(u[e.module].pending_version=e.pending_version),u[e.module].sets[e.name]=e,RED.events.emit("registry:node-set-added",e)},removeNodeSet:function(e){for(var t=h[e],n=0;n<t.types.length;n++)delete g[t.types[n]];delete h[e];for(var o=0;o<f.length;o++)if(f[o].id===e){f.splice(o,1);break}return delete u[t.module].sets[t.name],0===Object.keys(u[t.module].sets).length&&delete u[t.module],RED.events.emit("registry:node-set-removed",t),t},getNodeSet:function(e){return h[e]},enableNodeSet:function(e){var t=h[e];t.enabled=!0,RED.events.emit("registry:node-set-enabled",t)},disableNodeSet:function(e){var t=h[e];t.enabled=!1,RED.events.emit("registry:node-set-disabled",t)},registerNodeType:function(e,t){var n;(v[e]=t,t.type=e,"subflows"!=t.category)&&(t.set=h[g[e]],h[g[e]].added=!0,h[g[e]].enabled=!0,n="node-red"===t.set.module?"node-red":t.set.id,t._=function(){var e=Array.prototype.slice.call(arguments,0),t=e[0];-1===e[0].indexOf(":")&&(e[0]=n+":"+e[0]);var o=RED._.apply(null,e);return o===e[0]&&(o=t),o});RED.events.emit("registry:node-type-added",e)},removeNodeType:function(e){if("subflow:"!=e.substring(0,8))throw new Error("this api is subflow only. called with:",e);delete v[e],RED.events.emit("registry:node-type-removed",e)},getNodeType:function(e){return v[e]}});function y(){return(1+4294967295*Math.random()).toString(16)}function w(e){if(0!==e.type.indexOf("subflow")?e._=e._def._:e._=RED._,"config"==e._def.category)a[e.id]=e;else{if(e.ports=[],e.wires&&e.wires.length>e.outputs&&(e.outputs=e.wires.length),e.outputs)for(var t=0;t<e.outputs;t++)e.ports.push(t);if(e.dirty=!0,z(e),"subflows"==e._def.category&&void 0===e.i){var n=0;RED.nodes.eachNode(function(e){n=Math.max(n,e.i||0)}),e.i=n+1}o.push(e)}RED.events.emit("nodes:add",e)}function D(e){s.push(e)}function E(e){if(e in a)return a[e];for(var t in o)if(o[t].id==e)return o[t];return null}function R(e){var t,i=[],r=[];if(e in a)t=a[e],delete a[e],RED.events.emit("nodes:remove",t),RED.workspaces.refresh();else if(t=E(e)){o.splice(o.indexOf(t),1),(i=s.filter(function(e){return e.source===t||e.target===t})).forEach(function(e){s.splice(s.indexOf(e),1)});var d=!1;for(var l in t._def.defaults)if(t._def.defaults.hasOwnProperty(l)){var c=t._def.defaults[l];if(c.type){var p=b.getNodeType(c.type);if(p&&"config"==p.category){var u=a[t[l]];if(u)if(d=!0,u._def.exclusive)R(t[l]),r.push(u);else{var f=u.users;f.splice(f.indexOf(t),1)}}}}d&&RED.workspaces.refresh(),RED.events.emit("nodes:remove",t)}return t&&t._def.onremove&&t._def.onremove.call(n),{links:i,nodes:r}}function k(e){r[e.id]=e,e._def=RED.nodes.getType("tab"),d.push(e.id)}function x(e,t){if(t){var n=Object.keys(l).map(function(e){return l[e].name});n.sort();var o=1,i=e.name;n.forEach(function(t){i==t&&(o++,i=e.name+" ("+o+")")}),e.name=i}l[e.id]=e,RED.nodes.registerType("subflow:"+e.id,{defaults:{name:{value:""}},info:e.info,icon:"subflow.png",category:"subflows",inputs:e.in.length,outputs:e.out.length,color:"#da9",label:function(){return this.name||RED.nodes.subflow(e.id).name},labelStyle:function(){return this.name?"node_label_italic":""},paletteLabel:function(){return RED.nodes.subflow(e.id).name},inputLabels:function(t){return e.inputLabels?e.inputLabels[t]:null},outputLabels:function(t){return e.outputLabels?e.outputLabels[t]:null},set:{module:"node-red"}}),e._def=RED.nodes.getType("subflow:"+e.id)}function _(e){return l[e]}function T(e,t){for(var n=0;n<o.length;n++){var i=o[n];if(i.z===e){var a=/^subflow:(.+)$/.exec(i.type);if(a){if(a[1]===t)return!0;if(T(a[1],t))return!0}}}return!1}function C(e){var t={};t.id=e.id,t.type=e.type;for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&(t[n]=e[n]);return t}function O(e,t){if("tab"===e.type)return C(e);t=t||!1;var n={};if(n.id=e.id,n.type=e.type,n.z=e.z,"unknown"==n.type)for(var o in e._orig)e._orig.hasOwnProperty(o)&&(n[o]=e._orig[o]);else{for(var i in e._def.defaults)e._def.defaults.hasOwnProperty(i)&&(n[i]=e[i]);if(t&&e.credentials){var a={};n.credentials={};for(var r in e._def.credentials)e._def.credentials.hasOwnProperty(r)&&("password"==e._def.credentials[r].type?(!e.credentials._||e.credentials["has_"+r]!=e.credentials._["has_"+r]||e.credentials["has_"+r]&&e.credentials[r])&&(a[r]=e.credentials[r]):null==e.credentials[r]||e.credentials._&&e.credentials[r]==e.credentials._[r]||(a[r]=e.credentials[r]));Object.keys(a).length>0&&(n.credentials=a)}}if("config"!=e._def.category){n.x=e.x,n.y=e.y,n.wires=[];for(var d=0;d<e.outputs;d++)n.wires.push([]);for(var l=s.filter(function(t){return t.source===e}),c=0;c<l.length;c++){var p=l[c];"subflow"!=p.target.type&&n.wires[p.sourcePort].push(p.target.id)}e.inputs>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(n.inputLabels=e.inputLabels.slice()),e.outputs>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(n.outputLabels=e.outputLabels.slice())}return n}function S(e){var t={};return t.id=e.id,t.type=e.type,t.name=e.name,t.info=e.info,t.in=[],t.out=[],e.in.forEach(function(e){for(var n={x:e.x,y:e.y,wires:[]},o=s.filter(function(t){return t.source===e}),i=0;i<o.length;i++){var a=o[i];"subflow"!=a.target.type&&n.wires.push({id:a.target.id})}t.in.push(n)}),e.out.forEach(function(n,o){var a={x:n.x,y:n.y,wires:[]},r=s.filter(function(e){return e.target===n});for(i=0;i<r.length;i++)"subflow"!=r[i].source.type?a.wires.push({id:r[i].source.id,port:r[i].sourcePort}):a.wires.push({id:e.id,port:0});t.out.push(a)}),t.in.length>0&&e.inputLabels&&!/^\s*$/.test(e.inputLabels.join(""))&&(t.inputLabels=e.inputLabels.slice()),t.out.length>0&&e.outputLabels&&!/^\s*$/.test(e.outputLabels.join(""))&&(t.outputLabels=e.outputLabels.slice()),t}function L(e,t,n){var o=[];n=n||{},t=t||{};for(var i=0;i<e.length;i++){var s=e[i];if("subflow:"==s.type.substring(0,8)){var r=s.type.substring(8);if(!t[r]){t[r]=!0;var d=[_(r)];RED.nodes.eachNode(function(e){e.z==r&&d.push(e)}),o=L(d,t,n).concat(o)}}if("subflow"!=s.type){var l=RED.nodes.convertNode(s);for(var c in s._def.defaults)if(s._def.defaults[c].type&&s[c]in a){var p=a[s[c]],u=b.getNodeType(s._def.defaults[c].type).exportable;null==u||u?s[c]in n||(n[s[c]]=!0,e.push(p)):l[c]=""}o.push(l)}else{var f=S(s);o.push(f)}}return o}function N(e,t){var n,o=null;try{RED.nodes.eachSubflow(function(i){if(i.name==e.name&&i.info==e.info&&i.in.length==e.in.length&&i.out.length==e.out.length){var a=RED.nodes.filterNodes({z:i.id});if(a.length==t.length){var s=[e].concat(t),r=[i].concat(a),d=JSON.stringify(s),l=JSON.stringify(L(r));for(n=0;n<a.length;n++)d=d.replace(new RegExp('"'+t[n].id+'"',"g"),'"'+a[n].id+'"');if((d=d.replace(new RegExp('"'+e.id+'"',"g"),'"'+i.id+'"'))===l)throw o=i,new Error}}})}catch(e){console.log(e.stack)}return o}function P(e,t,n){if(n&&e.id!=t.id)return!1;if(e.type!=t.type)return!1;var o=e._def;for(var i in o.defaults)if(o.defaults.hasOwnProperty(i)){var a=e[i],s=t[i];if(typeof a!=typeof s)return!1;if(null===a||"string"==typeof a||"number"==typeof a){if(a!==s)return!1}else if(JSON.stringify(a)!==JSON.stringify(s))return!1}return!0}function I(n,o,i){var s,d,l,c={};if("string"==typeof n){if(""===n)return;try{l=JSON.parse(n)}catch(m){var p=new Error(RED._("clipboard.invalidFlow",{message:m.message}));throw p.code="NODE_RED",p}}else l=n;$.isArray(l)||(l=[l]),t||(t=JSON.parse(JSON.stringify(l)));var u=[];for(s=0;s<l.length;s++)"workspace"==(d=l[s]).type||"tab"==d.type||"subflow"==d.type||b.getNodeType(d.type)||"subflow:"==d.type.substring(0,8)||-1!=u.indexOf(d.type)||u.push(d.type),d.z&&(c[d.z]=c[d.z]||[],c[d.z].push(d));if(u.length>0){var f="<ul><li>"+u.join("</li><li>")+"</li></ul>";u.length;RED.notify("<strong>"+RED._("clipboard.importUnrecognised",{count:u.length})+"</strong>"+f,"error",!1,1e4)}var h=RED.workspaces.active(),g=_(h);for(s=0;s<l.length;s++){var v=/^subflow:(.+)$/.exec(l[s].type);if(v){var m,E=v[1],R=_(l[s].z||h);if(R)if(E===R.id&&(m=new Error(RED._("notification.errors.cannotAddSubflowToItself"))),T(E,R.id)&&(m=new Error(RED._("notification.errors.cannotAddCircularReference"))),m)throw m.code="NODE_RED",m}}var C,O,S,L,I=[],z={},A=[],M={},j={},B={},J=[],G=[],V=null;for(s=0;s<l.length;s++)if("workspace"===(d=l[s]).type||"tab"===d.type)"workspace"===d.type&&(d.type="tab"),null==e&&(e=d),o&&(C=y(),z[d.id]=C,d.id=C),k(d),RED.workspaces.add(d),I.push(d);else if("subflow"===d.type){var F=N(d,c[d.id]);F?j[d.id]=F:(M[d.id]=d,o&&(C=y(),d.id=C),d.in.forEach(function(e,t){e.type="subflow",e.direction="in",e.z=d.id,e.i=t,e.id=y()}),d.out.forEach(function(e,t){e.type="subflow",e.direction="out",e.z=d.id,e.i=t,e.id=y()}),A.push(d),x(d,o))}for(null==e&&(k(e={type:"tab",id:y(),disabled:!1,info:"",label:RED._("workspace.defaultName",{number:1})}),RED.workspaces.add(e),I.push(e),h=RED.workspaces.active()),s=0;s<l.length;s++)if(d=l[s],(O=b.getNodeType(d.type))&&"config"==O.category){var W=null;if(o){if(d.z){if(j[d.z])continue;M[d.z]?d.z=M[d.z].id:(d.z=z[d.z],r[d.z]||(i?(null===V&&(V=RED.workspaces.add(null,!0),I.push(V)),d.z=V.id):d.z=h))}if((W=RED.nodes.node(d.id))&&d.z&&W.z!==d.z){W=null;for(var U in a)if(a.hasOwnProperty(U)&&a[U].z===d.z&&P(a[U],d,!1)){W=a[U],B[d.id]=a[U];break}}}if(!W){S={id:d.id,z:d.z,type:d.type,users:[],_config:{}};for(L in O.defaults)O.defaults.hasOwnProperty(L)&&(S[L]=d[L],S._config[L]=JSON.stringify(d[L]));if(O.hasOwnProperty("credentials")&&d.hasOwnProperty("credentials")){S.credentials={};for(L in O.credentials)O.credentials.hasOwnProperty(L)&&d.credentials.hasOwnProperty(L)&&(S.credentials[L]=d.credentials[L])}S.label=O.label,S._def=O,o&&(S.id=y()),B[d.id]=S,J.push(S),RED.nodes.add(S)}}for(s=0;s<l.length;s++)if("workspace"!==(d=l[s]).type&&"tab"!==d.type&&"subflow"!==d.type&&(!(O=b.getNodeType(d.type))||"config"!=O.category)){var q={x:d.x,y:d.y,z:d.z,type:0,wires:d.wires,inputLabels:d.inputLabels,outputLabels:d.outputLabels,changed:!1,_config:{}};if(o){if(j[d.z])continue;M[q.z]?q.z=M[q.z].id:(q.z=z[q.z],r[q.z]||(i?(null===V&&(V=RED.workspaces.add(null,!0),I.push(V)),q.z=V.id):q.z=h)),q.id=y()}else q.id=d.id,null!=q.z&&(r[q.z]||M[q.z])||(i?(null===V&&(V=RED.workspaces.add(null,!0),I.push(V)),q.z=V.id):q.z=h);if(q.type=d.type,q._def=O,"subflow"===d.type.substring(0,7)){var K=d.type.split(":")[1],H=j[K]||M[K]||_(K);o&&(K=H.id,q.type="subflow:"+K,q._def=b.getNodeType(q.type),delete q.i),q.name=d.name,q.outputs=H.out.length,q.inputs=H.in.length}else{if(!q._def){q.x&&q.y?q._def={color:"#fee",defaults:{},label:"unknown: "+d.type,labelStyle:"node_label_italic",outputs:d.outputs||d.wires.length,set:b.getNodeSet("node-red/unknown")}:(q._def={category:"config",set:b.getNodeSet("node-red/unknown")},q.users=[]);var X={};for(var Y in d)d.hasOwnProperty(Y)&&"x"!=Y&&"y"!=Y&&"z"!=Y&&"id"!=Y&&"wires"!=Y&&(X[Y]=d[Y]);q._orig=X,q.name=d.type,q.type="unknown"}if("config"!=q._def.category){q.inputs=d.inputs||q._def.inputs,q.outputs=d.outputs||q._def.outputs;for(L in q._def.defaults)q._def.defaults.hasOwnProperty(L)&&(q[L]=d[L],q._config[L]=JSON.stringify(d[L]));if(q._config.x=q.x,q._config.y=q.y,q._def.hasOwnProperty("credentials")&&d.hasOwnProperty("credentials")){q.credentials={};for(L in q._def.credentials)q._def.credentials.hasOwnProperty(L)&&d.credentials.hasOwnProperty(L)&&(q.credentials[L]=d.credentials[L])}}}w(q),RED.editor.validateNode(q),B[d.id]=q,"config"!=q._def.category&&J.push(q)}var Q={catch:"scope",status:"scope","link in":"links","link out":"links"};for(s=0;s<J.length;s++){if((d=J[s]).wires){for(var Z=0;Z<d.wires.length;Z++)for(var ee=d.wires[Z]instanceof Array?d.wires[Z]:[d.wires[Z]],te=0;te<ee.length;te++)if(B.hasOwnProperty(ee[te]))if(d.z===B[ee[te]].z){var ne={source:d,sourcePort:Z,target:B[ee[te]]};D(ne),G.push(ne)}else console.log("Warning: dropping link that crosses tabs:",d.id,"->",B[ee[te]].id);delete d.wires}for(var oe in d._def.defaults)if(d._def.defaults.hasOwnProperty(oe))if(d._def.defaults[oe].type&&B[d[oe]])d[oe]=B[d[oe]].id,(S=RED.nodes.node(d[oe]))&&-1===S.users.indexOf(d)&&S.users.push(d);else if(Q.hasOwnProperty(d.type)&&Q[d.type]===oe&&void 0!==d[oe]&&null!==d[oe])for(var ie=0;ie<d[oe].length;ie++)B[d[oe][ie]]&&(d[oe][ie]=B[d[oe][ie]].id);g&&/^link /.test(d.type)&&d.links&&(d.links=d.links.filter(function(e){var t=RED.nodes.node(e);return t&&t.z===h})),RED.editor.validateNode(d)}for(s=0;s<A.length;s++)(d=A[s]).in.forEach(function(e){e.wires.forEach(function(t){var n={source:e,sourcePort:0,target:B[t.id]};D(n),G.push(n)}),delete e.wires}),d.out.forEach(function(e){e.wires.forEach(function(t){var n;D(n=M[t.id]&&M[t.id].id==d.id?{source:d.in[t.port],sourcePort:t.port,target:e}:{source:B[t.id]||M[t.id],sourcePort:t.port,target:e}),G.push(n)}),delete e.wires});return RED.workspaces.refresh(),[J,G,I,A,V]}function z(e){for(var t in e._def.defaults)if(e._def.defaults.hasOwnProperty(t)){var n=e._def.defaults[t];if(n.type){var o=b.getNodeType(n.type);if(o&&"config"==o.category){var i=a[e[t]];i&&-1===i.users.indexOf(e)&&i.users.push(e)}}}}return{init:function(){RED.events.on("registry:node-type-added",function(e){b.getNodeType(e);var t=[];if(RED.nodes.eachNode(function(n){"unknown"===n.type&&n.name===e&&t.push(n)}),RED.nodes.eachConfig(function(n){"unknown"===n.type&&n.name===e&&t.push(n)}),t.length>0){var n=[];t.forEach(function(e){a.hasOwnProperty(e.id)?delete a[e.id]:o.splice(o.indexOf(e),1),n.push(O(e))}),RED.view.redraw(!0);var i={};I(n,!1)[0].forEach(function(e){i[e.id]=e}),RED.nodes.eachLink(function(e){i.hasOwnProperty(e.source.id)&&(e.source=i[e.source.id]),i.hasOwnProperty(e.target.id)&&(e.target=i[e.target.id])}),RED.view.redraw(!0)}})},registry:b,setNodeList:b.setNodeList,getNodeSet:b.getNodeSet,addNodeSet:b.addNodeSet,removeNodeSet:b.removeNodeSet,enableNodeSet:b.enableNodeSet,disableNodeSet:b.disableNodeSet,registerType:b.registerNodeType,getType:b.getNodeType,convertNode:O,add:w,remove:R,clear:function(){o=[],s=[],a={},d=[],Object.keys(l).forEach(function(e){RED.subflow.removeSubflow(e)}),Object.keys(r).forEach(function(e){RED.workspaces.remove(r[e])}),e=null,RED.nodes.dirty(!0),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()},addLink:D,removeLink:function(e){var t=s.indexOf(e);-1!=t&&s.splice(t,1)},addWorkspace:k,removeWorkspace:function(e){delete r[e],d.splice(d.indexOf(e),1);var t,n,i=[],s=[];for(t=0;t<o.length;t++)(n=o[t]).z==e&&i.push(n);for(t in a)a.hasOwnProperty(t)&&(n=a[t]).z==e&&i.push(n);for(t=0;t<i.length;t++){var l=R(i[t].id);s=s.concat(l.links)}return{nodes:i,links:s}},getWorkspaceOrder:function(){return d},setWorkspaceOrder:function(e){d=e},workspace:function(e){return r[e]},addSubflow:x,removeSubflow:function(e){delete l[e.id],b.removeNodeType("subflow:"+e.id)},subflow:_,subflowContains:T,eachNode:function(e){for(var t=0;t<o.length;t++)e(o[t])},getLinks:function(){return s},eachLink:function(e){for(var t=0;t<s.length;t++)e(s[t])},eachConfig:function(e){for(var t in a)a.hasOwnProperty(t)&&e(a[t])},eachSubflow:function(e){for(var t in l)l.hasOwnProperty(t)&&e(l[t])},eachWorkspace:function(e){for(var t=0;t<d.length;t++)e(r[d[t]])},node:E,version:function(e){if(void 0===e)return c;c=e},originalFlow:function(e){if(void 0===e)return t;t=e},filterNodes:function(e){for(var t=[],n=0;n<o.length;n++){var i=o[n];e.hasOwnProperty("z")&&i.z!==e.z||e.hasOwnProperty("type")&&i.type!==e.type||t.push(i)}return t},filterLinks:function(e){for(var t=[],n=0;n<s.length;n++){var o=s[n];if(e.source){if(e.source.hasOwnProperty("id")&&o.source.id!==e.source.id)continue;if(e.source.hasOwnProperty("z")&&o.source.z!==e.source.z)continue}if(e.target){if(e.target.hasOwnProperty("id")&&o.target.id!==e.target.id)continue;if(e.target.hasOwnProperty("z")&&o.target.z!==e.target.z)continue}e.hasOwnProperty("sourcePort")&&o.sourcePort!==e.sourcePort||t.push(o)}return t},import:I,getAllFlowNodes:function(e){var t={};t[e.id]=!0;for(var n=[e],o=[e];0!==o.length;)for(var i=o.shift(),a=s.filter(function(e){return e.source===i||e.target===i}),r=0;r<a.length;r++){var d=a[r].source===i?a[r].target:a[r].source,l=d.id;l||(l=d.direction+":"+d.i),t[l]||(t[l]=!0,n.push(d),o.push(d))}return n},createExportableNodeSet:L,createCompleteNodeSet:function(e){void 0===e&&(e=!0);var t,n=[];for(t=0;t<d.length;t++)"tab"==r[d[t]].type&&n.push(C(r[d[t]]));for(t in l)l.hasOwnProperty(t)&&n.push(S(l[t]));for(t in a)a.hasOwnProperty(t)&&n.push(O(a[t],e));for(t=0;t<o.length;t++){var i=o[t];n.push(O(i,e))}return n},updateConfigNodeUsers:z,id:y,dirty:function(e){if(null==e)return p;p=e,RED.events.emit("nodes:change",{dirty:p})}}}(),RED.history=function(){var e=[];return{markAllDirty:function(){for(var t=0;t<e.length;t++)e[t].dirty=!0},list:function(){return e},depth:function(){return e.length},push:function(t){e.push(t)},pop:function(){!function e(t){var n,o,i,a={};if(t){if("multi"==t.t)for(n=t.events.length-1;n>=0;n--)e(t.events[n]);else if("replace"==t.t)RED.nodes.clear(),RED.nodes.import(t.config)[0].forEach(function(e){t.changed[e.id]&&(e.changed=!0)}),RED.nodes.version(t.rev);else if("add"==t.t){if(t.nodes)for(n=0;n<t.nodes.length;n++)(o=RED.nodes.node(t.nodes[n])).z&&(a[o.z]=!0),RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.removeWorkspace(t.workspaces[n].id),RED.workspaces.remove(t.workspaces[n]);if(t.subflows)for(n=0;n<t.subflows.length;n++)RED.nodes.removeSubflow(t.subflows[n]),RED.workspaces.remove(t.subflows[n]);if(t.subflow&&(t.subflow.instances&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),t.subflow.hasOwnProperty("changed")&&(i=RED.nodes.subflow(t.subflow.id))&&(i.changed=t.subflow.changed)),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("delete"==t.t){if(t.workspaces)for(n=0;n<t.workspaces.length;n++)RED.nodes.addWorkspace(t.workspaces[n]),RED.workspaces.add(t.workspaces[n]);if(t.subflow&&t.subflow.subflow&&RED.nodes.addSubflow(t.subflow.subflow),t.subflowInputs&&t.subflowInputs.length>0&&((i=RED.nodes.subflow(t.subflowInputs[0].z)).in.push(t.subflowInputs[0]),i.in[0].dirty=!0),t.subflowOutputs&&t.subflowOutputs.length>0)for(i=RED.nodes.subflow(t.subflowOutputs[0].z),t.subflowOutputs.sort(function(e,t){return e.i-t.i}),n=0;n<t.subflowOutputs.length;n++){var s=t.subflowOutputs[n];i.out.splice(s.i,0,s);for(var r=s.i+1;r<i.out.length;r++)i.out[r].i++,i.out[r].dirty=!0;RED.nodes.eachLink(function(e){e.source.type=="subflow:"+i.id&&e.sourcePort>=s.i&&e.sourcePort++})}if(t.subflow&&t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),i&&RED.nodes.filterNodes({type:"subflow:"+i.id}).forEach(function(e){for(e.inputs=i.in.length,e.outputs=i.out.length;e.outputs>e.ports.length;)e.ports.push(e.ports.length);e.resize=!0,e.dirty=!0}),t.nodes)for(n=0;n<t.nodes.length;n++)RED.nodes.add(t.nodes[n]),a[t.nodes[n].z]=!0;if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);if(t.changes)for(n in t.changes)if(t.changes.hasOwnProperty(n)&&(o=RED.nodes.node(n))){for(var d in t.changes[n])t.changes[n].hasOwnProperty(d)&&(o[d]=t.changes[n][d]);o.dirty=!0}}else if("move"==t.t){for(n=0;n<t.nodes.length;n++){var l=t.nodes[n];l.n.x=l.ox,l.n.y=l.oy,l.n.dirty=!0,l.n.moved=l.moved}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else if("edit"==t.t){for(n in t.changes)if(t.changes.hasOwnProperty(n)){if(t.node._def.defaults[n]&&t.node._def.defaults[n].type){var c=RED.nodes.node(t.node[n]);c&&c.users.splice(c.users.indexOf(t.node),1);var p=RED.nodes.node(t.changes[n]);p&&p.users.push(t.node)}t.node[n]=t.changes[n]}if(t.subflow)t.subflow.hasOwnProperty("inputCount")&&(t.node.in.length>t.subflow.inputCount?t.node.in.splice(t.subflow.inputCount):t.subflow.inputs.length>0&&(t.node.in=t.node.in.concat(t.subflow.inputs))),t.subflow.hasOwnProperty("outputCount")&&(t.node.out.length>t.subflow.outputCount?t.node.out.splice(t.subflow.outputCount):t.subflow.outputs.length>0&&(t.node.out=t.node.out.concat(t.subflow.outputs))),t.subflow.hasOwnProperty("instances")&&t.subflow.instances.forEach(function(e){var t=RED.nodes.node(e.id);t&&(t.changed=e.changed,t.dirty=!0)}),RED.nodes.filterNodes({type:"subflow:"+t.node.id}).forEach(function(e){e.inputs=t.node.in.length,e.outputs=t.node.out.length,RED.editor.updateNodeProperties(e)});else{var u;if(t.outputMap){u={};for(var f in t.outputMap)t.outputMap.hasOwnProperty(f)&&"-1"!==t.outputMap[f]&&(u[t.outputMap[f]]=f)}RED.editor.updateNodeProperties(t.node,u),RED.editor.validateNode(t.node)}if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.addLink(t.links[n]);t.node.dirty=!0,t.node.changed=t.changed}else if("createSubflow"==t.t){if(t.nodes)for(RED.nodes.filterNodes({z:t.subflow.subflow.id}).forEach(function(e){e.z=t.activeWorkspace,e.dirty=!0}),n=0;n<t.nodes.length;n++)RED.nodes.remove(t.nodes[n]);if(t.links)for(n=0;n<t.links.length;n++)RED.nodes.removeLink(t.links[n]);if(RED.nodes.removeSubflow(t.subflow.subflow),RED.workspaces.remove(t.subflow.subflow),t.removedLinks)for(n=0;n<t.removedLinks.length;n++)RED.nodes.addLink(t.removedLinks[n])}else"reorder"==t.t&&t.order&&RED.workspaces.order(t.order);Object.keys(a).forEach(function(e){var t=RED.nodes.subflow(e);t&&RED.editor.validateNode(t)}),RED.nodes.dirty(t.dirty),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}}(e.pop())},peek:function(){return e[e.length-1]}}}(),RED.validators={number:function(e){return function(t){return e&&(""===t||void 0===t)||""!==t&&!isNaN(t)}},regex:function(e){return function(t){return e.test(t)}},typedInput:function(e,t){return function(n){var o=$("#node-"+(t?"config-":"")+"input-"+e).val()||this[e];if("json"===o)try{return JSON.parse(n),!0}catch(e){return!1}else{if("msg"===o||"flow"===o||"global"===o)return RED.utils.validatePropertyExpression(n);if("num"===o)return/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/.test(n)}return!0}}},RED.utils=function(){function e(e){return e.replace(/\r?\n/g,"&crarr;").replace(/\t/g,"&rarr;")}function t(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function n(n){var o;if(Array.isArray(n))o=$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("array["+n.length+"]");else if(null===n)o=$('<span class="debug-message-object-value debug-message-type-null">null</span>');else if("object"==typeof n)o=n.hasOwnProperty("type")&&"Buffer"===n.type&&n.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("buffer["+n.length+"]"):n.hasOwnProperty("type")&&"array"===n.type&&n.hasOwnProperty("data")?$('<span class="debug-message-object-value debug-message-type-meta"></span>').html("array["+n.length+"]"):$('<span class="debug-message-object-value debug-message-type-meta">object</span>');else if("string"==typeof n){var i;i=n.length>30?t(n.substring(0,30))+"&hellip;":t(n),o=$('<span class="debug-message-object-value debug-message-type-string"></span>').html('"'+e(i)+'"')}else o=$('<span class="debug-message-object-value debug-message-type-other"></span>').text(""+n);return o}function o(e,t,n,o){e.addClass("debug-message-expandable"),e.prop("toggle",function(){return function(n){var o=e.parent();if(o.hasClass("collapsed")){if(n)return t&&!o.hasClass("built")&&(t(),o.addClass("built")),o.removeClass("collapsed"),!0}else if(!n)return o.addClass("collapsed"),!0;return!1}}),e.click(function(e){var t=!$(this).parent().hasClass("collapsed");$(this).prop("toggle")(!t)&&n&&n(!t),e.preventDefault()}),o&&e.click()}var i={},a={};function s(e,t,n,o){if(t&&t.length>0){if(""===e&&void 0===n)return!0;for(var i=0;i<t.length;i++){var a=t[i];if(0===a.indexOf(e)&&("."===a[e.length]||"["===a[e.length])){if(void 0===n||"["!==a[e.length])return!0;var s=a.substring(e.length),r=/\[(\d+)\]/.exec(s);if(r){var d=parseInt(r[1]);return n<=d&&d<=o}}}}return!1}function r(e,t,n,o,i,s){var r=a[n]&&a[n][o]||s||"dec";i?(r="dec"===r?13===t.toString().length&&t<=2147483647e3?"dateMS":10===t.toString().length&&t<=2147483647?"dateS":"hex":"dateMS"===r||"dateS"==r?"hex":"dec",a[n]=a[n]||{},a[n][o]=r):void 0!==s&&(a[n]=a[n]||{},a[n][o]=r),"dec"===r?e.text(""+t):"dateMS"===r?e.text(new Date(t).toISOString()):"dateS"===r?e.text(new Date(1e3*t).toISOString()):"hex"===r&&e.text("0x"+t.toString(16))}function d(e,t,n,o,i){var s=a[n]&&a[n][o]||"raw";i&&(s="raw"===s?"string":"raw",a[n]=a[n]||{},a[n][o]=s),"raw"===s?(t.text("raw"),e.removeClass("debug-message-buffer-string").addClass("debug-message-buffer-raw")):"string"===s&&(t.text("string"),e.addClass("debug-message-buffer-string").removeClass("debug-message-buffer-raw"))}function l(e){var t=e.length;if(0===t)throw new Error("Invalid property expression: zero-length");for(var n,o,i=[],a=0,s=!1,r=!1,d=0;d<t;d++){var l=e[d];if(s){if(l===n){if(d-a==0)throw new Error("Invalid property expression: zero-length string at position "+a);if(i.push(e.substring(a,d)),r&&!/\]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected array expression at position "+a);if(!r&&d+1!==t&&!/[\[\.]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" expression at position "+(d+1));a=d+1,s=!1}}else if("'"===l||'"'===l){if(d!=a)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);s=!0,n=l,a=d+1}else if("."===l){if(0===d)throw new Error("Invalid property expression: unexpected . at position 0");if(a!=d&&(o=e.substring(a,d),/^\d+$/.test(o)?i.push(parseInt(o)):i.push(o)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/[a-z0-9\$\_]/i.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));a=d+1}else if("["===l){if(0===d)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(a!=d&&i.push(e.substring(a,d)),d===t-1)throw new Error("Invalid property expression: unterminated expression");if(!/["'\d]/.test(e[d+1]))throw new Error("Invalid property expression: unexpected "+e[d+1]+" at position "+(d+1));a=d+1,r=!0}else if("]"===l){if(!r)throw new Error("Invalid property expression: unexpected "+l+" at position "+d);if(a!=d){if(o=e.substring(a,d),!/^\d+$/.test(o))throw new Error("Invalid property expression: unexpected array expression at position "+a);i.push(parseInt(o))}a=d+1,r=!1}else if(" "===l)throw new Error("Invalid property expression: unexpected ' ' at position "+d)}if(r||s)throw new Error("Invalid property expression: unterminated expression");return a<t&&i.push(e.substring(a)),i}function c(e,t){var n,o=null;return"string"==typeof t?(0===t.indexOf("msg.")&&(t=t.substring(4)),n=l(t)):n=t,n.reduce(function(e,t){return void 0===(o=void 0!==e[t]?e[t]:void 0)&&e.hasOwnProperty("type")&&e.hasOwnProperty("data")&&e.hasOwnProperty("length")&&(o=void 0!==e.data[t]?e.data[t]:void 0),o},e),o}return{createObjectElement:function a(p,u){var f,h,g,v,m,b,y=(u=u||{}).key,w=u.typeHint,D=u.hideKey,E=u.path,R=u.sourceId,k=u.rootPath,x=u.expandPaths,_=u.ontoggle,T=u.exposeApi,C={};void 0!==E&&void 0!==k&&(b=E.substring(k.length+("."===E[k.length]?1:0)));var O=$('<span class="debug-message-element"></span>');if(O.collapse=function(){O.find(".debug-message-expandable").parent().addClass("collapsed")},v=$('<span class="debug-message-row"></span>').appendTo(O),R&&function(e,t,n,o,a,s){i.hasOwnProperty(t)||(i[t]={});var r=$('<span class="debug-message-tools"></span>').appendTo(e),d=$('<span class="debug-message-tools-copy button-group"></span>').appendTo(r);if(n)var c=$('<button class="editor-button editor-button-small"><i class="fa fa-terminal"></i></button>').appendTo(d).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(n,c,"clipboard.copyMessagePath")});var p=$('<button class="editor-button editor-button-small"><i class="fa fa-clipboard"></i></button>').appendTo(d).click(function(e){e.preventDefault(),e.stopPropagation(),RED.clipboard.copyText(o,p,"clipboard.copyMessageValue")});if(""!==s){var u=i[t].hasOwnProperty(s);$('<button class="editor-button editor-button-small debug-message-tools-pin"><i class="fa fa-map-pin"></i></button>').appendTo(r).click(function(n){if(n.preventDefault(),n.stopPropagation(),i[t].hasOwnProperty(s))delete i[t][s],$(this).removeClass("selected"),e.removeClass("debug-message-row-pinned");else{var o="$"+("["===s[0]?"":".")+s;i[t][s]=l(o),$(this).addClass("selected"),e.addClass("debug-message-row-pinned")}}).toggleClass("selected",u),e.toggleClass("debug-message-row-pinned",u)}}(v,R,E,p,0,b),y)D||($('<span class="debug-message-object-key"></span>').text(y).appendTo(v),$("<span>: </span>").appendTo(v));else if(O.addClass("debug-message-top-level"),R){var S=i[R];if(x=[],S){for(var L in S)if(S.hasOwnProperty(L))try{void 0!==c({$:p},S[L])&&x.push(L)}catch(e){}x.sort()}O.clearPinned=function(){O.find(".debug-message-row-pinned").removeClass("debug-message-row-pinned"),i[R]={}}}g=$('<span class="debug-message-object-value"></span>').appendTo(v);var N=Array.isArray(p),P=!1;if(p&&"object"==typeof p&&p.hasOwnProperty("type")&&p.hasOwnProperty("data")&&(p.__encoded__&&"array"===p.type||"Buffer"===p.type)&&(N=!0,P=!0),null===p||void 0===p)$('<span class="debug-message-type-null">'+p+"</span>").appendTo(g);else if("string"==typeof p)/[\t\n\r]/.test(p)&&(O.addClass("collapsed"),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v),o(v,function(){$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html(w||"string").appendTo(v);var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(O);$('<pre class="debug-message-type-string"></pre>').text(p).appendTo(e)},function(e){_&&_(E,e)},s(b,x))),h=$('<span class="debug-message-type-string debug-message-object-header"></span>').html('"'+e(t(p))+'"').appendTo(g),/^#[0-9a-f]{6}$/i.test(p)&&$('<span class="debug-message-type-string-swatch"></span>').css("backgroundColor",p).appendTo(h);else if("number"==typeof p)h=$('<span class="debug-message-type-number"></span>').appendTo(g),Number.isInteger(p)&&p>=0&&(h.addClass("debug-message-type-number-toggle"),h.click(function(e){e.preventDefault(),r($(this),p,R,E,!0)})),r(h,p,R,E,!1,"hex"===w?"hex":void 0);else if(N){O.addClass("collapsed");var I=p.length;if(w){var z=/\[(\d+)\]/.exec(w);z&&(I=parseInt(z[1]))}var A=p,M="array";P?(A=p.data,void 0===I&&(I=A.length),A.__encoded__&&(A=A.data),M=p.type.toLowerCase()):/buffer/.test(w)&&(M="buffer");var j=A.length;if(I>0){$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v);var B=$('<div class="debug-message-array-rows"></div>').appendTo(O);O.addClass("debug-message-buffer-raw")}if(y)m=$('<span class="debug-message-type-meta"></span>').html(w||M+"["+I+"]").appendTo(g);else{m=$('<span class="debug-message-object-header"></span>').appendTo(g),$("<span>[ </span>").appendTo(m);var J=Math.min(I,10);for(f=0;f<J;f++)n(A[f]).appendTo(m),f<J-1&&$("<span>, </span>").appendTo(m);I>J&&$("<span> &hellip;</span>").appendTo(m),0===J&&$('<span class="debug-message-type-meta">empty</span>').appendTo(m),$("<span> ]</span>").appendTo(m)}I>0&&o(v,function(){if(y||(m=$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html(w||M+"["+I+"]").appendTo(v)),"buffer"===M){var e=$('<div class="debug-message-string-rows"></div>').appendTo(O),t=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(e),n="";try{n=String.fromCharCode.apply(null,new Uint16Array(A))}catch(e){console.log(e)}$('<pre class="debug-message-type-string"></pre>').text(n).appendTo(t);var i=$('<span class="debug-message-buffer-opts"></span>').appendTo(m),r=$('<a href="#"></a>').addClass("selected").html("raw").appendTo(i).click(function(e){e.preventDefault(),e.stopPropagation(),d(O,$(this),R,E,!0)});d(O,r,R,E,!1)}var l;if(j<=10)for(f=0;f<j;f++)l=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(B),C[E+"["+f+"]"]=a(A[f],{key:""+f,typeHint:"buffer"===M&&"hex",hideKey:!1,path:E+"["+f+"]",sourceId:R,rootPath:k,expandPaths:x,ontoggle:_,exposeApi:T}).appendTo(l);else{for(f=0;f<j;f+=10){var c=f;l=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(B),v=$("<span></span>").appendTo(l),$('<i class="fa fa-caret-right debug-message-object-handle"></i> ').appendTo(v),o(v,function(){var e=c,t=Math.min(j-1,c+9),n=l;return function(){for(var o=e;o<=t;o++){var i=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(n);C[E+"["+o+"]"]=a(A[o],{key:""+o,typeHint:"buffer"===M&&"hex",hideKey:!1,path:E+"["+o+"]",sourceId:R,rootPath:k,expandPaths:x,ontoggle:_,exposeApi:T}).appendTo(i)}}}(),function(){var e=e+"["+f+"]";return function(t){_&&_(e,t)}}(),s(b,x,c,Math.min(j-1,c+9))),$('<span class="debug-message-object-key"></span>').html("["+c+" &hellip; "+Math.min(j-1,c+9)+"]").appendTo(v)}j<I&&$('<div class="debug-message-object-entry collapsed"><span class="debug-message-object-key">['+j+" &hellip; "+I+"]</span></div>").appendTo(B)}},function(e){_&&_(E,e)},s(b,x))}else if("object"==typeof p){O.addClass("collapsed");var G=Object.keys(p);if((y||G.length>0)&&($('<i class="fa fa-caret-right debug-message-object-handle"></i> ').prependTo(v),o(v,function(){for(y||$('<span class="debug-message-type-meta debug-message-object-type-header"></span>').html("object").appendTo(v),f=0;f<G.length;f++){var e=$('<div class="debug-message-object-entry collapsed"></div>').appendTo(O),t=E;t&&(/^[a-zA-Z_$][0-9a-zA-Z_$]*$/.test(G[f])?t+=(t.length>0?".":"")+G[f]:t+='["'+G[f].replace(/"/,'\\"')+'"]'),C[t]=a(p[G[f]],{key:G[f],typeHint:!1,hideKey:!1,path:t,sourceId:R,rootPath:k,expandPaths:x,ontoggle:_,exposeApi:T}).appendTo(e)}0===G.length&&$('<div class="debug-message-object-entry debug-message-type-meta collapsed"></div>').text("empty").appendTo(O)},function(e){_&&_(E,e)},s(b,x))),y)$('<span class="debug-message-type-meta"></span>').html("object").appendTo(g);else{m=$('<span class="debug-message-object-header"></span>').appendTo(g),$("<span>{ </span>").appendTo(m);var V=Math.min(G.length,5);for(f=0;f<V;f++)$('<span class="debug-message-object-key"></span>').text(G[f]).appendTo(m),$("<span>: </span>").appendTo(m),n(p[G[f]]).appendTo(m),f<V-1&&$("<span>, </span>").appendTo(m);G.length>V&&$("<span> &hellip;</span>").appendTo(m),0===V&&$('<span class="debug-message-type-meta">empty</span>').appendTo(m),$("<span> }</span>").appendTo(m)}}else $('<span class="debug-message-type-other"></span>').text(""+p).appendTo(g);return T&&O.prop("expand",function(){return function(e,t){if(E===e)v.prop("toggle")&&v.prop("toggle")(t);else if(C[e]&&C[e].prop("expand"))C[e].prop("expand")(e,t);else for(var n in C)if(C.hasOwnProperty(n)&&0===e.indexOf(n)){C[n].prop("expand")&&C[n].prop("expand")(e,t);break}}}),O},getMessageProperty:c,normalisePropertyExpression:l,validatePropertyExpression:function(e){try{return l(e),!0}catch(e){return!1}},getNodeIcon:function(e,t){if("config"===e.category)return"icons/node-red/cog.png";if(t&&"tab"===t.type)return"icons/node-red/subflow.png";if(t&&"unknown"===t.type)return"icons/node-red/alert.png";if(t&&"subflow"===t.type)return"icons/node-red/subflow.png";var n;if("function"==typeof e.icon)try{n=e.icon.call(t)}catch(t){console.log("Definition error: "+e.type+".icon",t),n="arrow-in.png"}else n=e.icon;return"icons/"+e.set.module+"/"+n},getNodeLabel:function(e,t){var n;if(t=t||"","tab"===e.type)n=e.label||t;else{n=e._def.label;try{n=("function"==typeof n?n.call(e):n)||t}catch(o){console.log("Definition error: "+e.type+".label",o),n=t}}return RED.text.bidi.enforceTextDirectionWithUCC(n)}}}(),function(e){e.widget("nodered.editableList",{_create:function(){var t,n=this;(this.element.addClass("red-ui-editableList-list"),this.uiWidth=this.element.width(),this.uiContainer=this.element.wrap("<div>").parent(),this.options.header?(this.options.header.addClass("red-ui-editableList-header"),this.borderContainer=this.uiContainer.wrap("<div>").parent(),this.borderContainer.prepend(this.options.header),this.topContainer=this.borderContainer.wrap("<div>").parent()):this.topContainer=this.uiContainer.wrap("<div>").parent(),this.topContainer.addClass("red-ui-editableList"),this.options.class&&this.topContainer.addClass(this.options.class),!1!==this.options.addButton)&&(t="string"==typeof this.options.addButton?this.options.addButton:RED&&RED._?RED._("editableList.add"):"add",e('<a href="#" class="editor-button editor-button-small" style="margin-top: 4px;"><i class="fa fa-plus"></i> '+t+"</a>").appendTo(this.topContainer).click(function(e){e.preventDefault(),n.addItem({})}));"absolute"===this.element.css("position")&&(["top","left","bottom","right"].forEach(function(e){var t=n.element.css(e);"auto"!==t&&""!==t&&(n.topContainer.css(e,t),n.uiContainer.css(e,"0"),n.element.css(e,"auto"))}),this.element.css("position","static"),this.topContainer.css("position","absolute"),this.uiContainer.css("position","absolute")),this.options.header?this.borderContainer.addClass("red-ui-editableList-border"):this.uiContainer.addClass("red-ui-editableList-border"),this.uiContainer.addClass("red-ui-editableList-container"),this.uiHeight=this.element.height(),this.activeFilter=this.options.filter||null,this.activeSort=this.options.sort||null,this.scrollOnAdd=this.options.scrollOnAdd,void 0===this.scrollOnAdd&&(this.scrollOnAdd=!0);var o=this.element.css("minHeight");"0px"!==o&&(this.uiContainer.css("minHeight",o),this.element.css("minHeight",0)),"auto"!==this.options.height&&(this.uiContainer.css("overflow-y","scroll"),isNaN(this.options.height)||(this.uiHeight=this.options.height)),this.element.height("auto");var i,a=this.element.attr("style");if(null!==(i=/width\s*:\s*(\d+%)/i.exec(a))&&(this.element.width("100%"),this.uiContainer.width(i[1])),this.options.sortable){var s={axis:"y",update:function(e,t){n.options.sortItems&&n.options.sortItems(n.items())},handle:"string"==typeof this.options.sortable?this.options.sortable:".red-ui-editableList-item-handle",cursor:"move",tolerance:"pointer",forcePlaceholderSize:!0,placeholder:"red-ui-editabelList-item-placeholder",start:function(e,t){t.placeholder.height(t.item.height()-4)}};this.options.connectWith&&(s.connectWith=this.options.connectWith),this.element.sortable(s)}this._resize()},_resize:function(){var t=this.topContainer.height()-this.uiContainer.height();if(0!==this.uiHeight&&this.uiContainer.height(this.uiHeight-t),this.options.resize&&this.options.resize(),this.options.resizeItem){var n=this;this.element.children().each(function(t){n.options.resizeItem(e(this).find(".red-ui-editableList-item-content"),t)})}},_destroy:function(){},_refreshFilter:function(){var e=this,t=0;return this.activeFilter?(this.items().each(function(n,o){var i=o.data("data");try{e.activeFilter(i)?(o.parent().show(),t++):o.parent().hide()}catch(e){console.log(e),o.parent().show(),t++}}),t):this.element.children().show()},_refreshSort:function(){if(this.activeSort){var t=this.element.children(),n=this;t.sort(function(t,o){return n.activeSort(e(t).find(".red-ui-editableList-item-content").data("data"),e(o).find(".red-ui-editableList-item-content").data("data"))}),e.each(t,function(e,t){n.element.append(t)})}},width:function(e){this.uiWidth=e,this._resize()},height:function(e){this.uiHeight=e,this._resize()},addItem:function(t){var n=this;t=t||{};var o=e("<li>"),i=!1;if(this.activeSort){this.items().each(function(e,a){if(!i){var s=a.data("data");n.activeSort(t,s)<0&&(o.insertBefore(a.closest("li")),i=!0)}})}i||o.appendTo(this.element);var a=e("<div/>").addClass("red-ui-editableList-item-content").appendTo(o);if(a.data("data",t),!0===this.options.sortable&&(e('<i class="red-ui-editableList-item-handle fa fa-bars"></i>').appendTo(o),o.addClass("red-ui-editableList-item-sortable")),this.options.removable){var s=e("<a/>",{href:"#",class:"red-ui-editableList-item-remove editor-button editor-button-small"}).appendTo(o);e("<i/>",{class:"fa fa-remove"}).appendTo(s),o.addClass("red-ui-editableList-item-removable"),s.click(function(t){t.preventDefault();var i=a.data("data");o.addClass("red-ui-editableList-item-deleting"),o.fadeOut(300,function(){e(this).remove(),n.options.removeItem&&n.options.removeItem(i)})})}if(this.options.addItem){var r=n.element.children().length-1;setTimeout(function(){if(n.options.addItem(a,r,t),n.activeFilter)try{n.activeFilter(t)||o.hide()}catch(e){}!n.activeSort&&n.scrollOnAdd&&setTimeout(function(){n.uiContainer.scrollTop(n.element.height())},0)},0)}},addItems:function(e){for(var t=0;t<e.length;t++)this.addItem(e[t])},removeItem:function(t){this.element.children().filter(function(n){return t===e(this).find(".red-ui-editableList-item-content").data("data")}).remove(),this.options.removeItem&&this.options.removeItem(t)},items:function(){return this.element.children().map(function(t){return e(this).find(".red-ui-editableList-item-content")})},empty:function(){this.element.empty()},filter:function(e){return void 0!==e&&(this.activeFilter=e),this._refreshFilter()},sort:function(e){return void 0!==e&&(this.activeSort=e),this._refreshSort()},length:function(){return this.element.children().length}})}(jQuery),function(e){e.widget("nodered.checkboxSet",{_create:function(){var t=this;this.uiElement=this.element.wrap("<span>").parent(),this.uiElement.addClass("red-ui-checkboxSet"),this.options.parent&&(this.parent=this.options.parent,this.parent.checkboxSet("addChild",this.element)),this.children=[],this.partialFlag=!1,this.stateValue=0;var n=this.element.prop("checked");this.options=[e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-check-square-o"></i></span>').appendTo(this.uiElement),e('<span class="red-ui-checkboxSet-option hide"><i class="fa fa-minus-square-o"></i></span>').appendTo(this.uiElement)],n?this.options[1].show():this.options[0].show(),this.element.change(function(){this.checked?(t.options[0].hide(),t.options[1].show(),t.options[2].hide()):(t.options[1].hide(),t.options[0].show(),t.options[2].hide());var e=this.checked;t.children.forEach(function(t){t.checkboxSet("state",e,!1,!0)})}),this.uiElement.click(function(e){e.stopPropagation(),t.state(!1===t.state())}),this.parent&&this.parent.checkboxSet("updateChild",this)},_destroy:function(){this.parent&&this.parent.checkboxSet("removeChild",this.element)},addChild:function(e){this.children.push(e)},removeChild:function(e){var t=this.children.indexOf(e);t>-1&&this.children.splice(t,1)},updateChild:function(e){var t=0;this.children.forEach(function(e,n){!0===e.checkboxSet("state")&&t++}),0===t?this.state(!1,!0):t===this.children.length?this.state(!0,!0):this.state(null,!0)},disable:function(){this.uiElement.addClass("disabled")},state:function(e,t,n){if(0===arguments.length)return this.partialFlag?null:this.element.is(":checked");this.partialFlag=null===e;var o=this.partialFlag||e;this.element.prop("checked",o),!0===e?(this.options[0].hide(),this.options[1].show(),this.options[2].hide()):!1===e?(this.options[2].hide(),this.options[1].hide(),this.options[0].show()):null===e&&(this.options[0].hide(),this.options[1].hide(),this.options[2].show()),t||this.element.trigger("change",null),!n&&this.parent&&this.parent.checkboxSet("updateChild",this)}})}(jQuery),RED.menu=function(){var e={};function t(a){var s,r;if(null!==a&&a.id&&!1===RED.settings.theme("menu."+a.id))return null;if(null===a)s=$('<li class="divider"></li>');else{s=$("<li></li>"),a.group&&s.addClass("menu-group-"+a.group);var d="<a "+(a.id?'id="'+a.id+'" ':"")+'tabindex="-1" href="#">';a.toggle&&(d+='<i class="fa fa-square pull-left"></i>',d+='<i class="fa fa-check-square pull-left"></i>'),void 0!==a.icon&&(/\.png/.test(a.icon)?d+='<img src="'+a.icon+'"/> ':d+='<i class="'+(a.icon?a.icon:'" style="display: inline-block;"')+'"></i> '),a.sublabel?d+='<span class="menu-label-container"><span class="menu-label">'+a.label+'</span><span class="menu-sublabel">'+a.sublabel+"</span></span>":d+='<span class="menu-label">'+a.label+"</span>",d+="</a>";var l=$(d).appendTo(s);if(e[a.id]=a,a.onselect?(l.click(function(t){if(t.preventDefault(),!$(this).parent().hasClass("disabled"))if(a.toggle){var s=o(a.id);if("string"==typeof a.toggle){if(!s){for(var r in e)if(e.hasOwnProperty(r)){var d=e[r];d.id!=a.id&&a.toggle==d.toggle&&i(d.id,!1)}i(a.id,!0)}}else i(a.id,!s)}else n(a.id)}),a.toggle&&(r=RED.settings.get("menu-"+a.id),a.setting&&(null!==r?(RED.settings.set(a.setting,r),RED.settings.remove("menu-"+a.id)):r=RED.settings.get(a.setting)),r?(l.addClass("active"),n(a.id,!0)):!1===r?(l.removeClass("active"),n(a.id,!1)):a.hasOwnProperty("selected")&&(a.selected?l.addClass("active"):l.removeClass("active"),n(a.id,a.selected)))):a.href?l.attr("target","_blank").attr("href",a.href):a.options||(s.addClass("disabled"),l.click(function(e){e.preventDefault()})),a.options){s.addClass("dropdown-submenu pull-left");for(var c=$('<ul id="'+a.id+'-submenu" class="dropdown-menu"></ul>').appendTo(s),p=0;p<a.options.length;p++){var u=t(a.options[p]);u&&u.appendTo(c)}}a.disabled&&s.addClass("disabled")}return s}function n(t,n){var o=e[t],i=o.onselect;"string"==typeof o.onselect&&(i=RED.actions.get(o.onselect)),i?i.call(o,n):console.log("No callback for",t,o.onselect)}function o(e){return $("#"+e).hasClass("active")}function i(t,i){if(o(t)!=i){var a=e[t];i?$("#"+t).addClass("active"):$("#"+t).removeClass("active"),a&&a.onselect&&n(a.id,i),RED.settings.set(a.setting||"menu-"+a.id,i)}}return{init:function(e){var n=$("#"+e.id),o=$("<ul/>",{id:e.id+"-submenu",class:"dropdown-menu pull-right"});1===n.length&&o.insertAfter(n);for(var i=!1,a=0;a<e.options.length;a++){var s=e.options[a];if(null!==s||!i){var r=t(s);r&&(r.appendTo(o),i=null===s)}}return o},setSelected:i,isSelected:o,toggleSelected:function(e){i(e,!o(e))},setDisabled:function(e,t){t?$("#"+e).parent().addClass("disabled"):$("#"+e).parent().removeClass("disabled")},addItem:function(e,n){var o=t(n);if(n.group){var i=$("#"+e+"-submenu").children(".menu-group-"+n.group);if(0===i.length)o.appendTo("#"+e+"-submenu");else{for(var a=0;a<i.length;a++){var s=i[a],r=$(s).find(".menu-label").html();if(n.label<r){$(s).before(o);break}}a===i.length&&o.appendTo("#"+e+"-submenu")}}else o.appendTo("#"+e+"-submenu")},removeItem:function(e){$("#"+e).parent().remove()},setAction:function(t,n){var o=e[t];o&&(o.onselect=n)}}}(),RED.panels=function(){return{create:function(e){var t=e.container||$("#"+e.id),n=t.children();if(2!==n.length)throw new Error("Container must have exactly two children");t.addClass("red-ui-panels");var o,i,a=[],s=!1;return $('<div class="red-ui-panels-separator"></div>').insertAfter(n[0]).draggable({axis:"y",containment:t,scroll:!1,start:function(e,i){t.height(),o=i.position.top,a=[$(n[0]).height(),$(n[1]).height()]},drag:function(s,r){var d=t.height(),l=r.position.top-o,c=[a[0]+l,a[1]-l];$(n[0]).height(c[0]),$(n[1]).height(c[1]),e.resize&&e.resize(c[0],c[1]),r.position.top-=l,i=c[0]/d},stop:function(e,t){s=!0}}),{resize:function(o){var a=[$(n[0]).height(),$(n[1]).height()];if(t.height(o),s){var r=i*o;a=[r,o-r-48],$(n[0]).height(a[0]),$(n[1]).height(a[1])}e.resize&&e.resize(a[0],a[1])}}}}}(),RED.popover=function(){var e={default:{top:10,leftRight:17,leftLeft:25},small:{top:5,leftRight:8,leftLeft:16}};return{create:function(t){var n=t.target,o=t.direction||"right",i=t.trigger,a=t.content,s=t.delay,r=t.width||"auto",d=t.size||"default";if(!e[d])throw new Error("Invalid RED.popover size value:",d);var l,c,p=null,u=function(){if(l){c=$('<div class="red-ui-popover red-ui-popover-'+o+'"></div>').appendTo("body"),"default"!==d&&c.addClass("red-ui-popover-size-"+d),"function"==typeof a?a.call(h).appendTo(c):c.html(a),"auto"!==r&&c.width(r);var t=n.offset(),i=n.width(),s=n.height(),p=c.height(),u=c.width();"right"===o?c.css({top:t.top+s/2-p/2-e[d].top,left:t.left+i+e[d].leftRight}):"left"===o&&c.css({top:t.top+s/2-p/2-e[d].top,left:t.left-e[d].leftLeft-u}),c.fadeIn("fast")}},f=function(){l||c&&(c.fadeOut("fast",function(){$(this).remove()}),c=null)};"hover"===i?(n.on("mouseenter",function(e){clearTimeout(p),l=!0,p=setTimeout(u,s.show)}),n.on("mouseleave",function(e){p&&clearTimeout(p),l=!1,setTimeout(f,s.hide)})):"click"===i&&n.click(function(e){e.preventDefault(),e.stopPropagation(),(l=!l)?u():f()});var h={setContent:function(e){a=e},open:function(){l=!0,u()},close:function(){l=!1,f()}};return h}}}(),function(e){e.widget("nodered.searchBox",{_create:function(){var t=this;this.currentTimeout=null,this.lastSent="",this.element.val(""),this.uiContainer=this.element.wrap("<div>").parent(),this.uiContainer.addClass("red-ui-searchBox-container"),e('<i class="fa fa-search"></i>').prependTo(this.uiContainer),this.clearButton=e('<a href="#"><i class="fa fa-times"></i></a>').appendTo(this.uiContainer),this.clearButton.on("click",function(e){e.preventDefault(),t.element.val(""),t._change("",!0),t.element.focus()}),this.resultCount=e("<span>",{class:"red-ui-searchBox-resultCount hide"}).appendTo(this.uiContainer),this.element.val(""),this.element.on("keydown",function(e){27===e.keyCode&&t.element.val("")}),this.element.on("keyup",function(n){t._change(e(this).val())}),this.element.on("focus",function(){e("body").one("mousedown",function(){t.element.blur()})})},_change:function(e,t){var n=!1;""===e?(this.clearButton.hide(),n=!0):(this.clearButton.show(),n=e.length>=(this.options.minimumLength||0));var o=this.element.val();if(n=n&&o!==this.lastSent)if(!t&&this.options.delay>0){clearTimeout(this.currentTimeout);var i=this;this.currentTimeout=setTimeout(function(){i.lastSent=i.element.val(),i._trigger("change")},this.options.delay)}else this._trigger("change")},value:function(e){if(void 0===e)return this.element.val();this.element.val(e),this._change(e)},count:function(e){void 0===e||null===e||""===e?this.resultCount.text("").hide():this.resultCount.text(e).show()},change:function(){this._trigger("change")}})}(jQuery),RED.tabs=function(){return{create:function(e){var t,n,o,i={},a=0,s=e.element||$("#"+e.id),r=s.wrap("<div>").parent(),d=s.wrap("<div>").parent();function l(e,t){if(e.preventDefault(),!$(this).hasClass("disabled")){var n=d.scrollLeft();d.animate({scrollLeft:t},100);var o=setInterval(function(){var e=d.scrollLeft();e!==n?(n=e,d.animate({scrollLeft:t},100)):clearInterval(o)},100);$(this).one("mouseup",function(){clearInterval(o)})}}function c(){return e.onclick&&e.onclick(i[$(this).attr("href").slice(1)]),f($(this)),!1}function p(){if(0!==s.children().length){var e=d.scrollLeft(),t=d.width(),i=s.width();0===e?n.hide():n.show(),e===i-t?o.hide():o.show()}}function u(){return e.ondblclick&&e.ondblclick(i[$(this).attr("href").slice(1)]),!1}function f(t){if("string"==typeof t&&(t=s.find("a[href='#"+t+"']")),0!==t.length&&!t.parent().hasClass("active")){if(s.children().removeClass("active"),s.children().css({transition:"width 100ms"}),t.parent().addClass("active"),e.scrollable){var n=t.parent().position().left;n-21<0?d.animate({scrollLeft:"+="+(n-50)},300):n+120>d.width()&&d.animate({scrollLeft:"+="+(n+140-d.width())},300)}e.onchange&&e.onchange(i[t.attr("href").slice(1)]),h(),setTimeout(function(){s.children().css({transition:""})},100)}}function h(){if(!e.vertical){var n=s.find("li.red-ui-tab"),o=r.width(),i=n.size(),d=(o-12-6*i)/i;if(a=(t=100*d/o+"%")+"%",e.scrollable){d=Math.max(d,140),t=d+"px",a=0;var l=Math.max(r.width(),12+(d+6)*i);s.width(l),p()}else e.hasOwnProperty("minimumActiveTabWidth")&&(d<e.minimumActiveTabWidth?(i-=1,d=(o-12-e.minimumActiveTabWidth-6*i)/i,t=100*d/o+"%",a=e.minimumActiveTabWidth+"px"):a=0);n.css({width:t}),d<50?(s.find(".red-ui-tab-close").hide(),s.find(".red-ui-tab-icon").hide(),s.find(".red-ui-tab-label").css({paddingLeft:Math.min(12,Math.max(0,d-38))+"px"})):(s.find(".red-ui-tab-close").show(),s.find(".red-ui-tab-icon").show(),s.find(".red-ui-tab-label").css({paddingLeft:""})),0!==a&&(s.find("li.red-ui-tab.active").css({width:e.minimumActiveTabWidth}),s.find("li.red-ui-tab.active .red-ui-tab-close").show(),s.find("li.red-ui-tab.active .red-ui-tab-icon").show(),s.find("li.red-ui-tab.active .red-ui-tab-label").css({paddingLeft:""}))}}function g(t){var n=s.find("a[href='#"+t+"']").parent();if(n.hasClass("active")){var o=n.prev();0===o.size()&&(o=n.next()),f(o.find("a"))}n.remove(),e.onremove&&e.onremove(i[t]),delete i[t],h()}return r.addClass("red-ui-tabs"),e.vertical&&r.addClass("red-ui-tabs-vertical"),e.addButton&&"function"==typeof e.addButton&&(r.addClass("red-ui-tabs-add"),$('<div class="red-ui-tab-button"><a href="#"><i class="fa fa-plus"></i></a></div>').appendTo(r).find("a").click(function(t){t.preventDefault(),e.addButton()})),e.scrollable&&(r.addClass("red-ui-tabs-scrollable"),d.addClass("red-ui-tabs-scroll-container"),d.scroll(p),(n=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-left"><a href="#" style="display:none;"><i class="fa fa-caret-left"></i></a></div>').appendTo(r).find("a")).on("mousedown",function(e){l(e,"-=150")}).on("click",function(e){e.preventDefault()}),(o=$('<div class="red-ui-tab-button red-ui-tab-scroll red-ui-tab-scroll-right"><a href="#" style="display:none;"><i class="fa fa-caret-right"></i></a></div>').appendTo(r).find("a")).on("mousedown",function(e){l(e,"+=150")}).on("click",function(e){e.preventDefault()})),s.children().first().addClass("active"),s.children().addClass("red-ui-tab"),s.find("li.red-ui-tab a").on("click",c).on("dblclick",u),setTimeout(function(){h()},0),{addTab:function(t){i[t.id]=t;var n=$("<li/>",{class:"red-ui-tab"}).appendTo(s);n.attr("id","red-ui-tab-"+t.id.replace(".","-")),n.data("tabId",t.id);var o=$("<a/>",{href:"#"+t.id,class:"red-ui-tab-label"}).appendTo(n);if(t.icon&&$('<img src="'+t.icon+'" class="red-ui-tab-icon"/>').appendTo(o),$("<span/>",{class:"bidiAware"}).text(t.label).appendTo(o).attr("dir",RED.text.bidi.resolveBaseTextDir(t.label)),o.on("click",c),o.on("dblclick",u),t.closeable){var a=$("<a/>",{href:"#",class:"red-ui-tab-close"}).appendTo(n);a.append('<i class="fa fa-times" />'),a.on("click",function(e){e.preventDefault(),g(t.id)})}if(h(),e.onadd&&e.onadd(t),o.attr("title",t.label),1==s.find("li.red-ui-tab").size()&&f(o),e.onreorder){var r,l,p,v=[];n.draggable({axis:"x",distance:20,start:function(e,t){r=[],v=[],s.children().each(function(e){v[e]={el:$(this),text:$(this).text(),left:$(this).position().left,width:$(this).width()},$(this).is(n)&&(l=e,p=e),r.push($(this).data("tabId"))}),s.children().each(function(e){e!==l&&$(this).css({position:"absolute",left:v[e].left+"px",width:v[e].width+2,transition:"left 0.3s"})}),n.hasClass("active")||n.css({zIndex:1})},drag:function(e,t){t.position.left+=v[l].left+d.scrollLeft();for(var n=t.position.left+v[l].width/2-d.scrollLeft(),o=0;o<v.length;o++)if(o!==l&&n>v[o].left&&n<v[o].left+v[o].width){o<l?(v[o].left+=v[l].width+8,v[l].el.detach().insertBefore(v[o].el)):(v[o].left-=v[l].width+8,v[l].el.detach().insertAfter(v[o].el)),v[o].el.css({left:v[o].left+"px"}),v.splice(o,0,v.splice(l,1)[0]),l=o;break}},stop:function(t,o){s.children().css({position:"relative",left:"",transition:""}),n.hasClass("active")||n.css({zIndex:""}),h(),p!==l&&e.onreorder(r,$.makeArray(s.children().map(function(){return $(this).data("tabId")}))),f(v[l].el.data("tabId"))}})}},removeTab:g,activateTab:f,nextTab:function(){var e=s.find("li.active").next();e.length>0&&f(e.find("a"))},previousTab:function(){var e=s.find("li.active").prev();e.length>0&&f(e.find("a"))},resize:h,count:function(){return s.find("li.red-ui-tab").size()},contains:function(e){return s.find("a[href='#"+e+"']").length>0},renameTab:function(e,t){i[e].label=t;var n=s.find("a[href='#"+e+"']");n.attr("title",t),n.find("span.bidiAware").text(t).attr("dir",RED.text.bidi.resolveBaseTextDir(t)),h()},order:function(e){var t=$.makeArray(s.children().map(function(){return $(this).data("tabId")}));if(t.length===e.length){var n,o=!0;for(n=0;n<e.length;n++)if(e[n]!==t[n]){o=!1;break}if(!o){var i={};for(s.children().detach().each(function(){i[$(this).data("tabId")]=$(this)}),n=0;n<e.length;n++)i[e[n]].appendTo(s)}}}}}}}(),RED.stack=function(){return{create:function(e){var t=e.container,n=[],o=!0;return{add:function(i){n.push(i),i.container=$('<div class="palette-category">').appendTo(t),o||i.container.hide();var a=$('<div class="palette-header"></div>').appendTo(i.container);if(i.content=$("<div></div>").appendTo(i.container),!1!==i.collapsible){a.click(function(){if(e.singleExpanded){if(!i.isExpanded()){for(var t=0;t<n.length;t++)n[t].isExpanded()&&n[t].collapse();i.expand()}}else i.toggle()});var s=$('<i class="fa fa-angle-down"></i>').appendTo(a);i.expanded?s.addClass("expanded"):i.content.hide()}else a.css("cursor","default");return i.title=$("<span></span>").html(i.title).appendTo(a),i.toggle=function(){return i.isExpanded()?(i.collapse(),!1):(i.expand(),!0)},i.expand=function(){if(!i.isExpanded())return i.onexpand&&i.onexpand.call(i),s.addClass("expanded"),i.content.slideDown(200),!0},i.collapse=function(){if(i.isExpanded())return s.removeClass("expanded"),i.content.slideUp(200),!0},i.isExpanded=function(){return s.hasClass("expanded")},i},hide:function(){return o=!1,n.forEach(function(e){e.container.hide()}),this},show:function(){return o=!0,n.forEach(function(e){e.container.show()}),this}}}}}(),function(e){var t={msg:{value:"msg",label:"msg.",validate:RED.utils.validatePropertyExpression},flow:{value:"flow",label:"flow.",validate:RED.utils.validatePropertyExpression},global:{value:"global",label:"global.",validate:RED.utils.validatePropertyExpression},str:{value:"str",label:"string",icon:"red/images/typedInput/az.png"},num:{value:"num",label:"number",icon:"red/images/typedInput/09.png",validate:/^[+-]?[0-9]*\.?[0-9]*([eE][-+]?[0-9]+)?$/},bool:{value:"bool",label:"boolean",icon:"red/images/typedInput/bool.png",options:["true","false"]},json:{value:"json",label:"JSON",icon:"red/images/typedInput/json.png",validate:function(e){try{return JSON.parse(e),!0}catch(e){return!1}},expand:function(){var e=this,t=this.value();try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}RED.editor.editJSON({value:t,complete:function(t){var n=t;try{n=JSON.stringify(JSON.parse(t))}catch(e){}e.value(n)}})}},re:{value:"re",label:"regular expression",icon:"red/images/typedInput/re.png"},date:{value:"date",label:"timestamp",hasValue:!1},jsonata:{value:"jsonata",label:"expression",icon:"red/images/typedInput/expr.png",validate:function(e){try{return jsonata(e),!0}catch(e){return!1}},expand:function(){var e=this;RED.editor.editExpression({value:this.value().replace(/\t/g,"\n"),complete:function(t){e.value(t.replace(/\n/g,"\t"))}})}},bin:{value:"bin",label:"buffer",icon:"red/images/typedInput/bin.png",expand:function(){var e=this;RED.editor.editBuffer({value:this.value(),complete:function(t){e.value(t)}})}}},n=!1;e.widget("nodered.typedInput",{_create:function(){if(!n&&RED&&RED._)for(var o in t)t.hasOwnProperty(o)&&(t[o].label=RED._("typedInput.type."+o,{defaultValue:t[o].label}));n=!0;var i=this;this.disarmClick=!1,this.element.addClass("red-ui-typedInput"),this.uiWidth=this.element.outerWidth(),this.elementDiv=this.element.wrap("<div>").parent().addClass("red-ui-typedInput-input"),this.uiSelect=this.elementDiv.wrap("<div>").parent();var a,s=this.element.attr("style");if(null!==(a=/width\s*:\s*(\d+(%|px))/i.exec(s))?(this.element.css("width","100%"),this.uiSelect.width(a[1]),this.uiWidth=null):this.uiSelect.width(this.uiWidth),["Right","Left"].forEach(function(e){var t=i.element.css("margin"+e);i.uiSelect.css("margin"+e,t),i.element.css("margin"+e,0)}),this.uiSelect.addClass("red-ui-typedInput-container"),this.options.types=this.options.types||Object.keys(t),this.selectTrigger=e('<button tabindex="0"></button>').prependTo(this.uiSelect),e('<i class="fa fa-sort-desc"></i>').appendTo(this.selectTrigger),this.selectLabel=e("<span></span>").appendTo(this.selectTrigger),this.types(this.options.types),this.options.typeField){this.typeField=e(this.options.typeField).hide();var r=this.typeField.val();r&&this.typeMap[r]&&(this.options.default=r)}else this.typeField=e("<input>",{type:"hidden"}).appendTo(this.uiSelect);this.element.on("focus",function(){i.uiSelect.addClass("red-ui-typedInput-focus")}),this.element.on("blur",function(){i.uiSelect.removeClass("red-ui-typedInput-focus")}),this.element.on("change",function(){i.validate()}),this.selectTrigger.click(function(e){e.preventDefault(),i._showTypeMenu()}),this.selectTrigger.on("keydown",function(e){40===e.keyCode&&i._showTypeMenu()}).on("focus",function(){i.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionSelectTrigger=e('<button tabindex="0" class="red-ui-typedInput-option-trigger" style="display:inline-block"><span class="red-ui-typedInput-option-caret"><i class="fa fa-sort-desc"></i></span></button>').appendTo(this.uiSelect),this.optionSelectLabel=e('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.optionSelectTrigger),this.optionSelectTrigger.click(function(e){e.preventDefault(),i._showOptionSelectMenu()}).on("keydown",function(e){40===e.keyCode&&i._showOptionSelectMenu()}).on("blur",function(){i.uiSelect.removeClass("red-ui-typedInput-focus")}).on("focus",function(){i.uiSelect.addClass("red-ui-typedInput-focus")}),this.optionExpandButton=e('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block"><i class="fa fa-ellipsis-h"></i></button>').appendTo(this.uiSelect),this.type(this.options.default||this.typeList[0].value)},_showTypeMenu:function(){this.typeList.length>1?(this._showMenu(this.menu,this.selectTrigger),this.menu.find("[value='"+this.propertyType+"']").focus()):this.element.focus()},_showOptionSelectMenu:function(){if(this.optionMenu){this.optionMenu.css({minWidth:this.optionSelectLabel.width()}),this._showMenu(this.optionMenu,this.optionSelectLabel);var e=this.optionMenu.find("[value='"+this.value()+"']");0===e.length&&(e=this.optionMenu.children(":first")),e.focus()}},_hideMenu:function(t){e(document).off("mousedown.close-property-select"),t.hide(),this.elementDiv.is(":visible")?this.element.focus():this.optionSelectTrigger.is(":visible")?this.optionSelectTrigger.focus():this.selectTrigger.focus()},_createMenu:function(t,n){var o=this,i=e("<div>").addClass("red-ui-typedInput-options");return t.forEach(function(t){"string"==typeof t&&(t={value:t,label:t});var a=e('<a href="#"></a>').attr("value",t.value).appendTo(i);t.label&&a.text(t.label),t.icon?e("<img>",{src:t.icon,style:"margin-right: 4px; height: 18px;"}).prependTo(a):a.css({paddingLeft:"18px"}),a.click(function(e){e.preventDefault(),n(t.value),o._hideMenu(i)})}),i.css({display:"none"}),i.appendTo(document.body),i.on("keydown",function(t){40===t.keyCode?e(this).children(":focus").next().focus():38===t.keyCode?e(this).children(":focus").prev().focus():27===t.keyCode&&o._hideMenu(i)}),i},_showMenu:function(t,n){if(this.disarmClick)this.disarmClick=!1;else{var o=this,i=n.offset(),a=n.height(),s=t.height(),r=a+i.top-3;r+s>e(window).height()&&(r-=r+s-e(window).height()+5),t.css({top:r+"px",left:2+i.left+"px"}),t.slideDown(100),this._delay(function(){o.uiSelect.addClass("red-ui-typedInput-focus"),e(document).on("mousedown.close-property-select",function(i){e(i.target).closest(t).length||o._hideMenu(t),e(i.target).closest(n).length&&(o.disarmClick=!0,i.preventDefault())})})}},_getLabelWidth:function(t){var n=t.outerWidth();if(0===n){var o=e('<div class="red-ui-typedInput-container"></div>').css({position:"absolute",top:0,left:-1e3}).appendTo(document.body);n=t.clone().appendTo(o).outerWidth(),o.remove()}return n},_resize:function(){if(null!==this.uiWidth&&this.uiSelect.width(this.uiWidth),this.typeMap[this.propertyType]&&!1===this.typeMap[this.propertyType].hasValue)this.selectTrigger.addClass("red-ui-typedInput-full-width");else{this.selectTrigger.removeClass("red-ui-typedInput-full-width");var e=this._getLabelWidth(this.selectTrigger);this.elementDiv.css("left",e+"px"),this.optionExpandButton.is(":visible")?this.elementDiv.css("right","22px"):this.elementDiv.css("right","0"),this.optionSelectTrigger&&this.optionSelectTrigger.css({left:e+"px",width:"calc( 100% - "+e+"px )"})}},_destroy:function(){this.menu.remove()},types:function(e){var n=this,o=this.type();this.typeMap={},this.typeList=e.map(function(e){var o;return o="string"==typeof e?t[e]:e,n.typeMap[o.value]=o,o}),this.selectTrigger.toggleClass("disabled",1===this.typeList.length),this.menu&&this.menu.remove(),this.menu=this._createMenu(this.typeList,function(e){n.type(e)}),o&&!this.typeMap.hasOwnProperty(o)&&this.type(this.typeList[0].value)},width:function(e){this.uiWidth=e,this._resize()},value:function(e){if(!arguments.length)return this.element.val();this.typeMap[this.propertyType].options&&(-1===this.typeMap[this.propertyType].options.indexOf(e)&&(e=""),this.optionSelectLabel.text(e)),this.element.val(e),this.element.trigger("change",this.type(),e)},type:function(t){if(!arguments.length)return this.propertyType;var n=this,o=this.typeMap[t];if(o&&this.propertyType!==t){var i;if(this.propertyType=t,this.typeField.val(t),this.selectLabel.empty(),o.icon?((i=new Image).name=o.icon,i.src=o.icon,e("<img>",{src:o.icon,style:"margin-right: 4px;height: 18px;"}).prependTo(this.selectLabel)):this.selectLabel.text(o.label),o.options){if(this.optionExpandButton&&this.optionExpandButton.hide(),this.optionSelectTrigger){this.optionSelectTrigger.show(),this.elementDiv.hide(),this.optionMenu=this._createMenu(o.options,function(e){n.optionSelectLabel.text(e),n.value(e)});var a=this.element.val();-1!==o.options.indexOf(a)?this.optionSelectLabel.text(a):this.value(o.options[0])}}else this.optionMenu&&(this.optionMenu.remove(),this.optionMenu=null),this.optionSelectTrigger&&this.optionSelectTrigger.hide(),!1===o.hasValue?(this.oldValue=this.element.val(),this.element.val(""),this.elementDiv.hide()):(void 0!==this.oldValue&&(this.element.val(this.oldValue),delete this.oldValue),this.elementDiv.show()),o.expand&&"function"==typeof o.expand?(this.optionExpandButton.show(),this.optionExpandButton.off("click"),this.optionExpandButton.on("click",function(e){e.preventDefault(),o.expand.call(n)})):this.optionExpandButton.hide(),this.element.trigger("change",this.propertyType,this.value());i?(i.onload=function(){n._resize()},i.onerror=function(){n._resize()}):this._resize()}},validate:function(){var e,t=this.value(),n=this.type();if(this.typeMap[n]&&this.typeMap[n].validate){var o=this.typeMap[n].validate;e="function"==typeof o?o(t):o.test(t)}else e=!0;return e?this.uiSelect.removeClass("input-error"):this.uiSelect.addClass("input-error"),e},show:function(){this.uiSelect.show(),this._resize()},hide:function(){this.uiSelect.hide()}})}(jQuery),RED.actions=function(){var e={};return{add:function(t,n){e[t]=n},remove:function(t){delete e[t]},get:function(t){return e[t]},invoke:function(t){e.hasOwnProperty(t)&&e[t]()},list:function(){var t=[];return Object.keys(e).forEach(function(e){var n=RED.keyboard.getShortcut(e);t.push({id:e,scope:n?n.scope:void 0,key:n?n.key:void 0,user:n?n.user:void 0})}),t}}}(),RED.deploy=function(){var e={full:{img:"red/images/deploy-full-o.png"},nodes:{img:"red/images/deploy-nodes-o.png"},flows:{img:"red/images/deploy-flows-o.png"}},t={unknown:!1,unusedConfig:!1,invalid:!1},n="full",o=!1,i=null;function a(t){n=t,$("#btn-deploy-icon").attr("src",e[t].img)}function s(e){var t="";if(e.z){var n=RED.nodes.workspace(e.z);t=n?n.label:(n=RED.nodes.subflow(e.z)).name}var o=RED.utils.getNodeLabel(e,e.id);return{tab:t,type:e.type,label:o}}function r(e,t){return e.tab<t.tab?-1:e.tab>t.tab?1:e.type<t.type?-1:e.type>t.type?1:e.name<t.name?-1:e.name>t.name?1:0}function d(e,t){$("#node-dialog-confirm-deploy-config").hide(),$("#node-dialog-confirm-deploy-unknown").hide(),$("#node-dialog-confirm-deploy-unused").hide(),$("#node-dialog-confirm-deploy-conflict").show(),$("#node-dialog-confirm-deploy-type").val(t?"deploy-conflict":"background-conflict"),$("#node-dialog-confirm-deploy").dialog("open")}function l(e,i){if(!$("#btn-deploy").hasClass("disabled")){if(!e){var a,l=!1,c=!1,p=[],u=[];RED.nodes.eachNode(function(e){l=l||!e.valid,e.valid||u.push(s(e)),"unknown"===e.type&&-1==p.indexOf(e.name)&&p.push(e.name)}),a=p.length>0;var f=[];RED.nodes.eachConfig(function(e){0===e.users.length&&!1!==e._def.hasUsers&&(f.push(s(e)),c=!0)}),$("#node-dialog-confirm-deploy-config").hide(),$("#node-dialog-confirm-deploy-unknown").hide(),$("#node-dialog-confirm-deploy-unused").hide(),$("#node-dialog-confirm-deploy-conflict").hide();var h=!1;if(a&&!t.unknown?(h=!0,$("#node-dialog-confirm-deploy-type").val("unknown"),$("#node-dialog-confirm-deploy-unknown").show(),$("#node-dialog-confirm-deploy-unknown-list").html("<li>"+p.join("</li><li>")+"</li>")):l&&!t.invalid?(h=!0,$("#node-dialog-confirm-deploy-type").val("invalid"),$("#node-dialog-confirm-deploy-config").show(),u.sort(r),$("#node-dialog-confirm-deploy-invalid-list").html("<li>"+u.map(function(e){return(e.tab?"["+e.tab+"] ":"")+e.label+" ("+e.type+")"}).join("</li><li>")+"</li>")):c&&t.unusedConfig,h)return $("#node-dialog-confirm-deploy-hide").prop("checked",!1),void $("#node-dialog-confirm-deploy").dialog("open")}var g=RED.nodes.createCompleteNodeSet(),v=Date.now();$(".deploy-button-content").css("opacity",0),$(".deploy-button-spinner").show(),$("#btn-deploy").addClass("disabled");var m={flows:g};i||(m.rev=RED.nodes.version()),o=!0,$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$.ajax({url:"flows",type:"POST",data:JSON.stringify(m),contentType:"application/json; charset=utf-8",headers:{"Node-RED-Deployment-Type":n}}).done(function(e,t,n){RED.nodes.dirty(!1),RED.nodes.version(e.rev),RED.nodes.originalFlow(g),c?RED.notify("<p>"+RED._("deploy.successfulDeploy")+"</p><p>"+RED._("deploy.unusedConfigNodes")+' <a href="#" onclick="RED.sidebar.config.show(true); return false;">'+RED._("deploy.unusedConfigNodesLink")+"</a></p>","success",!1,6e3):RED.notify(RED._("deploy.successfulDeploy"),"success"),RED.nodes.eachNode(function(e){e.changed&&(e.dirty=!0,e.changed=!1),e.moved&&(e.dirty=!0,e.moved=!1),e.credentials&&delete e.credentials}),RED.nodes.eachConfig(function(e){e.changed=!1,e.credentials&&delete e.credentials}),RED.nodes.eachWorkspace(function(e){e.changed=!1}),RED.history.markAllDirty(),RED.view.redraw(),RED.events.emit("deploy")}).fail(function(e,t,n){RED.nodes.dirty(!0),$("#btn-deploy").removeClass("disabled"),401===e.status?RED.notify(RED._("deploy.deployFailed",{message:RED._("user.notAuthorized")}),"error"):409===e.status?d(0,!0):e.responseText?RED.notify(RED._("deploy.deployFailed",{message:e.responseText}),"error"):RED.notify(RED._("deploy.deployFailed",{message:RED._("deploy.errors.noResponse")}),"error")}).always(function(){o=!1;var e=Math.max(0,300-(Date.now()-v));setTimeout(function(){$(".deploy-button-content").css("opacity",1),$(".deploy-button-spinner").hide(),$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide()},e)})}}return{init:function(e){var n,s=(e=e||{}).type||"default";if("default"==s)$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content"><img id="btn-deploy-icon" src="red/images/deploy-full-o.png"> <span>'+RED._("deploy.deploy")+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a><a id="btn-deploy-options" data-toggle="dropdown" class="deploy-button" href="#"><i class="fa fa-caret-down"></i></a></span></li>').prependTo(".header-toolbar"),RED.menu.init({id:"btn-deploy-options",options:[{id:"deploymenu-item-full",toggle:"deploy-type",icon:"red/images/deploy-full.png",label:RED._("deploy.full"),sublabel:RED._("deploy.fullDesc"),selected:!0,onselect:function(e){e&&a("full")}},{id:"deploymenu-item-flow",toggle:"deploy-type",icon:"red/images/deploy-flows.png",label:RED._("deploy.modifiedFlows"),sublabel:RED._("deploy.modifiedFlowsDesc"),onselect:function(e){e&&a("flows")}},{id:"deploymenu-item-node",toggle:"deploy-type",icon:"red/images/deploy-nodes.png",label:RED._("deploy.modifiedNodes"),sublabel:RED._("deploy.modifiedNodesDesc"),onselect:function(e){e&&a("nodes")}}]});else if("simple"==s){var r=e.label||RED._("deploy.deploy"),c="red/images/deploy-full-o.png";e.hasOwnProperty("icon")&&(c=e.icon),$('<li><span class="deploy-button-group button-group"><a id="btn-deploy" class="deploy-button disabled" href="#"><span class="deploy-button-content">'+(c?'<img id="btn-deploy-icon" src="'+c+'"> ':"")+"<span>"+r+'</span></span><span class="deploy-button-spinner hide"><img src="red/images/spin.svg"/></span></a></span></li>').prependTo(".header-toolbar")}$("#btn-deploy").click(function(e){e.preventDefault(),l()}),RED.actions.add("core:deploy-flows",l),$("#node-dialog-confirm-deploy").dialog({title:RED._("deploy.confirm.button.confirm"),modal:!0,autoOpen:!1,width:550,height:"auto",buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"node-dialog-confirm-deploy-review",text:RED._("deploy.confirm.button.review"),class:"primary disabled",click:function(){$("#node-dialog-confirm-deploy-review").hasClass("disabled")||(RED.diff.showRemoteDiff(),$(this).dialog("close"))}},{id:"node-dialog-confirm-deploy-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){RED.diff.mergeDiff(i),$(this).dialog("close")}},{id:"node-dialog-confirm-deploy-deploy",text:RED._("deploy.confirm.button.confirm"),class:"primary",click:function(){$("#node-dialog-confirm-deploy-hide").prop("checked")&&(t[$("#node-dialog-confirm-deploy-type").val()]=!0),l(!0,/conflict/.test($("#node-dialog-confirm-deploy-type").val())),$(this).dialog("close")}},{id:"node-dialog-confirm-deploy-overwrite",text:RED._("deploy.confirm.button.overwrite"),class:"primary",click:function(){l(!0,/conflict/.test($("#node-dialog-confirm-deploy-type").val())),$(this).dialog("close")}}],create:function(){$("#node-dialog-confirm-deploy").parent().find("div.ui-dialog-buttonpane").prepend('<div style="height:0; vertical-align: middle; display:inline-block; margin-top: 13px; float:left;"><input style="vertical-align:top;" type="checkbox" id="node-dialog-confirm-deploy-hide"> <label style="display:inline;" for="node-dialog-confirm-deploy-hide" data-i18n="deploy.confirm.doNotWarn"></label><input type="hidden" id="node-dialog-confirm-deploy-type"></div>')},open:function(){var e=$("#node-dialog-confirm-deploy-type").val();if(/conflict/.test(e)){$("#node-dialog-confirm-deploy").dialog("option","title",RED._("deploy.confirm.button.review")),$("#node-dialog-confirm-deploy-deploy").hide(),$("#node-dialog-confirm-deploy-review").addClass("disabled").show(),$("#node-dialog-confirm-deploy-merge").addClass("disabled").show(),$("#node-dialog-confirm-deploy-overwrite").toggle("deploy-conflict"===e),i=null,$("#node-dialog-confirm-deploy-conflict-checking").show(),$("#node-dialog-confirm-deploy-conflict-auto-merge").hide(),$("#node-dialog-confirm-deploy-conflict-manual-merge").hide();var t=Date.now();RED.diff.getRemoteDiff(function(e){var n=Math.max(1e3-(Date.now()-t),0);i=e,setTimeout(function(){$("#node-dialog-confirm-deploy-conflict-checking").hide(),0===Object.keys(e.conflicts).length?($("#node-dialog-confirm-deploy-conflict-auto-merge").show(),$("#node-dialog-confirm-deploy-merge").removeClass("disabled")):$("#node-dialog-confirm-deploy-conflict-manual-merge").show(),$("#node-dialog-confirm-deploy-review").removeClass("disabled")},n)}),$("#node-dialog-confirm-deploy-hide").parent().hide()}else $("#node-dialog-confirm-deploy").dialog("option","title",RED._("deploy.confirm.button.confirm")),$("#node-dialog-confirm-deploy-deploy").show(),$("#node-dialog-confirm-deploy-overwrite").hide(),$("#node-dialog-confirm-deploy-review").hide(),$("#node-dialog-confirm-deploy-merge").hide(),$("#node-dialog-confirm-deploy-hide").parent().show()}}),RED.events.on("nodes:change",function(e){e.dirty?(window.onbeforeunload=function(){return RED._("deploy.confirm.undeployedChanges")},$("#btn-deploy").removeClass("disabled")):(window.onbeforeunload=null,$("#btn-deploy").addClass("disabled"))}),RED.comms.subscribe("notification/runtime-deploy",function(e,t){if(!n){var i=RED.nodes.version();if(null===i||o||i===t.revision)return;var a=$("<div>"+RED._("deploy.confirm.backgroundUpdate")+'<br><br><div class="ui-dialog-buttonset"><button>'+RED._("deploy.confirm.button.ignore")+'</button><button class="primary">'+RED._("deploy.confirm.button.review")+"</button></div></div>");$(a.find("button")[0]).click(function(e){e.preventDefault(),n.close(),n=null}),$(a.find("button")[1]).click(function(e){e.preventDefault(),n.close(),d(RED.nodes.createCompleteNodeSet(),!1),n=null}),n=RED.notify(a,null,!0)}})}}}(),RED.diff=function(){var e,t={},n=!1;function o(e,t){var n=$("<div>",{class:"node-diff-property-wires"}),o=$("<ol></ol>"),i=0;return e.forEach(function(e,n){var s=$("<li>").appendTo(o);if(e&&e.length>0){$("<span>").html(n+1).appendTo(s);var r=$("<ul>").appendTo(s);e.forEach(function(e){i++;var n=$("<li>").appendTo(r),o=t[e];o?a(o,RED.nodes.getType(o.type)||{}).appendTo(n):n.html(e)})}else s.html("none")}),0===i?n.html("none"):o.appendTo(n),n}function i(e,t){var n=$("<div>",{class:"node-diff-node-entry-node"}),o=t.color,i=RED.utils.getNodeIcon(t,e);"tab"===e.type&&(o="#C0DEED"),n.css("backgroundColor",o);var a=$("<div/>",{class:"palette_icon_container"}).appendTo(n);return $("<div/>",{class:"palette_icon",style:"background-image: url("+i+")"}).appendTo(a),n}function a(e,t){var n=$("<div>",{class:"node-diff-node-entry-title"});i(e,t).appendTo(n);var o=$("<div>",{class:"node-diff-node-description"}).appendTo(n),a=e.label||e.name||e.id;return $("<span>",{class:"node-diff-node-label"}).html(a).appendTo(o),n}function s(e,n){var o=t.localDiff,i=t.remoteDiff,s=t.conflicts[e.id],l=!0;o.added[e.id]&&(n.local.addedCount++,l=!1),i&&i.added[e.id]&&(n.remote.addedCount++,l=!1),o.deleted[e.id]&&(n.local.deletedCount++,l=!1),i&&i.deleted[e.id]&&(n.remote.deletedCount++,l=!1),o.changed[e.id]&&(n.local.changedCount++,!0,l=!1),i&&i.changed[e.id]&&(n.remote.changedCount++,!0,l=!1);var c=RED.nodes.getType(e.type);void 0===c&&(c=/^subflow:/.test(e.type)?{icon:"subflow.png",category:"subflows",color:"#da9",defaults:{name:{value:""}}}:{});var p,u=$("<div>",{class:"node-diff-node-entry collapsed"}),f=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(u),h=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(f),g=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(f);if(i&&(p=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(f)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(h),l)n.local.unchangedCount++,a(e,c).appendTo(h),g.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g),i&&(n.remote.unchangedCount++,p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p)),u.addClass("node-diff-node-unchanged");else if(o.added[e.id])g.addClass("node-diff-node-added"),p&&p.addClass("node-diff-empty"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(g),a(e,c).appendTo(h);else if(i&&i.added[e.id])g.addClass("node-diff-empty"),p.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(p),a(e,c).appendTo(h);else{if(a(e,c).appendTo(h),o.moved[e.id]){var v=o.newConfig.all[e.id];if(o.deleted[e.z]||e.z===v.z||""===e.z||o.newConfig.all[e.z]){g.addClass("node-diff-node-moved");var m="";m=e.z===v.z?RED._("diff.type.movedFrom",{id:o.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:v.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+m+"</span>").appendTo(g)}else g.addClass("node-diff-empty");!0}else o.deleted[e.z]?(g.addClass("node-diff-empty"),!0):o.deleted[e.id]?(g.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(g),!0):o.changed[e.id]?o.newConfig.all[e.id].z!==e.z?g.addClass("node-diff-empty"):(g.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(g),!0):o.newConfig.all[e.id].z!==e.z?g.addClass("node-diff-empty"):(n.local.unchangedCount++,g.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(g));if(i)if(i.moved[e.id]){var b=i.newConfig.all[e.id];if(i.deleted[e.z]||e.z===b.z||""===e.z||i.newConfig.all[e.z]){p.addClass("node-diff-node-moved");var y="";y=e.z===b.z?RED._("diff.type.movedFrom",{id:i.currentConfig.all[e.id].z||"global"}):RED._("diff.type.movedTo",{id:b.z||"global"}),$('<span class="node-diff-status"><i class="fa fa-caret-square-o-right"></i> '+y+"</span>").appendTo(p)}else p.addClass("node-diff-empty")}else i.deleted[e.z]?p.addClass("node-diff-empty"):i.deleted[e.id]?(p.addClass("node-diff-node-deleted"),$('<span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.deleted"></span></span>').appendTo(p)):i.changed[e.id]?i.newConfig.all[e.id].z!==e.z?p.addClass("node-diff-empty"):(p.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(p)):i.newConfig.all[e.id].z!==e.z?p.addClass("node-diff-empty"):(n.remote.unchangedCount++,p.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(p))}var w,D={node:o.newConfig.all[e.id],all:o.newConfig.all,diff:o};i&&(w={node:i.newConfig.all[e.id]||null,all:i.newConfig.all,diff:i}),r(c,e,D,w).appendTo(u);var E="";return s?(n.conflicts++,g.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(g),p.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(p),u.addClass("node-diff-node-entry-conflict")):E=t.resolutions[e.id],d(e,u,g,p,!1,!s,E),f.click(function(e){$(this).parent().toggleClass("collapsed")}),u}function r(e,t,n,i){var a,s={},r=n.node;i&&(a=i.node);var d=$("<div>",{class:"node-diff-node-entry-properties"}),l=$("<table>").appendTo(d),c=$("<colgroup><col/><col/></colgroup>").appendTo(l);void 0!==a&&$("<col/>").appendTo(c);var p,u,f,h,g,v,m,b=$("<tbody>").appendTo(l),y=!1,w=!1,D=!1;p=$("<tr>").appendTo(b),$("<td>",{class:"node-diff-property-cell-label"}).html("id").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(u.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"></span>').appendTo(u),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local.id"]=RED.utils.createObjectElement(r.id).appendTo(h)):u.addClass("node-diff-empty"),void 0!==a&&((f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p)).addClass("node-diff-node-unchanged"),a?($('<span class="node-diff-status"></span>').appendTo(f),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote.id"]=RED.utils.createObjectElement(a.id).appendTo(h)):f.addClass("node-diff-empty")),t.hasOwnProperty("x")&&(r&&(r.x===t.x&&r.y===t.y||(y=!0,0)),a&&(a.x===t.x&&a.y===t.y||(w=!0,0)),(w&&y&&(r.x!==a.x||r.y!==a.y)||!y&&w&&n.diff.deleted[t.id]||y&&!w&&i.diff.deleted[t.id])&&(D=!0),p=$("<tr>").appendTo(b),$("<td>",{class:"node-diff-property-cell-label"}).html("position").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(u.addClass("node-diff-node-"+(y?"changed":"unchanged")),$('<span class="node-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local.position"]=RED.utils.createObjectElement({x:r.x,y:r.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["remote."+e]&&s["remote."+e].prop("expand")(e,t)}}).appendTo(h)):u.addClass("node-diff-empty"),void 0!==a&&((f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p)).addClass("node-diff-node-"+(w?"changed":"unchanged")),a?($('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote.position"]=RED.utils.createObjectElement({x:a.x,y:a.y},{path:"position",exposeApi:!0,ontoggle:function(e,t){s["local."+e]&&s["local."+e].prop("expand")(e,t)}}).appendTo(h)):f.addClass("node-diff-empty"))),y=w=D=!1,t.hasOwnProperty("wires")&&(g=JSON.stringify(t.wires),r&&(v=JSON.stringify(r.wires),g!==v&&(y=!0,0)),a&&(m=JSON.stringify(a.wires),g!==m&&(w=!0,0)),(w&&y&&v!==m||!y&&w&&n.diff.deleted[t.id]||y&&!w&&i.diff.deleted[t.id])&&(D=!0),p=$("<tr>").appendTo(b),$("<td>",{class:"node-diff-property-cell-label"}).html("wires").appendTo(p),u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(D?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(y?"changed":"unchanged")),$('<span class="node-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),o(r.wires,n.all).appendTo(u)):u.addClass("node-diff-empty"),void 0!==a&&(f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p),a?(D?(f.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),o(a.wires,i.all).appendTo(f)):f.addClass("node-diff-empty")));var E=Object.keys(t).filter(function(t){return!("inputLabels"==t||"outputLabels"==t||"z"==t||"wires"==t||"x"===t||"y"===t||"id"===t||"type"===t||e.defaults&&e.defaults.hasOwnProperty(t))});return e.defaults&&(E=E.concat(Object.keys(e.defaults))),"tab"!==t.type&&(E=E.concat(["inputLabels","outputLabels"])),E.forEach(function(e){y=!1,w=!1,D=!1,g=JSON.stringify(t[e]),r&&(v=JSON.stringify(r[e]),g!==v&&(y=!0,0)),a&&(m=JSON.stringify(a[e]),g!==m&&(w=!0,0)),(w&&y&&v!==m||!y&&w&&n.diff.deleted[t.id]||y&&!w&&i.diff.deleted[t.id])&&(D=!0),p=$("<tr>").appendTo(b);$("<td>",{class:"node-diff-property-cell-label"}).html(e).appendTo(p);u=$("<td>",{class:"node-diff-property-cell node-diff-node-local"}).appendTo(p),r?(D?(u.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(u)):(u.addClass("node-diff-node-"+(y?"changed":"unchanged")),$('<span class="node-diff-status">'+(y?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(u)),h=$('<span class="node-diff-element"></span>').appendTo(u),s["local."+e]=RED.utils.createObjectElement(r[e],{path:e,exposeApi:!0,ontoggle:function(t,n){s["remote."+e]&&s["remote."+e].prop("expand")(t,n)}}).appendTo(h)):u.addClass("node-diff-empty"),void 0!==a&&(f=$("<td>",{class:"node-diff-property-cell node-diff-node-remote"}).appendTo(p),a?(D?(f.addClass("node-diff-node-conflict"),$('<span class="node-diff-status"><i class="fa fa-exclamation"></i></span>').appendTo(f)):(f.addClass("node-diff-node-"+(w?"changed":"unchanged")),$('<span class="node-diff-status">'+(w?'<i class="fa fa-square"></i>':"")+"</span>").appendTo(f)),h=$('<span class="node-diff-element"></span>').appendTo(f),s["remote."+e]=RED.utils.createObjectElement(a[e],{path:e,exposeApi:!0,ontoggle:function(t,n){s["local."+e]&&s["local."+e].prop("expand")(t,n)}}).appendTo(h)):f.addClass("node-diff-empty"))}),d}function d(e,t,n,o,i,a,s){var r="node-diff-selectbox-"+e.id.replace(/\./g,"-")+(i?"-props":""),d="";(e.z||i)&&(d="node-diff-selectbox-tab-"+(i?e.id:e.z).replace(/\./g,"-"));var c=!i&&("tab"===e.type||"subflow"===e.type),p=function(n){var o;if(void 0===e.type);else if(c)o="node-diff-selectbox-tab-"+e.id.replace(/\./g,"-"),$("."+o+"-"+this.value).prop("checked",!0),"local"===this.value?($("."+o+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-local"),$("."+o+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-remote")):($("."+o+"-"+this.value).closest(".node-diff-node-entry").removeClass("node-diff-select-local"),$("."+o+"-"+this.value).closest(".node-diff-node-entry").addClass("node-diff-select-remote"));else{var a="node-diff-selectbox-"+(i?e.id:e.z).replace(/\./g,"-");$("#"+a+"-local").prop("checked",!1),$("#"+a+"-remote").prop("checked",!1);var s=$("#"+a+"-local").closest(".node-diff-tab").find(".node-diff-tab-title");s.removeClass("node-diff-select-local"),s.removeClass("node-diff-select-remote")}"local"===this.value?(t.removeClass("node-diff-select-remote"),t.addClass("node-diff-select-local")):"remote"===this.value&&(t.addClass("node-diff-select-remote"),t.removeClass("node-diff-select-local")),l()},u=$("<label>",{class:"node-diff-selectbox",for:r+"-local"}).click(function(e){e.stopPropagation()}).appendTo(n),f=$("<input>",{id:r+"-local",type:"radio",value:"local",name:r,class:d+"-local"+(c?"":" node-diff-select-node")}).data("node-id",e.id).change(p).appendTo(u),h=$("<label>",{class:"node-diff-selectbox",for:r+"-remote"}).click(function(e){e.stopPropagation()}).appendTo(o),g=$("<input>",{id:r+"-remote",type:"radio",value:"remote",name:r,class:d+"-remote"+(c?"":" node-diff-select-node")}).data("node-id",e.id).change(p).appendTo(h);"local"===s?f.prop("checked",!0):"remote"===s&&g.prop("checked",!0),(a||n.hasClass("node-diff-empty")||o.hasClass("node-diff-empty"))&&(u.hide(),h.hide())}function l(){var e=0;$(".node-diff-selectbox>input:checked").each(function(){t.conflicts[$(this).data("node-id")]&&e++,t.resolutions[$(this).data("node-id")]=$(this).val()});var n=Object.keys(t.conflicts).length;n-e==0?$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-check"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-e})):$("#node-diff-toolbar-resolved-conflicts").html('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span> '+RED._("diff.unresolvedCount",{count:n-e})),n===e&&$("#node-diff-view-diff-merge").removeClass("disabled")}function c(e){$.ajax({headers:{Accept:"application/json"},cache:!1,url:"flows",success:function(t){var n=RED.nodes.createCompleteNodeSet(),o=RED.nodes.originalFlow(),i=t.flows,a=f(o,n),s=f(o,i);s.rev=t.rev,e(function(e,t){var n,o,i={},a={},s={localDiff:e,remoteDiff:t,conflicts:i,resolutions:a},r={};for(n in e.currentConfig.all)if(e.currentConfig.all.hasOwnProperty(n)){r[n]=!0;var d=e.newConfig.all[n];if(e.changed[n]&&t.deleted[n])i[n]=!0;else if(e.deleted[n]&&t.changed[n])i[n]=!0;else if(e.changed[n]&&t.changed[n]){var l=t.newConfig.all[n];JSON.stringify(d)!==JSON.stringify(l)&&(i[n]=!0)}i[n]||(t.added[n]||t.changed[n]||t.deleted[n]?a[n]="remote":a[n]="local")}for(n in e.added)e.added.hasOwnProperty(n)&&(o=e.newConfig.all[n],t.deleted[o.z]?i[n]=!0:a[n]="local");for(n in t.added)t.added.hasOwnProperty(n)&&(o=t.newConfig.all[n],e.deleted[o.z]?i[n]=!0:a[n]="remote");return s}(a,s))}})}function p(o){void 0===o?c(p):function(o){if(n)return;var a=o.localDiff,c=o.remoteDiff,p=o.conflicts;t=o;var u={title:"Review Changes",width:1/0,buttons:[{text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-diff-view-diff-merge",text:RED._("deploy.confirm.button.merge"),class:"primary disabled",click:function(){$("#node-diff-view-diff-merge").hasClass("disabled")||(l(),h(t),RED.tray.close())}}],resize:function(e){},open:function(n){var o,u,f=n.find(".editor-tray-body"),h=(o=f,u=$('<div id="node-dialog-view-diff"><div id="node-dialog-view-diff-headers"></div><ol id="node-dialog-view-diff-diff"></ol></div>').appendTo(o),$('<div class="node-diff-toolbar"><span><span id="node-diff-toolbar-resolved-conflicts"></span></span> </div>').prependTo(u),e=u.find("#node-dialog-view-diff-diff").editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,n,o){var a=o.diff,l=o.remoteDiff,c=o.tab.n,p=o.def,u=t.conflicts,f=$("<div>",{class:"node-diff-tab"}).appendTo(e);f.addClass("collapsed");var h,g,v=$("<div>",{class:"node-diff-tab-title"}).appendTo(f),m=$("<div>").appendTo(f),b=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(v),y=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(v);l&&(h=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(v)),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(b),i(c,p).appendTo(b);var w=(o.newTab||o.tab).n,D=$("<span>",{class:"node-diff-tab-title-meta"}).appendTo(b);"tab"===w.type?D.html(w.label||w.id):"subflow"===c.type?D.html(w.name||w.id):D.html(RED._("diff.globalNodes"));var E={local:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},remote:{addedCount:0,deletedCount:0,changedCount:0,unchangedCount:0},conflicts:0};if(o.newTab||o.remoteTab){var R,k={node:a.newConfig.all[c.id],all:a.newConfig.all,diff:a};if(l&&(R={node:l.newConfig.all[c.id]||null,all:l.newConfig.all,diff:l}),void 0!==c.type){var x,_=$("<div>",{class:"node-diff-node-entry node-diff-node-props collapsed"}).appendTo(m),T=$("<div>",{class:"node-diff-node-entry-header"}).appendTo(_),C=$("<div>",{class:"node-diff-node-entry-cell"}).appendTo(T),O=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-local"}).appendTo(T);a.newConfig.all[c.id]?a.added[c.id]?(O.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(O)):a.changed[c.id]?(O.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(O)):(O.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(O)):O.addClass("node-diff-empty"),l&&(x=$("<div>",{class:"node-diff-node-entry-cell node-diff-node-remote"}).appendTo(T),l.newConfig.all[c.id]?l.added[c.id]?(x.addClass("node-diff-node-added"),$('<span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.added"></span></span>').appendTo(x)):l.changed[c.id]?(x.addClass("node-diff-node-changed"),$('<span class="node-diff-status"><i class="fa fa-square"></i> <span data-i18n="diff.type.changed"></span></span>').appendTo(x)):(x.addClass("node-diff-node-unchanged"),$('<span class="node-diff-status"><i class="fa fa-square-o"></i> <span data-i18n="diff.type.unchanged"></span></span>').appendTo(x)):(x.addClass("node-diff-empty"),l.deleted[c.id])),$('<span class="node-diff-chevron"><i class="fa fa-angle-down"></i></span>').appendTo(C),$("<span>").html(RED._("diff.flowProperties")).appendTo(C),T.click(function(e){e.preventDefault(),$(this).parent().toggleClass("collapsed")}),r(p,c,k,R).appendTo(_),g="",u[c.id]?(E.conflicts++,O.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(O),x.hasClass("node-diff-empty")||$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i></span></span>').prependTo(x),_.addClass("node-diff-node-entry-conflict")):g=t.resolutions[c.id],d(c,_,O,x,!0,!u[c.id],g)}}var S=0,L=0,N={};if(o.tab.nodes.forEach(function(e){N[e.id]=!0,s(e,E).appendTo(m)}),o.newTab&&(S=o.newTab.nodes.length,o.newTab.nodes.forEach(function(e){N[e.id]||(N[e.id]=!0,s(e,E).appendTo(m))})),o.remoteTab&&(L=o.remoteTab.nodes.length,o.remoteTab.nodes.forEach(function(e){N[e.id]||s(e,E).appendTo(m)})),v.click(function(e){v.parent().toggleClass("collapsed"),$(this).parent().hasClass("collapsed")&&($(this).parent().find(".node-diff-node-entry").addClass("collapsed"),$(this).parent().find(".debug-message-element").addClass("collapsed"))}),a.deleted[c.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(y);else if(o.newTab)if(a.added[c.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(y);else{c.id&&(a.changed[c.id]?E.local.changedCount++:E.local.unchangedCount++);var P=$("<span>",{class:"node-diff-tab-stats"}).appendTo(y);$('<span class="node-diff-status"></span>').html(RED._("diff.nodeCount",{count:S})).appendTo(P),E.conflicts+E.local.addedCount+E.local.changedCount+E.local.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(P),E.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+E.conflicts+"</span></span>").appendTo(P),E.local.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+E.local.addedCount+"</span></span>").appendTo(P),E.local.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+E.local.changedCount+"</span></span>").appendTo(P),E.local.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+E.local.deletedCount+"</span></span>").appendTo(P),$('<span class="node-diff-status"> ] </span>').appendTo(P))}else y.addClass("node-diff-empty");if(l){if(l.deleted[c.id])$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> <span data-i18n="diff.type.flowDeleted"></span></span></span>').appendTo(h);else if(o.remoteTab)if(l.added[c.id])$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> <span data-i18n="diff.type.flowAdded"></span></span></span>').appendTo(h);else{c.id&&(l.changed[c.id]?E.remote.changedCount++:E.remote.unchangedCount++);var I=$("<span>",{class:"node-diff-tab-stats"}).appendTo(h);$('<span class="node-diff-status"></span>').html(RED._("diff.nodeCount",{count:L})).appendTo(I),E.conflicts+E.remote.addedCount+E.remote.changedCount+E.remote.deletedCount>0&&($('<span class="node-diff-status"> [ </span>').appendTo(I),E.conflicts>0&&$('<span class="node-diff-node-conflict"><span class="node-diff-status"><i class="fa fa-exclamation"></i> '+E.conflicts+"</span></span>").appendTo(I),E.remote.addedCount>0&&$('<span class="node-diff-node-added"><span class="node-diff-status"><i class="fa fa-plus-square"></i> '+E.remote.addedCount+"</span></span>").appendTo(I),E.remote.changedCount>0&&$('<span class="node-diff-node-changed"><span class="node-diff-status"><i class="fa fa-square"></i> '+E.remote.changedCount+"</span></span>").appendTo(I),E.remote.deletedCount>0&&$('<span class="node-diff-node-deleted"><span class="node-diff-status"><i class="fa fa-minus-square"></i> '+E.remote.deletedCount+"</span></span>").appendTo(I),$('<span class="node-diff-status"> ] </span>').appendTo(I))}else h.addClass("node-diff-empty");if(g="",E.conflicts>0?v.addClass("node-diff-node-entry-conflict"):g=t.resolutions[c.id],c.id){var z=!(E.conflicts>0&&(a.deleted[c.id]||l.deleted[c.id]));d(c,v,y,h,!1,z,g)}}0===f.find(".node-diff-node-entry").length&&f.addClass("node-diff-tab-empty"),e.i18n()}}),u);c?($("#node-diff-view-diff-merge").show(),0===Object.keys(p).length?$("#node-diff-view-diff-merge").removeClass("disabled"):$("#node-diff-view-diff-merge").addClass("disabled")):$("#node-diff-view-diff-merge").hide(),l(),$("#node-dialog-view-diff-headers").empty();var g=a.currentConfig,v=a.newConfig;p=p||{};var m={diff:a,def:{category:"config",color:"#f0f0f0"},tab:{n:{},nodes:g.globals},newTab:{n:{},nodes:v.globals}};void 0!==c?(h.addClass("node-diff-three-way"),$('<div data-i18n="diff.local"></div><div data-i18n="diff.remote"></div>').i18n().appendTo("#node-dialog-view-diff-headers"),m.remoteTab={n:{},nodes:c.newConfig.globals},m.remoteDiff=c):h.removeClass("node-diff-three-way"),e.editableList("addItem",m);var b,y={};g.tabOrder.forEach(function(t){var n=g.tabs[t],o={diff:a,def:RED.nodes.getType("tab"),tab:n};v.tabs.hasOwnProperty(t)&&(o.newTab=v.tabs[t]),void 0!==c&&(o.remoteTab=c.newConfig.tabs[t],o.remoteDiff=c),y[t]=!0,e.editableList("addItem",o)}),v.tabOrder.forEach(function(t){if(!y[t]){y[t]=!0;var n=v.tabs[t],o={diff:a,def:RED.nodes.getType("tab"),tab:n,newTab:n};void 0!==c&&(o.remoteDiff=c),e.editableList("addItem",o)}}),void 0!==c&&c.newConfig.tabOrder.forEach(function(t){if(!y[t]){var n=c.newConfig.tabs[t],o={diff:a,remoteDiff:c,def:RED.nodes.getType("tab"),tab:n,remoteTab:n};e.editableList("addItem",o)}});for(b in g.subflows)g.subflows.hasOwnProperty(b)&&(y[b]=!0,m={diff:a,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:g.subflows[b]},v.subflows.hasOwnProperty(b)&&(m.newTab=v.subflows[b]),void 0!==c&&(m.remoteTab=c.newConfig.subflows[b],m.remoteDiff=c),e.editableList("addItem",m));for(b in v.subflows)v.subflows.hasOwnProperty(b)&&!y[b]&&(y[b]=!0,m={diff:a,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:v.subflows[b],newTab:v.subflows[b]},void 0!==c&&(m.remoteDiff=c),e.editableList("addItem",m));if(void 0!==c)for(b in c.newConfig.subflows)c.newConfig.subflows.hasOwnProperty(b)&&!y[b]&&(m={diff:a,remoteDiff:c,def:{defaults:{},icon:"subflow.png",category:"subflows",color:"#da9"},tab:c.newConfig.subflows[b],remoteTab:c.newConfig.subflows[b]},e.editableList("addItem",m));$("#sidebar-shade").show()},close:function(){n=!1,$("#sidebar-shade").hide()},show:function(){}};RED.tray.show(u)}(o)}function u(e){var t=[],n={},o={},i=[],a={};return e.forEach(function(e){a[e.id]=e,"tab"===e.type?(t.push(e.id),n[e.id]={n:e,nodes:[]}):"subflow"===e.type&&(o[e.id]={n:e,nodes:[]})}),e.forEach(function(e){"tab"!==e.type&&"subflow"!==e.type&&(n[e.z]?n[e.z].nodes.push(e):o[e.z]?o[e.z].nodes.push(e):i.push(e))}),{all:a,tabOrder:t,tabs:n,subflows:o,globals:i}}function f(e,t){var n=u(e),o=u(t),i={},a={},s={},r={};return Object.keys(n.all).forEach(function(e){RED.nodes.workspace(e)||RED.nodes.subflow(e)||RED.nodes.node(e);o.all.hasOwnProperty(e)?JSON.stringify(n.all[e])!==JSON.stringify(o.all[e])&&(s[e]=!0,n.all[e].z!==o.all[e].z&&(r[e]=!0)):a[e]=!0}),Object.keys(o.all).forEach(function(e){n.all.hasOwnProperty(e)||(i[e]=!0)}),{currentConfig:n,newConfig:o,added:i,deleted:a,changed:s,moved:r}}function h(e){e.localDiff.currentConfig;var t,n=e.localDiff,o=e.remoteDiff,i=e.conflicts,a=e.resolutions;for(t in i)if(i.hasOwnProperty(t)&&!a.hasOwnProperty(t))throw console.log(e),new Error("No resolution for conflict on node",t);var s,r=[],d={},l={};for(t in n.newConfig.all)n.newConfig.all.hasOwnProperty(t)&&(s=RED.nodes.node(t),"local"===a[t]?(s&&(d[t]=s.changed),r.push(n.newConfig.all[t])):"remote"===a[t]?!o.deleted[t]&&o.newConfig.all.hasOwnProperty(t)&&(s&&(d[t]=s.changed),l[t]=!0,r.push(o.newConfig.all[t])):console.log("Unresolved",t));for(t in o.added)o.added.hasOwnProperty(t)&&((s=RED.nodes.node(t))&&(d[t]=s.changed),n.added.hasOwnProperty(t)||(l[t]=!0,r.push(o.newConfig.all[t])));var c={t:"replace",config:RED.nodes.createCompleteNodeSet(),changed:d,dirty:RED.nodes.dirty(),rev:RED.nodes.version()};RED.history.push(c),RED.nodes.clear(),RED.nodes.import(r)[0].forEach(function(e){(d[e.id]||l[e.id])&&(e.changed=!0)}),RED.nodes.version(o.rev),RED.view.redraw(!0),RED.palette.refresh(),RED.workspaces.refresh(),RED.sidebar.config.refresh()}return{init:function(){RED.actions.add("core:show-remote-diff",p),RED.keyboard.add("*","ctrl-shift-r","core:show-remote-diff")},getRemoteDiff:c,showRemoteDiff:p,mergeDiff:h}}(),RED.keyboard=function(){var e,t=/Mac/i.test(window.navigator.platform),n={},o={left:37,up:38,right:39,down:40,escape:27,enter:13,backspace:8,delete:46,space:32,";":186,"=":187,",":188,"-":189,".":190,"/":191,"\\":220,"'":222,"?":191},a={16:!0,17:!0,18:!0,91:!0,93:!0},s={},r={},d={59:186,61:187,173:189};function l(e){for(var t,n=e.toLowerCase().split("-"),i={},a=0;a<n.length;a++)switch(n[a]){case"ctrl":case"cmd":i.ctrl=!0,i.meta=!0;break;case"alt":i.alt=!0;break;case"shift":i.shift=!0;break;case"":0,t=o["-"];break;default:if(o.hasOwnProperty(n[a]))t=o[n[a]];else{if(n[a].length>1)return null;t=n[a].toUpperCase().charCodeAt(0)}}return[t,i]}function c(e,t,o,i){var a=o,r=i;"function"!=typeof o&&"string"!=typeof o||(a={},r=o);var d=[],c=0;if("string"==typeof t){"string"==typeof r&&(s[r]={scope:e,key:t},"boolean"==typeof i&&(s[r].user=i));var p=t.split(" ");for(c=0;c<p.length;c++){var u=l(p[c]);if(!u)return;d.push(u)}}else d.push([t,a]);var f=n;for(c=0;c<d.length;c++)t=d[c][0],(a=d[c][1]).ctrl&&(f.ctrl=f.ctrl||{},f=f.ctrl),a.shift&&(f.shift=f.shift||{},f=f.shift),a.alt&&(f.alt=f.alt||{},f=f.alt),f[t]=f[t]||{},f=f[t];f.scope=e,f.ondown=r}function p(e,t){var o=t||{},i=[],a=0;if("string"==typeof e){var r=e.split(" ");for(a=0;a<r.length;a++){var d=l(r[a]);if(!d)return void console.log("Unrecognised key specifier:",e);i.push(d)}}else i.push([e,o]);var c=n;for(a=0;a<i.length;a++){if(e=i[a][0],(o=i[a][1]).ctrl&&(c=c.ctrl),c&&o.shift&&(c=c.shift),c&&o.alt&&(c=c.alt),!c[e])return;c=c[e]}"string"==typeof c.ondown&&("boolean"==typeof t&&t?s[c.ondown]={user:t}:delete s[c.ondown]),delete c.scope,delete c.ondown}d3.select(window).on("keydown",function(){if(!a[d3.event.keyCode]){var t=function t(o){var i=e||n;(o.ctrlKey||o.metaKey)&&(i=i.ctrl),i&&o.shiftKey&&(i=i.shift),i&&o.altKey&&(i=i.alt);var a=d[o.keyCode]||o.keyCode;if(i&&i[a]){var s=i[a];if(!s.scope)return e?(e=null,t(o)):Object.keys(s).length>0?(e=s,o.preventDefault(),null):null;if(s.scope&&"*"!==s.scope){for(var r=o.target;"BODY"!==r.nodeName&&r.id!==s.scope;)r=r.parentElement;"BODY"===r.nodeName&&(s=null)}return e=null,s}if(e)return e=null,t(o)}(d3.event);t&&t.ondown&&("string"==typeof t.ondown?RED.actions.invoke(t.ondown):t.ondown(),d3.event.preventDefault())}});function u(e){e.preventDefault();var t=$(this),n=t.data("data");if(!t.hasClass("keyboard-shortcut-entry-expanded")){f();var o=t.find(".keyboard-shortcut-entry-key"),i=t.find(".keyboard-shortcut-entry-scope");t.addClass("keyboard-shortcut-entry-expanded");var a=$('<input type="text">').attr("placeholder",RED._("keyboard.unassigned")).val(n.key||"").appendTo(o);a.on("keyup",function(e){if(13===e.keyCode)return f();var t=$(this).val(),n=""===(t=t.trim())||RED.keyboard.validateKey(t);$(this).toggleClass("input-error",!n)});var s=$('<select><option value="*" data-i18n="keyboard.global"></option><option value="workspace" data-i18n="keyboard.workspace"></option></select>').appendTo(i);s.i18n(),s.val(n.scope||"*");var r=$('<div class="keyboard-shortcut-edit button-group-vertical"></div>').appendTo(i),d=$('<button class="editor-button editor-button-small"><i class="fa fa-check"></i></button>').appendTo(r),l=$('<button class="editor-button editor-button-small"><i class="fa fa-reply"></i></button>').appendTo(r);d.click(function(e){e.stopPropagation(),f()}),l.click(function(e){e.stopPropagation(),RED.keyboard.revertToDefault(n.id),t.empty(),t.removeClass("keyboard-shortcut-entry-expanded");var o=RED.keyboard.getShortcut(n.id),i=RED.settings.get("keymap")||{};delete i[n.id],RED.settings.set("keymap",i);var a={id:n.id,scope:o?o.scope:void 0,key:o?o.key:void 0,user:o?o.user:void 0};h(t,a)}),a.focus()}}function f(e){var t=$(".keyboard-shortcut-entry-expanded");if(1===t.length){var n=t.data("data"),o=t.find(".keyboard-shortcut-entry-key input"),i=t.find(".keyboard-shortcut-entry-scope select");if(!e){var a=o.val().trim(),s=i.val();if(""===a||RED.keyboard.validateKey(a)){var r=RED.keyboard.getShortcut(n.id);if(!r&&a||r&&(r.scope!==s||r.key!==a)){var d=t.find(".keyboard-shortcut-entry-key"),l=t.find(".keyboard-shortcut-entry-scope");d.empty(),l.empty(),n.key&&RED.keyboard.remove(n.key,!0),t.find(".keyboard-shortcut-entry-text i").css("opacity",1),""===a?(d.parent().addClass("keyboard-shortcut-entry-unassigned"),d.append($("<span>").text(RED._("keyboard.unassigned"))),delete n.key,delete n.scope):(d.parent().removeClass("keyboard-shortcut-entry-unassigned"),d.append(RED.keyboard.formatKey(a)),$("<span>").text(s).appendTo(l),n.key=a,n.scope=s,RED.keyboard.add(n.scope,n.key,n.id,!0));var c=RED.settings.get("keymap")||{};c[n.id]=RED.keyboard.getShortcut(n.id),RED.settings.set("keymap",c)}}}o.remove(),i.remove(),$(".keyboard-shortcut-edit").remove(),t.removeClass("keyboard-shortcut-entry-expanded")}}function h(e,t){var n=$('<div class="keyboard-shortcut-entry">').appendTo(e);e.data("data",t);var o=t.id.replace(/(^.+:([a-z]))|(-([a-z]))/g,function(){return 0===arguments[5]?arguments[2].toUpperCase():" "+arguments[4].toUpperCase()}),i=$("<div>").addClass("keyboard-shortcut-entry-text").text(o).appendTo(n),a=$('<i class="fa fa-user"></i>').prependTo(i);t.user||a.css("opacity",0);var s=$('<div class="keyboard-shortcut-entry-key">').appendTo(n);t.key?s.append(RED.keyboard.formatKey(t.key)):(n.addClass("keyboard-shortcut-entry-unassigned"),s.append($("<span>").text(RED._("keyboard.unassigned"))));var r=$('<div class="keyboard-shortcut-entry-scope">').appendTo(n);$("<span>").text("*"===t.scope?"global":t.scope||"").appendTo(r),e.click(u)}function g(){var e=$('<div id="user-settings-tab-keyboard"></div>');$('<div class="keyboard-shortcut-entry keyboard-shortcut-list-header"><div class="keyboard-shortcut-entry-key keyboard-shortcut-entry-text"><input id="user-settings-tab-keyboard-filter" type="text" data-i18n="[placeholder]keyboard.filterActions"></div><div class="keyboard-shortcut-entry-key" data-i18n="keyboard.shortcut"></div><div class="keyboard-shortcut-entry-scope" data-i18n="keyboard.scope"></div></div>').appendTo(e),e.find("input").searchBox({delay:100,change:function(){var e=$(this).val().trim();""===e?t.editableList("filter",null):(e=e.replace(/\s/g,""),t.editableList("filter",function(t){return t.id.toLowerCase().replace(/^.*:/,"").replace("-","").indexOf(e)>-1}))}});var t=$('<ol class="keyboard-shortcut-list"></ol>').css({position:"absolute",top:"32px",bottom:"0",left:"0",right:"0"}).appendTo(e).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){h(e,n)}}),n=RED.actions.list();return n.sort(function(e,t){var n=e.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase(),o=t.id.replace(/^.*:/,"").replace(/[ -]/g,"").toLowerCase();return n.localeCompare(o)}),n.forEach(function(e){t.editableList("addItem",e)}),e}return{init:function(){var e=RED.settings.get("keymap")||{};$.getJSON("red/keymap.json",function(t){for(var n in t)if(t.hasOwnProperty(n)){var o=t[n];for(var i in o)o.hasOwnProperty(i)&&(e.hasOwnProperty(o[i])||(c(n,i,o[i],!1),r[o[i]]={scope:n,key:i,user:!1}))}for(var a in e)if(e.hasOwnProperty(a)){var s=e[a];s.hasOwnProperty("key")&&c(s.scope,s.key,a,!0)}}),RED.userSettings.add({id:"keyboard",title:RED._("keyboard.keyboard"),get:g,focus:function(){setTimeout(function(){$("#user-settings-tab-keyboard-filter").focus()},200)}})},add:c,remove:p,getShortcut:function(e){return s[e]},revertToDefault:function(e){var t=s[e];if(t&&p(t.key),r.hasOwnProperty(e)){var n=r[e];c(n.scope,n.key,e,!1)}},formatKey:function(e){var n=t?e.replace(/ctrl-?/,"&#8984;"):e;return'<span class="help-key-block"><span class="help-key">'+(n=(n=(n=(n=(n=(n=t?n.replace(/alt-?/,"&#8997;"):e).replace(/shift-?/,"&#8679;")).replace(/left/,"&#x2190;")).replace(/up/,"&#x2191;")).replace(/right/,"&#x2192;")).replace(/down/,"&#x2193;")).split(" ").join('</span> <span class="help-key">')+"</span></span>"},validateKey:function(e){var t=(e=e.trim()).split(" ");for(i=0;i<t.length;i++)if(!l(t[i]))return!1;return!0}}}(),RED.workspaces=function(){var e,t=0,n=0;function o(t,o){if(t)e.addTab(t),e.resize();else{var i=RED.nodes.id();do{n+=1}while(0!==$("#workspace-tabs a[title='"+RED._("workspace.defaultName",{number:n})+"']").size());t={type:"tab",id:i,disabled:!1,info:"",label:RED._("workspace.defaultName",{number:n})},RED.nodes.addWorkspace(t),e.addTab(t),e.activateTab(i),o||(RED.history.push({t:"add",workspaces:[t],dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0))}return RED.view.focus(),t}function i(t){if(1!=e.count()){r(t);var n=RED.nodes.removeWorkspace(t.id);n.t="delete",n.dirty=RED.nodes.dirty(),n.workspaces=[t],RED.history.push(n),RED.nodes.dirty(!0),RED.sidebar.config.refresh()}}function a(t){var n,o=RED.nodes.workspace(t);RED.view.state(RED.state.EDITING);var a={title:RED._("workspace.editFlow",{name:o.label}),buttons:[{id:"node-dialog-delete",class:"leftButton"+(1==e.count()?" disabled":""),text:RED._("common.label.delete"),click:function(){i(o),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var t=$("#node-input-name").val(),i=!1,a={};o.label!=t&&(a.label=o.label,i=!0,o.label=t,e.renameTab(o.id,t));var s=$("#node-input-disabled").prop("checked");o.disabled!==s&&(a.disabled=o.disabled,i=!0,o.disabled=s);var r=n.getValue();if(o.info!==r&&(a.info=o.info,i=!0,o.info=r),$("#red-ui-tab-"+o.id.replace(".","-")).toggleClass("workspace-disabled",o.disabled),i){var d={t:"edit",changes:a,node:o,dirty:RED.nodes.dirty()};o.changed=!0,RED.history.push(d),RED.nodes.dirty(!0),RED.sidebar.config.refresh();var l=RED.view.selection();l.nodes||l.links||RED.sidebar.info.refresh(o)}RED.tray.close()}}],resize:function(e){for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<t.size();i++)o-=$(t[i]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),o-=28,$(".node-text-editor").css("height",o+"px"),n.resize()},open:function(e){var t=e.find(".editor-tray-body"),i=$('<form id="dialog-form" class="form-horizontal"></form>').appendTo(t);$('<div class="form-row"><label for="node-input-name" data-i18n="[append]editor:common.label.name"><i class="fa fa-tag"></i> </label><input type="text" id="node-input-name"></div>').appendTo(i),$('<div class="form-row"><label for="node-input-disabled-btn" data-i18n="editor:workspace.status"></label><button id="node-input-disabled-btn" class="editor-button"><i class="fa fa-toggle-on"></i> <span id="node-input-disabled-label"></span></button> <input type="checkbox" id="node-input-disabled" style="display: none;"/></div>').appendTo(i),$('<div class="form-row node-text-editor-row"><label for="node-input-info" data-i18n="editor:workspace.info" style="width:300px;"></label><div style="height:250px;" class="node-text-editor" id="node-input-info"></div></div>').appendTo(i),n=RED.editor.createEditor({id:"node-input-info",mode:"ace/mode/markdown",value:""}),$('<div class="form-tips" data-i18n="editor:workspace.tip"></div>').appendTo(i),i.find("#node-input-disabled-btn").on("click",function(e){var t=$(this).find("i");t.hasClass("fa-toggle-off")?(t.addClass("fa-toggle-on"),t.removeClass("fa-toggle-off"),$("#node-input-disabled").prop("checked",!1),$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))):(t.addClass("fa-toggle-off"),t.removeClass("fa-toggle-on"),$("#node-input-disabled").prop("checked",!0),$("#node-input-disabled-label").html(RED._("editor:workspace.disabled")))}),o.hasOwnProperty("disabled")?($("#node-input-disabled").prop("checked",o.disabled),o.disabled?(i.find("#node-input-disabled-btn i").removeClass("fa-toggle-on").addClass("fa-toggle-off"),$("#node-input-disabled-label").html(RED._("editor:workspace.disabled"))):$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))):(o.disabled=!1,$("#node-input-disabled-label").html(RED._("editor:workspace.enabled"))),$('<input type="text" style="display: none;" />').prependTo(i),i.submit(function(e){e.preventDefault()}),$("#node-input-name").val(o.label),RED.text.bidi.prepareInput($("#node-input-name")),n.getSession().setValue(o.info||"",-1),i.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(o),n.destroy()}};RED.tray.show(a)}function s(e){a(e||t)}function r(n){n?e.contains(n.id)&&e.removeTab(n.id):i(RED.nodes.workspace(t))}function d(t){RED.nodes.setWorkspaceOrder(t.filter(function(e){return void 0!==RED.nodes.workspace(e)})),e.order(t)}return{init:function(){e=RED.tabs.create({id:"workspace-tabs",onchange:function(e){var n={old:t};t=e.id,n.workspace=t,RED.events.emit("workspace:change",n),window.location.hash="flow/"+e.id,RED.sidebar.config.refresh(),RED.view.focus()},onclick:function(e){RED.view.focus()},ondblclick:function(e){"subflow"!=e.type?a(e.id):RED.editor.editSubflow(RED.nodes.subflow(e.id))},onadd:function(t){$('<span class="workspace-disabled-icon"><i class="fa fa-ban"></i> </span>').prependTo("#red-ui-tab-"+t.id.replace(".","-")+" .red-ui-tab-label"),t.disabled&&$("#red-ui-tab-"+t.id.replace(".","-")).addClass("workspace-disabled"),RED.menu.setDisabled("menu-item-workspace-delete",1==e.count())},onremove:function(t){RED.menu.setDisabled("menu-item-workspace-delete",1==e.count())},onreorder:function(e,t){RED.history.push({t:"reorder",order:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0),d(t)},minimumActiveTabWidth:150,scrollable:!0,addButton:function(){o()}}),RED.events.on("sidebar:resize",e.resize),RED.actions.add("core:show-next-tab",e.nextTab),RED.actions.add("core:show-previous-tab",e.previousTab),RED.menu.setAction("menu-item-workspace-delete",function(){i(RED.nodes.workspace(t))}),$(window).resize(function(){e.resize()}),RED.actions.add("core:add-flow",o),RED.actions.add("core:edit-flow",s),RED.actions.add("core:remove-flow",r)},add:o,remove:r,order:d,edit:s,contains:function(t){return e.contains(t)},count:function(){return e.count()},active:function(){return t},show:function(t){if(!e.contains(t)){var n=RED.nodes.subflow(t);if(!n)return;o({type:"subflow",id:t,icon:"red/images/subflow_tab.png",label:n.name,closeable:!0})}e.activateTab(t)},refresh:function(){RED.nodes.eachWorkspace(function(t){e.renameTab(t.id,t.label)}),RED.nodes.eachSubflow(function(t){e.contains(t.id)&&e.renameTab(t.id,t.name)}),RED.sidebar.config.refresh()},resize:function(){e.resize()}}}(),RED.view=function(){var e,t,n=5e3,o=5e3,i=.75,a=1,s=100,r=30,d=1e3,l=0,c=[],p=0,u={},f=20,h=!1,g=!1,v=null,m=[],b=[],y=[],w=null,D=null,E=null,R=null,k=0,x=null,_=[0,0],T=null,C=0,O=[],S=null,L=!1,N=null,P=null,I=0,z=0,A="",M={red:"#c00",green:"#5a8",yellow:"#F9DF31",blue:"#53A3F3",grey:"#d3d3d3"},j=1,B=0,J=d3.select("#chart").append("svg:svg").attr("width",n).attr("height",o).attr("pointer-events","all").style("cursor","crosshair").on("mousedown",function(){Ce()}),G=J.append("svg:g").on("dblclick.zoom",null).append("svg:g").attr("class","innerCanvas").on("mousemove",Q).on("mousedown",function(){var e;E||D||(w=null,se());0===C&&S&&(S.remove(),S=null);if((0===C||C===RED.state.QUICK_JOINING)&&(d3.event.metaKey||d3.event.ctrlKey)){e=d3.mouse(this),d3.event.stopPropagation();var t=$("#main-container").position();C!==RED.state.QUICK_JOINING&&(C=RED.state.QUICK_JOINING,$(window).on("keyup",ve)),RED.typeSearch.show({x:d3.event.clientX-t.left-s/2,y:d3.event.clientY-t.top-r/2,add:function(t){var n=Y(t);if(n){var o=n.node,i=n.historyEvent;if(o.x=e[0],o.y=e[1],C===RED.state.QUICK_JOINING)if(q.length>0){var a,s,r=q[0],d=null;if(r.portType===B&&o.inputs>0?(d=r.node,s=r.port,a=o):r.portType===j&&o.outputs>0&&(d=o,a=r.node,s=0),null!==d){var l={source:d,sourcePort:s,target:a};RED.nodes.addLink(l),i.links=[l],H(),r.portType===B&&o.outputs>0?K([{node:o,port:0,portType:B}]):r.portType===j&&o.inputs>0?K([{node:o,port:0,portType:j}]):ge()}else H(),ge()}else o.outputs>0?K([{node:o,port:0,portType:B}]):o.inputs>0?K([{node:o,port:0,portType:j}]):ge();RED.history.push(i),RED.nodes.add(o),RED.editor.validateNode(o),RED.nodes.dirty(!0),ie(),o.selected=!0,O.push({n:o}),X(),se(),Te()}}}),X(),se(),Te()}0!==C||d3.event.metaKey||d3.event.ctrlKey||p||(e=d3.mouse(this),S=G.append("rect").attr("ox",e[0]).attr("oy",e[1]).attr("rx",1).attr("ry",1).attr("x",e[0]).attr("y",e[1]).attr("width",0).attr("height",0).attr("class","lasso"),d3.event.preventDefault())}).on("mouseup",Z).on("touchend",function(){clearTimeout(p),p=null,RED.touch.radialMenu.active()||(S&&V.attr("fill","#fff"),Z.call(this))}).on("touchcancel",Z).on("touchstart",function(){var e;if(d3.event.touches.length>1){clearTimeout(p),p=null,d3.event.preventDefault(),e=d3.event.touches.item(0);var t=d3.event.touches.item(1),n=e.pageY-t.pageY,o=e.pageX-t.pageX,i=$("#chart").offset(),s=[$("#chart").scrollLeft(),$("#chart").scrollTop()];c=[(t.pageX+o/2-i.left+s[0])/a,(t.pageY+n/2-i.top+s[1])/a],[t.pageX+o/2,t.pageY+n/2],l=Math.sqrt(n*n+o*o)}else{var r=d3.select(document.body),u=[(e=d3.event.touches.item(0)).pageX,e.pageY];c=[e.pageX,e.pageY],l=0;d3.touches(this)[0];p=setTimeout(function(){p=null,_e(r,u)},d)}}).on("touchmove",function(){var e;if(RED.touch.radialMenu.active())d3.event.preventDefault();else if(d3.event.touches.length<2){if(p){var t=(e=d3.event.touches.item(0)).pageX-c[0],n=e.pageY-c[1];Math.abs(t*t+n*n)>64&&(clearTimeout(p),p=null)}else S&&d3.event.preventDefault();Q.call(this)}else{e=d3.event.touches.item(0);var o=d3.event.touches.item(1),i=e.pageY-o.pageY,s=e.pageX-o.pageX,r=($("#chart").offset(),[$("#chart").scrollLeft(),$("#chart").scrollTop()]),d=Math.sqrt(i*i+s*s),u=[o.pageX+s/2,o.pageY+i/2];if(!isNaN(d)){oldScaleFactor=a,a=Math.min(2,Math.max(.3,a+Math.floor(100*d-100*l)/1e4));var f=[c[0]*(a-oldScaleFactor),c[1]*(a-oldScaleFactor)];l=d,u,$("#chart").scrollLeft(r[0]+f[0]),$("#chart").scrollTop(r[1]+f[1]),Te()}}}),V=G.append("svg:rect").attr("width",n).attr("height",o).attr("fill","#fff"),F=G.append("g");function W(){for(var e=[],t=0;t<n;t+=+f)e.push(t);F.selectAll("line.horizontal").remove(),F.selectAll("line.horizontal").data(e).enter().append("line").attr({class:"horizontal",x1:0,x2:n,y1:function(e){return e},y2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"}),F.selectAll("line.vertical").remove(),F.selectAll("line.vertical").data(e).enter().append("line").attr({class:"vertical",y1:0,y2:n,x1:function(e){return e},x2:function(e){return e},fill:"none","shape-rendering":"crispEdges",stroke:"#eee","stroke-width":"1px"})}W();var U=G.append("g"),q=[];function K(e){for(var t=0;t<e.length;t++){var n=e[t];n.el=U.append("svg:path").attr("class","drag_line"),q.push(n)}}function H(){for(;q.length;){var e=q.pop();e.el&&e.el.remove()}}function X(){var e=RED.workspaces.active();m=RED.nodes.filterNodes({z:e}),b=RED.nodes.filterLinks({source:{z:e},target:{z:e}})}function Y(e,t,n){var o=/^subflow:(.+)$/.exec(e);if(v&&o){if(o[1]===v.id)return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddSubflowToItself")}),"error");if(RED.nodes.subflowContains(o[1],v.id))return void RED.notify(RED._("notification.error",{message:RED._("notification.errors.cannotAddCircularReference")}),"error")}var i={id:RED.nodes.id(),z:RED.workspaces.active()};if(i.type=e,i._def=RED.nodes.getType(i.type),o){var a=RED.nodes.subflow(o[1]);i.inputs=a.in.length,i.outputs=a.out.length}else{i.inputs=i._def.inputs||0,i.outputs=i._def.outputs;for(var d in i._def.defaults)i._def.defaults.hasOwnProperty(d)&&void 0!==i._def.defaults[d].value&&(i[d]=JSON.parse(JSON.stringify(i._def.defaults[d].value)));if(i._def.onadd)try{i._def.onadd.call(i)}catch(e){console.log("Definition error: "+i.type+".onadd:",e)}}i.changed=!0,i.moved=!0,i.w=s,i.h=Math.max(r,15*(i.outputs||0));var l={t:"add",nodes:[i.id],dirty:RED.nodes.dirty()};if(v){var c=RED.subflow.refresh(!0);c&&(l.subflow={id:v.id,changed:v.changed,instances:c.instances})}return{node:i,historyEvent:l}}function Q(){var a,d;if(T=d3.touches(this)[0]||d3.mouse(this),S){var l,c,p=parseInt(S.attr("ox")),u=parseInt(S.attr("oy")),v=parseInt(S.attr("x")),m=parseInt(S.attr("y"));return l=T[0]<p?p-(v=T[0]):T[0]-v,c=T[1]<u?u-(m=T[1]):T[1]-m,void S.attr("x",v).attr("y",m).attr("width",l).attr("height",c)}if(C==RED.state.QUICK_JOINING||C==RED.state.IMPORT_DRAGGING||E||null!=w){var b;if(C==RED.state.JOINING||C===RED.state.QUICK_JOINING){if(0===q.length){if(d3.event.shiftKey){var y,D=[],$=[];if(w&&(R===B&&w.source===E&&w.sourcePort===k||R===j&&w.target===E))$=[w];else y=R===B?{source:E,sourcePort:k}:{target:E},$=RED.nodes.filterLinks(y);for(a=0;a<$.length;a++){var x=$[a];RED.nodes.removeLink(x),D.push({link:x,node:R===B?x.target:x.source,port:R===B?0:x.sourcePort,portType:R===B?j:B})}0===D.length?(ge(),Te()):(K(D),C=0,X(),Te(),C=RED.state.JOINING)}else E&&K([{node:E,port:k,portType:R}]);w=null}for(b=T,a=0;a<q.length;a++){var L=q[a],N=-((L.portType===B&&L.node.outputs||1)-1)/2*13+13*L.port,P=L.portType===B?1:-1,I=b[1]-(L.node.y+N),A=b[0]-(L.node.x+P*L.node.w/2),M=Math.sqrt(I*I+A*A),G=i,V=0;M<s&&(G=.75-(s-M)/s*.75),A*P<0&&(G+=Math.min(5*s,Math.abs(A))/(5*s)*2,Math.abs(I)<3*r&&(V=(I>0?.5:-.5)*((3*r-Math.abs(I))/(3*r))*(Math.min(s,Math.abs(A))/s))),L.el.attr("d","M "+(L.node.x+P*L.node.w/2)+" "+(L.node.y+N)+" C "+(L.node.x+P*(L.node.w/2+s*G))+" "+(L.node.y+N+V*r)+" "+(b[0]-P*G*s)+" "+(b[1]-V*r)+" "+b[0]+" "+b[1])}d3.event.preventDefault()}else if(C==RED.state.MOVING){b=d3.mouse(document.body),isNaN(b[0])&&(b=d3.touches(document.body)[0]),(_[0]-b[0])*(_[0]-b[0])+(_[1]-b[1])*(_[1]-b[1])>3&&(C=RED.state.MOVING_ACTIVE,z=0,g=!1,1===O.length&&(d=O[0],g=d.n.hasOwnProperty("_def")&&d.n._def.inputs>0&&d.n._def.outputs>0&&0===RED.nodes.filterLinks({source:d.n}).length&&0===RED.nodes.filterLinks({target:d.n}).length))}else if(C==RED.state.MOVING_ACTIVE||C==RED.state.IMPORT_DRAGGING){b=T;for(var F=0,W=0,U=n,H=o,Y=0;Y<O.length;Y++)d=O[Y],d3.event.shiftKey&&(d.n.ox=d.n.x,d.n.oy=d.n.y),d.n.x=b[0]+d.dx,d.n.y=b[1]+d.dy,d.n.dirty=!0,F=Math.min(d.n.x-d.n.w/2-5,F),W=Math.min(d.n.y-d.n.h/2-5,W),U=Math.max(d.n.x+d.n.w/2+5,U),H=Math.max(d.n.y+d.n.h/2+5,H);if(0!==F||0!==W)for(a=0;a<O.length;a++)(d=O[a]).n.x-=F,d.n.y-=W;if(U!==n||H!==o)for(a=0;a<O.length;a++)(d=O[a]).n.x-=U-n,d.n.y-=H-o;if(h!=d3.event.shiftKey&&O.length>0){var Q=[0,0];if(d=O[0],Q[0]=d.n.x-(f*Math.floor((d.n.x-d.n.w/2)/f)+d.n.w/2),Q[1]=d.n.y-f*Math.floor(d.n.y/f),0!==Q[0]||0!==Q[1])for(a=0;a<O.length;a++)(d=O[a]).n.x-=Q[0],d.n.y-=Q[1],d.n.x==d.n.ox&&d.n.y==d.n.oy&&(d.dirty=!1)}C!=RED.state.MOVING_ACTIVE&&C!=RED.state.IMPORT_DRAGGING||1!==O.length||(d=O[0],g&&(t||(t=setTimeout(function(){var n=[],o=1/0,i=null,a=d.n.x,s=d.n.y;if(J[0][0].getIntersectionList){var r=J[0][0].createSVGRect();r.x=a,r.y=s,r.width=1,r.height=1,n=J[0][0].getIntersectionList(r,J[0][0])}else n=RED.view.getLinksAtPoint(a,s);for(var l=0;l<n.length;l++)if(d3.select(n[l]).classed("link_background"))for(var c=n[l].getTotalLength(),p=0;p<c;p+=10){var u=n[l].getPointAtLength(p),f=(u.x-a)*(u.x-a)+(u.y-s)*(u.y-s);f<200&&f<o&&(o=f,i=n[l])}e&&e!==i&&d3.select(e.parentNode).classed("link_splice",!1),i?d3.select(i.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),e=i,t=null},100))))}0!==C&&Te()}}function Z(){var t,n;if(C!==RED.state.QUICK_JOINING){if(E&&C==RED.state.JOINING){var o=[];for(t=0;t<q.length;t++)q[t].link&&o.push(q[t].link);n={t:"delete",links:o,dirty:RED.nodes.dirty()},RED.history.push(n),H()}if(S){var i=parseInt(S.attr("x")),a=parseInt(S.attr("y")),s=i+parseInt(S.attr("width")),r=a+parseInt(S.attr("height"));d3.event.ctrlKey||ie(),RED.nodes.eachNode(function(e){e.z!=RED.workspaces.active()||e.selected||(e.selected=e.x>i&&e.x<s&&e.y>a&&e.y<r,e.selected&&(e.dirty=!0,O.push({n:e})))}),v&&(v.in.forEach(function(e){e.selected=e.x>i&&e.x<s&&e.y>a&&e.y<r,e.selected&&(e.dirty=!0,O.push({n:e}))}),v.out.forEach(function(e){e.selected=e.x>i&&e.x<s&&e.y>a&&e.y<r,e.selected&&(e.dirty=!0,O.push({n:e}))})),se(),S.remove(),S=null}else C!=RED.state.DEFAULT||null!=D||d3.event.ctrlKey||d3.event.metaKey||(ie(),se());if(C==RED.state.MOVING_ACTIVE&&O.length>0){for(var d=[],l=0;l<O.length;l++){var c=O[l];c.ox===c.n.x&&c.oy===c.n.y||(d.push({n:c.n,ox:c.ox,oy:c.oy,moved:c.n.moved}),c.n.dirty=!0,c.n.moved=!0)}if(d.length>0){if(n={t:"move",nodes:d,dirty:RED.nodes.dirty()},e){var p=d3.select(e).data()[0];RED.nodes.removeLink(p);var u={source:p.source,sourcePort:p.sourcePort,target:O[0].n},f={source:O[0].n,sourcePort:0,target:p.target};RED.nodes.addLink(u),RED.nodes.addLink(f),n.links=[u,f],n.removedLinks=[p],X()}RED.nodes.dirty(!0),RED.history.push(n)}}if(C==RED.state.MOVING||C==RED.state.MOVING_ACTIVE)for(t=0;t<O.length;t++)delete O[t].ox,delete O[t].oy;C==RED.state.IMPORT_DRAGGING&&(RED.keyboard.remove("escape"),X(),RED.nodes.dirty(!0)),ge(),Te()}}function ee(){a<2&&(a+=.1,Te())}function te(){a>.3&&(a-=.1,Te())}function ne(){a=1,Te()}function oe(){RED.nodes.eachNode(function(e){e.z==RED.workspaces.active()&&(e.selected||(e.selected=!0,e.dirty=!0,O.push({n:e})))}),v&&(v.in.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,O.push({n:e}))}),v.out.forEach(function(e){e.selected||(e.selected=!0,e.dirty=!0,O.push({n:e}))})),w=null,se(),Te()}function ie(){for(var e=0;e<O.length;e++){var t=O[e];t.n.dirty=!0,t.n.selected=!1}O=[],w=null}var ae=null;function se(){var e={};O.length>0&&(e.nodes=O.map(function(e){return e.n})),null!=w&&(e.link=w);var t=RED.workspaces.active();b=RED.nodes.filterLinks({source:{z:t},target:{z:t}});RED.nodes.getWorkspaceOrder();var n={};y=[];for(var o=0;o<O.length;o++)if("link out"===O[o].n.type||"link in"===O[o].n.type){var i=O[o].n,a={};i.links.forEach(function(e){var t=RED.nodes.node(e);t&&("link out"===i.type?t.z===i.z?n[i.id+":"+t.id]||(b.push({source:i,sourcePort:0,target:t,link:!0}),n[i.id+":"+t.id]=!0):(a[t.z]=a[t.z]||[],a[t.z].push(t)):t.z===i.z?n[t.id+":"+i.id]||(b.push({source:t,sourcePort:0,target:i,link:!0}),n[t.id+":"+i.id]=!0):(a[t.z]=a[t.z]||[],a[t.z].push(t)))}),Object.keys(a).length>0&&y.push({refresh:Math.floor(1e4*Math.random()),node:i,links:a})}var s=t+":"+JSON.stringify(e,function(e,t){return"nodes"===e?t.map(function(e){return e.id}):"link"===e?t.source.id+":"+t.sourcePort+":"+t.target.id:t});s!==ae&&(ae=s,RED.events.emit("view:selection-changed",e))}function re(){if(de=!1,O.length>0){for(var e=[],t=0;t<O.length;t++)e.push({n:O[t].n,ox:O[t].ox,oy:O[t].oy,moved:O[t].n.moved}),O[t].n.moved=!0,O[t].n.dirty=!0,delete O[t].ox,delete O[t].oy;Te(),RED.history.push({t:"move",nodes:e,dirty:RED.nodes.dirty()}),RED.nodes.dirty(!0)}}var de=!1;function le(e,t){if(O.length>0){de||($(document).one("keyup",re),de=!0);for(var n,o=0,i=0,a=0;a<O.length;a++)(n=O[a]).n.moved=!0,n.n.dirty=!0,null==n.ox&&null==n.oy&&(n.ox=n.n.x,n.oy=n.n.y),n.n.x+=e,n.n.y+=t,n.n.dirty=!0,o=Math.min(n.n.x-n.n.w/2-5,o),i=Math.min(n.n.y-n.n.h/2-5,i);if(0!==o||0!==i)for(var s=0;s<O.length;s++)(n=O[s]).n.x-=o,n.n.y-=i;Te()}}function ce(){if(O.length>0){var e=O[0].n;"subflow"===e.type?RED.editor.editSubflow(v):RED.editor.edit(e)}}function pe(){if(O.length>0||null!=w){var e,t=[],n=[],o=[],i=[],a=[],s=RED.nodes.dirty();if(O.length>0){for(var r=0;r<O.length;r++){var d=O[r].n;if(d.selected=!1,"subflow"!=d.type){d.x<0&&(d.x=25);var l=RED.nodes.remove(d.id);t.push(d),t=t.concat(l.nodes),n=n.concat(l.links)}else"out"===d.direction?o.push(d):"in"===d.direction&&i.push(d),d.dirty=!0}o.length>0&&(e=RED.subflow.removeOutput(o))&&(n=n.concat(e.links)),1==i.length&&(e=RED.subflow.removeInput())&&(n=n.concat(e.links));var c=RED.subflow.refresh(!0);c&&(a=c.instances),O=[],(t.length>0||o.length>0||i.length>0)&&RED.nodes.dirty(!0)}w&&(RED.nodes.removeLink(w),n.push(w),RED.nodes.dirty(!0));var p={t:"delete",nodes:t,links:n,subflowOutputs:o,subflowInputs:i,subflow:{instances:a},dirty:s};RED.history.push(p),w=null,X(),se(),Te()}}function ue(){if(O.length>0){for(var e=[],t=0;t<O.length;t++){var n=O[t].n;if("subflow"!=n.type){for(var o in n._def.defaults)if(n._def.defaults.hasOwnProperty(o)&&n._def.defaults[o].type){var i=RED.nodes.node(n[o]);i&&i._def.exclusive&&e.push(RED.nodes.convertNode(i))}e.push(RED.nodes.convertNode(n))}}A=JSON.stringify(e),RED.notify(RED._("clipboard.nodeCopied",{count:e.length}))}}function fe(e,t,n){return he(e,t,n,0)[0]}function he(e,t,n,o){var i=document.createElement("span");i.className=t,i.style.position="absolute",i.style.top="-1000px",i.textContent=e||"",document.body.appendChild(i);var a=i.offsetWidth,s=i.offsetHeight;return document.body.removeChild(i),[n+a,o+s]}function ge(){E=null,x=null,D=null,C=0,R=B,e=null,g=!1,d3.select(".link_splice").classed("link_splice",!1),t&&(clearTimeout(t),t=null)}function ve(e){17!==e.keyCode&&"Meta"!==e.key&&91!==e.keyCode||(ge(),H(),Te(),$(window).off("keyup",ve))}function me(e,t,n){E=e,R=t,k=n||0,C!==RED.state.QUICK_JOINING&&(C=RED.state.JOINING,document.body.style.cursor="crosshair",(d3.event.ctrlKey||d3.event.metaKey)&&(C=RED.state.QUICK_JOINING,K([{node:E,port:k,portType:R}]),$(window).on("keyup",ve))),d3.event.stopPropagation(),d3.event.preventDefault()}function be(e,t,n){var o;if((C!==RED.state.QUICK_JOINING||q[0].node!==e)&&(document.body.style.cursor="",C==RED.state.JOINING||C==RED.state.QUICK_JOINING)){"undefined"!=typeof TouchEvent&&d3.event instanceof TouchEvent?RED.nodes.eachNode(function(e){if(e.z==RED.workspaces.active()){var o=e.w/2,i=e.h/2;e.x-o<T[0]&&e.x+o>T[0]&&e.y-i<T[1]&&e.y+i>T[1]&&(t=(x=e).inputs>0?j:B,n=0)}}):x=e;var i=[],a=[];for(o=0;o<q.length;o++)q[o].link&&a.push(q[o].link);for(o=0;o<q.length;o++)if(t!=q[o].portType&&x!==q[o].node){var s,r,d,l=q[o];if(l.portType===B?(s=l.node,d=l.port,r=x):l.portType===j&&(s=x,r=l.node,d=n),!(0!==RED.nodes.filterLinks({source:s,target:r,sourcePort:d}).length)){var c={source:s,sourcePort:d,target:r};RED.nodes.addLink(c),i.push(c)}}if(i.length>0||a.length>0){var p={t:"add",links:i,removedLinks:a,dirty:RED.nodes.dirty()};if(v){var u=RED.subflow.refresh(!0);u&&(p.subflow={id:v.id,changed:v.changed,instances:u.instances})}RED.history.push(p),X(),RED.nodes.dirty(!0)}if(C===RED.state.QUICK_JOINING)return i.length>0&&(H(),t===j&&e.outputs>0?K([{node:e,port:0,portType:B}]):t===B&&e.inputs>0?K([{node:e,port:0,portType:j}]):ge()),void Te();ge(),H(),w=null,Te()}}var ye=null,we=null;function De(e,t,n,o){clearTimeout(ye);var i=C!=RED.state.JOINING||q.length>0&&q[0].portType!==n;i&&(n===j&&(t._def&&t._def.inputLabels||t.inputLabels)||n===B&&(t._def&&t._def.outputLabels||t.outputLabels))&&(ye=setTimeout(function(){var i=function(e,t,n){var o,i=t===j?e.inputLabels:e.outputLabels;if(i&&i[n])return i[n];var a=t===j?e._def.inputLabels:e._def.outputLabels;if("string"==typeof a)o=a;else if("function"==typeof a)try{o=a.call(e,n)}catch(n){console.log("Definition error: "+e.type+"."+(t===j?"inputLabels":"outputLabels"),n),o=null}else $.isArray(a)&&(o=a[n]);return o}(t,n,o);if(i){var a=function e(t){var n=d3.select(t);if("innerCanvas"===n.attr("class"))return[0,0];var o=[0,0];if("g"===t.nodeName.toLowerCase()){var i=n.attr("transform");i&&(o=d3.transform(i).translate)}else o=[n.attr("x")||0,n.attr("y")||0];var a=e(t.parentNode);return[o[0]+a[0],o[1]+a[1]]}(e.node());ye=null,we=G.append("g").attr("transform","translate("+(a[0]+(n===j?-2:12))+","+(a[1]+5)+")").attr("class","port_tooltip");var s=i.split("\n"),r=0,d=4,l=[];s.forEach(function(e){var t=he(e,"port_tooltip_label",8,0);r=Math.max(r,t[0]),l.push(.8*t[1]),d+=.8*t[1]});var c=d/2-5-2,p=d-4;we.append("path").attr("d",n===j?"M0 0 l -5 -5 v -"+c+" q 0 -2 -2 -2 h -"+r+" q -2 0 -2 2 v "+p+" q 0 2 2 2 h "+r+" q 2 0 2 -2 v -"+c+" l 5 -5":"M0 0 l 5 -5 v -"+c+" q 0 -2 2 -2 h "+r+" q 2 0 2 2 v "+p+" q 0 2 -2 2 h -"+r+" q -2 0 -2 -2 v -"+c+" l -5 -5");var u=-d/2-2;s.forEach(function(e,t){u+=l[t],we.append("svg:text").attr("class","port_tooltip_label").attr("x",n===j?-10:10).attr("y",u).attr("text-anchor",n===j?"end":"start").text(e)})}},500)),e.classed("port_hovered",i)}function Ee(e,t,n,o){clearTimeout(ye),we&&(we.remove(),we=null),e.classed("port_hovered",!1)}function Re(e){if(P&&E==e&&z>0&&z<750)return C=RED.state.DEFAULT,"subflow"!=e.type?RED.editor.edit(e):RED.editor.editSubflow(v),z=0,void d3.event.stopPropagation();be(e,e._def?e.inputs>0?1:0:"in"==e.direction?0:1,0)}function $e(t){if(Ce(),C==RED.state.IMPORT_DRAGGING){if(RED.keyboard.remove("escape"),e){var n=d3.select(e).data()[0];RED.nodes.removeLink(n);var o={source:n.source,sourcePort:n.sourcePort,target:O[0].n},i={source:O[0].n,sourcePort:0,target:n.target};RED.nodes.addLink(o),RED.nodes.addLink(i);var a=RED.history.peek();a.links=[o,i],a.removedLinks=[n],X()}return se(),RED.nodes.dirty(!0),Te(),ge(),void d3.event.stopPropagation()}if(C!=RED.state.QUICK_JOINING){E=t;var s,r=Date.now();if(z=r-I,I=r,P=N==E,N=E,t.selected&&(d3.event.ctrlKey||d3.event.metaKey)){for(E.selected=!1,s=0;s<O.length;s+=1)if(O[s].n===E){O.splice(s,1);break}}else{if(d3.event.shiftKey){ie();for(var d=RED.nodes.getAllFlowNodes(E),l=0;l<d.length;l++)d[l].selected=!0,d[l].dirty=!0,O.push({n:d[l]})}else t.selected||(d3.event.ctrlKey||d3.event.metaKey||ie(),E.selected=!0,O.push({n:E}));if(w=null,2!=d3.event.button){C=RED.state.MOVING;var c=d3.touches(this)[0]||d3.mouse(this);for(c[0]+=t.x-t.w/2,c[1]+=t.y-t.h/2,s=0;s<O.length;s++)O[s].ox=O[s].n.x,O[s].oy=O[s].n.y,O[s].dx=O[s].n.x-c[0],O[s].dy=O[s].n.y-c[1];_=d3.mouse(document.body),isNaN(_[0])&&(_=d3.touches(document.body)[0])}}t.dirty=!0,se(),Te(),d3.event.stopPropagation()}else d3.event.stopPropagation()}function ke(e){var t=!0;return e._def.button.hasOwnProperty("enabled")&&(t="function"==typeof e._def.button.enabled?e._def.button.enabled.call(e):e._def.button.enabled),t}function xe(e){if(v)RED.notify(RED._("notification.warning",{message:RED._("notification.warnings.nodeActionDisabled")}),"warning");else{if(e._def.button.toggle&&(e[e._def.button.toggle]=!e[e._def.button.toggle],e.dirty=!0),e._def.button.onclick)try{e._def.button.onclick.call(e)}catch(t){console.log("Definition error: "+e.type+".onclick",t)}e.dirty&&Te()}d3.event.preventDefault()}function _e(e,t){var n=E,o=[];o.push({name:"delete",disabled:0===O.length&&null===w,onselect:function(){pe()}}),o.push({name:"cut",disabled:0===O.length,onselect:function(){ue(),pe()}}),o.push({name:"copy",disabled:0===O.length,onselect:function(){ue()}}),o.push({name:"paste",disabled:0===A.length,onselect:function(){Oe(A,!1,!0)}}),o.push({name:"edit",disabled:1!=O.length,onselect:function(){RED.editor.edit(n)}}),o.push({name:"select",onselect:function(){oe()}}),o.push({name:"undo",disabled:0===RED.history.depth(),onselect:function(){RED.history.pop()}}),RED.touch.radialMenu.show(e,t,o),ge()}function Te(){if(G.attr("transform","scale("+a+")"),J.attr("width",n*a).attr("height",o*a),C!=RED.state.JOINING){var e={};if(v){var t=G.selectAll(".subflowoutput").data(v.out,function(e,t){return e.id});t.exit().remove();var u=t.enter().insert("svg:g").attr("class","node subflowoutput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});u.each(function(e,t){e.w=40,e.h=40}),u.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Re).on("mousedown",$e).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];c=[n.pageX,n.pageY],l=0,p=setTimeout(function(){_e(t,o)},d),$e.call(this,e)}).on("touchend",function(e){clearTimeout(p),p=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Re.call(this,e)}),u.append("g").attr("transform","translate(-5,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){me(e,j,0)}).on("touchstart",function(e,t){me(e,j,0)}).on("mouseup",function(e,t){be(e,j,0)}).on("touchend",function(e,t){be(e,j,0)}).on("mouseover",function(e){De(d3.select(this),e,j,0)}).on("mouseout",function(e){Ee(d3.select(this))}),u.append("svg:text").attr("class","port_label").attr("x",20).attr("y",8).style("font-size","10px").text("output"),u.append("svg:text").attr("class","port_label port_index").attr("x",20).attr("y",24).text(function(e,t){return t+1});var f=G.selectAll(".subflowinput").data(v.in,function(e,t){return e.id});f.exit().remove();var h=f.enter().insert("svg:g").attr("class","node subflowinput").attr("transform",function(e){return"translate("+(e.x-20)+","+(e.y-20)+")"});h.each(function(e,t){e.w=40,e.h=40}),h.append("rect").attr("class","subflowport").attr("rx",8).attr("ry",8).attr("width",40).attr("height",40).on("mouseup",Re).on("mousedown",$e).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];c=[n.pageX,n.pageY],l=0,p=setTimeout(function(){_e(t,o)},d),$e.call(this,e)}).on("touchend",function(e){clearTimeout(p),p=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Re.call(this,e)}),h.append("g").attr("transform","translate(35,15)").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e,t){me(e,B,t)}).on("touchstart",function(e,t){me(e,B,t)}).on("mouseup",function(e,t){be(e,B,t)}).on("touchend",function(e,t){be(e,B,t)}).on("mouseover",function(e){De(d3.select(this),e,B,0)}).on("mouseout",function(e){Ee(d3.select(this))}),h.append("svg:text").attr("class","port_label").attr("x",18).attr("y",20).style("font-size","10px").text("input"),t.each(function(t,n){if(t.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.selectAll(".port_index").text(function(e){return e.i+1}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),e[t.id]=t,t.dirty=!1}}),f.each(function(t,n){if(t.dirty){var o=d3.select(this);o.selectAll(".subflowport").classed("node_selected",function(e){return e.selected}),o.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),e[t.id]=t,t.dirty=!1}})}else G.selectAll(".subflowoutput").remove(),G.selectAll(".subflowinput").remove();var g=G.selectAll(".nodegroup").data(m,function(e){return e.id});g.exit().remove(),g.enter().insert("svg:g").attr("class","node nodegroup").classed("node_subflow",function(e){return null!=v}).classed("node_link",function(e){return"link in"===e.type||"link out"===e.type}).each(function(e,t){var n=d3.select(this),o="link in"===e.type||"link out"===e.type;n.attr("id",e.id);var i=RED.utils.getNodeLabel(e);if(e.w=o?r:Math.max(s,20*Math.ceil((fe(i,"node_label",50)+(e._def.inputs>0?7:0))/20)),e.h=Math.max(r,15*(e.outputs||0)),e._def.badge){var a=n.append("svg:g").attr("class","node_badge_group"),u=a.append("rect").attr("class","node_badge").attr("rx",5).attr("ry",5).attr("width",40).attr("height",15);a.append("svg:text").attr("class","node_badge_label").attr("x",35).attr("y",11).attr("text-anchor","end").text(e._def.badge()),e._def.onbadgeclick&&u.attr("cursor","pointer").on("click",function(e){e._def.onbadgeclick.call(e),d3.event.preventDefault()})}if(e._def.button){var f=n.append("svg:g").attr("transform",function(e){return"translate("+("right"==e._def.align?94:-25)+",2)"}).attr("class",function(e){return"node_button "+("right"==e._def.align?"node_right_button":"node_left_button")});f.append("rect").attr("rx",5).attr("ry",5).attr("width",32).attr("height",r-4).attr("fill","#eee"),f.append("rect").attr("class","node_button_button").attr("x",function(e){return"right"==e._def.align?11:5}).attr("y",4).attr("rx",4).attr("ry",4).attr("width",16).attr("height",r-12).attr("fill",function(e){return e._def.color}).attr("cursor","pointer").on("mousedown",function(e){!S&&ke(e)&&(Ce(),d3.select(this).attr("fill-opacity",.2),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseup",function(e){!S&&ke(e)&&(d3.select(this).attr("fill-opacity",.4),d3.event.preventDefault(),d3.event.stopPropagation())}).on("mouseover",function(e){!S&&ke(e)&&d3.select(this).attr("fill-opacity",.4)}).on("mouseout",function(e){if(!S&&ke(e)){var t=1;e._def.button.toggle&&(t=e[e._def.button.toggle]?1:.2),d3.select(this).attr("fill-opacity",t)}}).on("click",xe).on("touchstart",xe)}n.append("rect").attr("class","node").classed("node_unknown",function(e){return"unknown"==e.type}).attr("rx",5).attr("ry",5).attr("fill",function(e){return e._def.color}).on("mouseup",Re).on("mousedown",$e).on("touchstart",function(e){var t=d3.select(this),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];c=[n.pageX,n.pageY],l=0,p=setTimeout(function(){_e(t,o)},d),$e.call(this,e)}).on("touchend",function(e){clearTimeout(p),p=null,RED.touch.radialMenu.active()?d3.event.stopPropagation():Re.call(this,e)}).on("mouseover",function(e){0===C&&d3.select(this).classed("node_hovered",!0)}).on("mouseout",function(e){d3.select(this).classed("node_hovered",!1)});if(e._def.icon){var h=RED.utils.getNodeIcon(e._def,e),g=n.append("g").attr("class","node_icon_group").attr("x",0).attr("y",0),v=(g.append("rect").attr("x",0).attr("y",0).attr("class","node_icon_shade").attr("width","30").attr("stroke","none").attr("fill","#000").attr("fill-opacity","0.05").attr("height",function(e){return Math.min(50,e.h-4)}),g.append("image").attr("xlink:href",h).attr("class","node_icon").attr("x",0).attr("width","30").attr("height","30")),m=g.append("path").attr("d",function(e){return"M 30 1 l 0 "+(e.h-2)}).attr("class","node_icon_shade_border").attr("stroke-opacity","0.1").attr("stroke","#000").attr("stroke-width","1");"right"==e._def.align&&(g.attr("class","node_icon_group node_icon_group_"+e._def.align),m.attr("d",function(e){return"M 0 1 l 0 "+(e.h-2)}));var b=new Image;b.src=h,b.onload=function(){v.attr("width",Math.min(b.width,30)),v.attr("height",Math.min(b.height,30)),v.attr("x",15-Math.min(b.width,30)/2)},g.style("pointer-events","none")}if(!o){var y=n.append("svg:text").attr("class","node_label").attr("x",38).attr("dy",".35em").attr("text-anchor","start");e._def.align&&(y.attr("class","node_label node_label_"+e._def.align),"right"===e._def.align&&y.attr("text-anchor","end"));var w=n.append("svg:g").attr("class","node_status_group").style("display","none");w.append("rect").attr("class","node_status").attr("x",6).attr("y",1).attr("width",9).attr("height",9).attr("rx",2).attr("ry",2).attr("stroke-width","3"),w.append("svg:text").attr("class","node_status_label").attr("x",20).attr("y",9)}n.append("image").attr("class","node_error hidden").attr("xlink:href","icons/node-red/node-error.png").attr("x",0).attr("y",-6).attr("width",10).attr("height",9),n.append("image").attr("class","node_changed hidden").attr("xlink:href","icons/node-red/node-changed.png").attr("x",12).attr("y",-6).attr("width",10).attr("height",10)}),g.each(function(t,n){if(t.dirty){var o="link in"===t.type||"link out"===t.type;if(e[t.id]=t,!o&&t.resize){var i=RED.utils.getNodeLabel(t),a=t.w;t.w=Math.max(s,20*Math.ceil((fe(i,"node_label",50)+(t._def.inputs>0?7:0))/20)),t.h=Math.max(r,15*(t.outputs||0)),t.x+=(t.w-a)/2,t.resize=!1}var d=d3.select(this);if(d.attr("transform",function(e){return"translate("+(e.x-e.w/2)+","+(e.y-e.h/2)+")"}),C!=RED.state.MOVING_ACTIVE){d.selectAll(".node").attr("width",function(e){return e.w}).attr("height",function(e){return e.h}).classed("node_selected",function(e){return e.selected}).classed("node_highlighted",function(e){return e.highlighted}),d.selectAll(".node_icon_group_right").attr("transform",function(e){return"translate("+(e.w-30)+",0)"}),d.selectAll(".node_label_right").attr("x",function(e){return e.w-38});var l=d.selectAll(".port_input");if(0!==t.inputs||l.empty()){if(1===t.inputs&&l.empty()){d.append("g").attr("class","port_input").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",function(e){me(e,j,0)}).on("touchstart",function(e){me(e,j,0)}).on("mouseup",function(e){be(e,j,0)}).on("touchend",function(e){be(e,j,0)}).on("mouseover",function(e){De(d3.select(this),e,j,0)}).on("mouseout",function(e){Ee(d3.select(this))})}}else l.remove();var c=t.outputs,p=t.h/2-(c-1)/2*13;if(t.ports=t.ports||d3.range(c),t._ports=d.selectAll(".port_output").data(t.ports),t._ports.enter().append("g").attr("class","port_output").append("rect").attr("class","port").attr("rx",3).attr("ry",3).attr("width",10).attr("height",10).on("mousedown",(R=t,function(e,t){me(R,B,t)})).on("touchstart",(E=t,function(e,t){me(E,B,t)})).on("mouseup",(D=t,function(e,t){be(D,B,t)})).on("touchend",(w=t,function(e,t){be(w,B,t)})).on("mouseover",(y=t,function(e,t){De(d3.select(this),y,B,t)})).on("mouseout",function(e,t){Ee(d3.select(this))}),t._ports.exit().remove(),t._ports){c=t.outputs||1,p=t.h/2-(c-1)/2*13;var u=t.w-5;t._ports.each(function(e,t){d3.select(this).attr("transform",function(e){return"translate("+u+","+(p+13*t-5)+")"})})}if(d.selectAll("text.node_label").text(function(e,t){var n="";if(e._def.label){n=e._def.label;try{n=("function"==typeof n?n.call(e):n)||"",n=RED.text.bidi.enforceTextDirectionWithUCC(n)}catch(t){console.log("Definition error: "+e.type+".label",t),n=e.type}}return n}).attr("y",function(e){return e.h/2-1}).attr("class",function(e){var t="";if(e._def.labelStyle){t=e._def.labelStyle;try{t=("function"==typeof t?t.call(e):t)||""}catch(n){console.log("Definition error: "+e.type+".labelStyle",n),t=""}t=" "+t}return"node_label"+(e._def.align?" node_label_"+e._def.align:"")+t}),t._def.icon){icon=d.select(".node_icon");var f=icon.attr("xlink:href"),h=RED.utils.getNodeIcon(t._def,t);if(h!==f){icon.attr("xlink:href",h);var g=new Image;g.src=h,g.onload=function(){icon.attr("width",Math.min(g.width,30)),icon.attr("height",Math.min(g.height,30)),icon.attr("x",15-Math.min(g.width,30)/2)}}}d.selectAll(".node_tools").attr("x",function(e){return e.w-35}).attr("y",function(e){return e.h-20}),d.selectAll(".node_changed").attr("x",function(e){return e.w-10}).classed("hidden",function(e){return!(e.changed||e.moved)}),d.selectAll(".node_error").attr("x",function(e){return e.w-10-(e.changed||e.moved?13:0)}).classed("hidden",function(e){return e.valid}),d.selectAll(".port_input").each(function(e,t){d3.select(this).attr("transform",function(e){return"translate(-5,"+(e.h/2-5)+")"})}),d.selectAll(".node_icon").attr("y",function(e){return(e.h-d3.select(this).attr("height"))/2}),d.selectAll(".node_icon_shade").attr("height",function(e){return e.h}),d.selectAll(".node_icon_shade_border").attr("d",function(e){return"M "+("right"==e._def.align?0:30)+" 1 l 0 "+(e.h-2)}),d.selectAll(".node_button").attr("opacity",function(e){return v||!ke(e)?.4:1}),d.selectAll(".node_button_button").attr("cursor",function(e){return v||!ke(e)?"":"pointer"}),d.selectAll(".node_right_button").attr("transform",function(e){var t=e.w-6;return e._def.button.toggle&&!e[e._def.button.toggle]&&(t-=8),"translate("+t+",2)"}),d.selectAll(".node_right_button rect").attr("fill-opacity",function(e){return e._def.button.toggle?e[e._def.button.toggle]?1:.2:1}),d.selectAll(".node_badge_group").attr("transform",function(e){return"translate("+(e.w-40)+","+(e.h+3)+")"}),d.selectAll("text.node_badge_label").text(function(e,t){if(e._def.badge){if("function"!=typeof e._def.badge)return e._def.badge;try{return e._def.badge.call(e)}catch(t){return console.log("Definition error: "+e.type+".badge",t),""}}return""})}if(L&&t.status){d.selectAll(".node_status_group").style("display","inline").attr("transform","translate(3,"+(t.h+3)+")");var m,b=M[t.status.fill];if(null==t.status.shape&&null==b)d.selectAll(".node_status").style("display","none");else null==t.status.shape||"dot"==t.status.shape?m={display:"inline",fill:b,stroke:b}:"ring"==t.status.shape&&(m={display:"inline",fill:"#fff",stroke:b}),d.selectAll(".node_status").style(m);t.status.text?d.selectAll(".node_status_label").text(t.status.text):d.selectAll(".node_status_label").text("")}else d.selectAll(".node_status_group").style("display","none");t.dirty=!1}var y,w,D,E,R});var E=G.selectAll(".link").data(b,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i});E.enter().insert("g",".node").attr("class","link").each(function(e,t){var n=d3.select(this);e.added=!0,n.append("svg:path").attr("class","link_background link_path").on("mousedown",function(e){D=e,ie(),w=D,se(),Te(),Ce(),d3.event.stopPropagation()}).on("touchstart",function(e){D=e,ie(),w=D,se(),Te(),Ce(),d3.event.stopPropagation();var t=d3.select(document.body),n=d3.event.touches.item(0),o=[n.pageX,n.pageY];p=setTimeout(function(){p=null,_e(t,o)},d)}),n.append("svg:path").attr("class","link_outline link_path"),n.append("svg:path").attr("class","link_line link_path").classed("link_link",function(e){return e.link}).classed("link_subflow",function(e){return!e.link&&v})}),E.exit().remove(),G.selectAll(".link_path").each(function(t){var n=d3.select(this);(t.added||t===w||t.selected||e[t.source.id]||e[t.target.id])&&n.attr("d",function(e){var t=-((e.source.outputs||1)-1)/2*13+13*(e.sourcePort||0),n=e.target.y-(e.source.y+t),o=e.target.x-e.target.w/2-(e.source.x+e.source.w/2),a=Math.sqrt(n*n+o*o),d=i,l=0;return a<s&&(d=.75-(s-a)/s*.75),o<0&&(d+=Math.min(5*s,Math.abs(o))/(5*s)*2,Math.abs(n)<3*r&&(l=(n>0?.5:-.5)*((3*r-Math.abs(n))/(3*r))*(Math.min(s,Math.abs(o))/s))),e.x1=e.source.x+e.source.w/2,e.y1=e.source.y+t,e.x2=e.target.x-e.target.w/2,e.y2=e.target.y,"M "+e.x1+" "+e.y1+" C "+(e.x1+d*s)+" "+(e.y1+l*r)+" "+(e.x2-d*s)+" "+(e.y2-l*r)+" "+e.x2+" "+e.y2})}),E.classed("link_selected",function(e){return e===w||e.selected}),E.classed("link_unknown",function(e){return delete e.added,"unknown"==e.target.type||"unknown"==e.source.type});var R=G.selectAll(".link_flow_link_g").data(y,function(e){return e.node.id+":"+e.refresh});R.enter().insert("g",".node").attr("class","link_flow_link_g").each(function(e,t){var n=d3.select(this),o=1,i="start";"link in"===e.node.type&&(o=-1,i="end");var a=30*o,d=20*o,l=(n.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M 0 0 h "+a),e.links),c=Object.keys(l),p=RED.nodes.getWorkspaceOrder();c.sort(function(e,t){return p.indexOf(e)-p.indexOf(t)});var u=r,f=-(c.length-1)*u/2,h=n.selectAll(".link_group").data(c);h.enter().append("g").attr("class","link_group").on("mouseover",function(){d3.select(this).classed("link_group_active",!0)}).on("mouseout",function(){d3.select(this).classed("link_group_active",!1)}).on("mousedown",function(){d3.event.preventDefault(),d3.event.stopPropagation()}).on("mouseup",function(t){d3.event.stopPropagation();var n=e.links[t];RED.workspaces.show(t),n.forEach(function(e){e.selected=!0,e.dirty=!0,O.push({n:e})}),se(),Te()}).each(function(e){var t=d3.select(this);t.append("svg:path").attr("class","link_flow_link").attr("class","link_link").attr("d","M "+a+" 0 C "+(a+1.7*d)+" 0 "+(a+.1*d)+" "+f+" "+(a+1.5*d)+" "+f+" "),t.append("svg:path").attr("class","link_port").attr("d","M "+(a+1.5*d+17*o)+" "+(f-12)+" h "+10*-o+" a 3 3 45 0 "+(1===o?"0":"1")+" "+-3*o+" 3 v 18 a 3 3 45 0 "+(1===o?"0":"1")+" "+3*o+" 3 h "+10*o),t.append("svg:path").attr("class","link_port").attr("d","M "+(a+1.5*d+20*o)+" "+(f-12)+" h "+30*o+" M "+(a+1.5*d+20*o)+" "+(f+12)+" h "+30*o).style("stroke-dasharray","12 3 8 4 3"),t.append("rect").attr("class","port link_port").attr("x",a+1.5*d-4+4*o).attr("y",f-4).attr("rx",2).attr("ry",2).attr("width",8).attr("height",8),t.append("rect").attr("x",a+1.5*d-(-1===o?s:0)).attr("y",f-12).attr("width",s).attr("height",24).style("stroke","none").style("fill","transparent");var n,r=RED.nodes.workspace(e);r&&(n=r.label||r.id),t.append("svg:text").attr("class","port_label").attr("x",a+1.5*d+15*o).attr("y",f+1).style("font-size","10px").style("text-anchor",i).text(n),f+=u}),h.exit().remove()}),R.exit().remove(),(R=G.selectAll(".link_flow_link_g")).each(function(e){var t=1;"link in"===e.node.type&&(t=-1),d3.select(this).attr("transform",function(e){return"translate("+(e.node.x+t*e.node.w/2)+","+e.node.y+")"})})}else G.selectAll(".link_selected").data(b,function(e){return e.source.id+":"+e.sourcePort+":"+e.target.id+":"+e.target.i}).classed("link_selected",!1);d3.event&&d3.event.preventDefault()}function Ce(){try{var e=window.parent.window.scrollX,t=window.parent.window.scrollY;$("#chart").focus(),window.parent.window.scrollTo(e,t)}catch(e){$("#chart").focus()}}function Oe(e,t,n){try{var o;v&&(o=v.changed);var i=RED.nodes.import(e,!0,t);if(i){var a=i[0],d=i[1],l=i[2],c=i[3],p=i[4];t&&p&&RED.workspaces.show(p.id);var u=a.filter(function(e){return e.hasOwnProperty("x")&&e.hasOwnProperty("y")&&e.z==RED.workspaces.active()}).map(function(e){return{n:e}}),f=a.map(function(e){return e.id});if(u.length>0){var h=u[0].n,m=h.x,b=h.y;null==T&&(T=[0,0]);var y,w,D=0,E=0;for(y=0;y<u.length;y++)(w=u[y]).n.selected=!0,w.n.changed=!0,w.n.moved=!0,w.n.x-=m-T[0],w.n.y-=b-T[1],w.dx=w.n.x-T[0],w.dy=w.n.y-T[1],D=Math.min(w.n.x-s/2-5,D),E=Math.min(w.n.y-r/2-5,E);for(y=0;y<u.length;y++)if((w=u[y]).n.x-=D,w.n.y-=E,w.dx-=D,w.dy-=E,w.n._def.onadd)try{w.n._def.onadd.call(w.n)}catch(e){console.log("Definition error: "+w.n.type+".onadd:",e)}n||(C=RED.state.IMPORT_DRAGGING,g=!1,1===u.length&&(w=u[0],g=w.n.hasOwnProperty("_def")&&w.n._def.inputs>0&&w.n._def.outputs>0)),RED.keyboard.add("*","escape",function(){RED.keyboard.remove("escape"),ie(),RED.history.pop(),C=0}),ie(),O=u}var R={t:"add",nodes:f,links:d,workspaces:l,subflows:c,dirty:RED.nodes.dirty()};if(0===u.length&&RED.nodes.dirty(!0),v){var $=RED.subflow.refresh(!0);$&&(R.subflow={id:v.id,changed:o,instances:$.instances})}RED.history.push(R),X(),Te()}}catch(e){"NODE_RED"!=e.code?(console.log(e.stack),RED.notify(RED._("notification.error",{message:e.toString()}),"error")):RED.notify(RED._("notification.error",{message:e.message}),"error")}}return{init:function(){RED.events.on("workspace:change",function(e){var t=$("#chart");0!==e.old&&(u[e.old]={left:t.scrollLeft(),top:t.scrollTop()});var n=t.scrollLeft(),o=t.scrollTop();v=RED.nodes.subflow(e.workspace),RED.menu.setDisabled("menu-item-workspace-edit",v),RED.menu.setDisabled("menu-item-workspace-delete",1==RED.workspaces.count()||v),u[e.workspace]?(t.scrollLeft(u[e.workspace].left),t.scrollTop(u[e.workspace].top)):(t.scrollLeft(0),t.scrollTop(0));var i=t.scrollLeft()-n,a=t.scrollTop()-o;null!=T&&(T[0]+=i,T[1]+=a),ie(),RED.nodes.eachNode(function(e){e.dirty=!0}),se(),X(),Te()}),$("#btn-zoom-out").click(function(){te()}),$("#btn-zoom-zero").click(function(){ne()}),$("#btn-zoom-in").click(function(){ee()}),$("#chart").on("DOMMouseScroll mousewheel",function(e){e.altKey&&(e.preventDefault(),e.stopPropagation(),(-e.originalEvent.detail||e.originalEvent.wheelDelta)<=0?te():ee())}),$("#chart").droppable({accept:".palette_node",drop:function(e,t){d3.event=e;var n=Y(t.draggable[0].type);if(n){var o=n.historyEvent,i=n.node,s=d3.touches(t.helper.get(0))[0]||d3.mouse(t.helper.get(0)),r=d3.touches(this)[0]||d3.mouse(this);r[1]+=this.scrollTop+(i.h/2-s[1]),r[0]+=this.scrollLeft+(i.w/2-s[0]),r[1]/=a,r[0]/=a,h&&(r[0]=f*Math.ceil(r[0]/f),r[1]=f*Math.ceil(r[1]/f)),i.x=r[0],i.y=r[1];var d=$(t.helper).data("splice");if(d){RED.nodes.removeLink(d);var l={source:d.source,sourcePort:d.sourcePort,target:i},c={source:i,sourcePort:0,target:d.target};RED.nodes.addLink(l),RED.nodes.addLink(c),o.links=[l,c],o.removedLinks=[d]}RED.history.push(o),RED.nodes.add(i),RED.editor.validateNode(i),RED.nodes.dirty(!0),ie(),i.selected=!0,O.push({n:i}),X(),se(),Te(),i._def.autoedit&&RED.editor.edit(i)}}}),$("#chart").focus(function(){$("#workspace-tabs").addClass("workspace-focussed")}),$("#chart").blur(function(){$("#workspace-tabs").removeClass("workspace-focussed")}),RED.actions.add("core:copy-selection-to-internal-clipboard",ue),RED.actions.add("core:cut-selection-to-internal-clipboard",function(){ue(),pe()}),RED.actions.add("core:paste-from-internal-clipboard",function(){Oe(A)}),RED.actions.add("core:delete-selection",pe),RED.actions.add("core:edit-selected-node",ce),RED.actions.add("core:undo",RED.history.pop),RED.actions.add("core:select-all-nodes",oe),RED.actions.add("core:zoom-in",ee),RED.actions.add("core:zoom-out",te),RED.actions.add("core:zoom-reset",ne),RED.actions.add("core:toggle-show-grid",function(e){void 0===e?RED.userSettings.toggle("view-show-grid"):e?F.style("visibility","visible"):F.style("visibility","hidden")}),RED.actions.add("core:toggle-snap-grid",function(e){void 0===e?RED.userSettings.toggle("view-snap-grid"):(h=e,Te())}),RED.actions.add("core:toggle-status",function(e){void 0===e?RED.userSettings.toggle("view-node-status"):(L=e,RED.nodes.eachNode(function(e){e.dirty=!0}),Te())}),RED.actions.add("core:move-selection-up",function(){le(0,-1)}),RED.actions.add("core:step-selection-up",function(){le(0,-20)}),RED.actions.add("core:move-selection-right",function(){le(1,0)}),RED.actions.add("core:step-selection-right",function(){le(20,0)}),RED.actions.add("core:move-selection-down",function(){le(0,1)}),RED.actions.add("core:step-selection-down",function(){le(0,20)}),RED.actions.add("core:move-selection-left",function(){le(-1,0)}),RED.actions.add("core:step-selection-left",function(){le(-20,0)})},state:function(e){if(null==e)return C;C=e},redraw:function(e){e&&(X(),se()),Te()},focus:Ce,importNodes:Oe,calculateTextWidth:fe,select:function(e){if(void 0!==e&&(ie(),"string"==typeof e)){var t=RED.nodes.node(e);t&&(t.selected=!0,t.dirty=!0,O=[{n:t}])}se(),Te()},selection:function(){var e={};return O.length>0&&(e.nodes=O.map(function(e){return e.n})),null!=w&&(e.link=w),e},scale:function(){return a},getLinksAtPoint:function(e,t){for(var n=[],o=J.selectAll(".link_background")[0],i=0;i<o.length;i++){var a=o[i].getBBox();e>=a.x&&t>=a.y&&e<=a.x+a.width&&t<=a.y+a.height&&n.push(o[i])}return n},reveal:function(e){if(RED.nodes.workspace(e)||RED.nodes.subflow(e))RED.workspaces.show(e);else{var t=RED.nodes.node(e);if("config"!==t._def.category&&t.z){t.highlighted=!0,t.dirty=!0,RED.workspaces.show(t.z);var n=[$("#chart").width(),$("#chart").height()],o=[$("#chart").scrollLeft(),$("#chart").scrollTop()];if(t.x<o[0]||t.y<o[1]||t.x>n[0]+o[0]||t.y>n[1]+o[1]){var i="-="+(o[0]-t.x+n[0]/2),a="-="+(o[1]-t.y+n[1]/2);$("#chart").animate({scrollLeft:i,scrollTop:a},200)}if(!t._flashing){t._flashing=!0;var s=22,r=function(){s--,t.dirty=!0,s>=0?(t.highlighted=!t.highlighted,setTimeout(r,100)):(t.highlighted=!1,delete t._flashing),RED.view.redraw()};r()}}else"config"===t._def.category&&RED.sidebar.config.show(e)}},gridSize:function(e){if(void 0===e)return f;f=e,W()}}}(),RED.sidebar=function(){var e=RED.tabs.create({id:"sidebar-tabs",onchange:function(e){$("#sidebar-content").children().hide(),$("#sidebar-footer").children().hide(),e.onchange&&e.onchange.call(e),$(e.wrapper).show(),e.toolbar&&$(e.toolbar).show()},onremove:function(e){$(e.wrapper).hide(),e.onremove&&e.onremove.call(e)},minimumActiveTabWidth:110}),t={};var n={};function o(t){t?($("#main-container").removeClass("sidebar-closed"),e.resize()):$("#main-container").addClass("sidebar-closed"),RED.events.emit("sidebar:resize")}function i(n){n&&(a(n)||e.addTab(t[n]),e.activateTab(n),RED.menu.isSelected("menu-item-sidebar")||RED.menu.setSelected("menu-item-sidebar",!0))}function a(t){return e.contains(t)}return $("#sidebar-separator").draggable({axis:"x",start:function(e,t){n.closing=!1,n.opening=!1;var o=$(window).width();if(n.start=t.position.left,n.chartWidth=$("#workspace").width(),n.chartRight=o-$("#workspace").width()-$("#workspace").offset().left-2,!RED.menu.isSelected("menu-item-sidebar")){n.opening=!0;$("#sidebar").addClass("closing"),$("#workspace").css("right",7),$("#editor-stack").css("right",8),$("#sidebar").width(0),RED.menu.setSelected("menu-item-sidebar",!0),RED.events.emit("sidebar:resize")}n.width=$("#sidebar").width()},drag:function(t,o){var i=o.position.left-n.start,a=n.width-i;n.opening&&(a-=3),a>150&&n.chartWidth+i<200&&(o.position.left=200+n.start-n.chartWidth,i=o.position.left-n.start,a=n.width-i),a<150?(n.closing||($("#sidebar").addClass("closing"),n.closing=!0),n.opening||(a=150,o.position.left=n.width-(150-n.start),i=o.position.left-n.start)):a>150&&(n.closing||n.opening)&&(n.closing=!1,$("#sidebar").removeClass("closing"));var s=n.chartRight-i;$("#workspace").css("right",s),$("#editor-stack").css("right",s+1),$("#sidebar").width(a),e.resize(),RED.events.emit("sidebar:resize")},stop:function(e,t){n.closing&&($("#sidebar").removeClass("closing"),RED.menu.setSelected("menu-item-sidebar",!1),$("#sidebar").width()<180&&($("#sidebar").width(180),$("#workspace").css("right",187),$("#editor-stack").css("right",188))),$("#sidebar-separator").css("left","auto"),$("#sidebar-separator").css("right",$("#sidebar").width()+2+"px"),RED.events.emit("sidebar:resize")}}),{init:function(){RED.actions.add("core:toggle-sidebar",function(e){void 0===e?RED.menu.toggleSelected("menu-item-sidebar"):o(e)}),i(),RED.sidebar.info.init(),RED.sidebar.config.init(),$(window).width()<600&&RED.menu.setSelected("menu-item-sidebar",!1)},addTab:function(n,o,a,s){var r;"string"==typeof n?r={id:o.id,label:n,name:n,content:o,closeable:a,visible:s}:"object"==typeof n&&(r=n),r.wrapper=$("<div>",{style:"height:100%"}).appendTo("#sidebar-content"),r.wrapper.append(r.content),r.wrapper.hide(),r.enableOnEdit||(r.shade=$("<div>",{class:"sidebar-shade hide"}).appendTo(r.wrapper)),r.toolbar&&($("#sidebar-footer").append(r.toolbar),$(r.toolbar).hide()),r.id,RED.menu.addItem("menu-item-view-menu",{id:"menu-item-view-menu-"+r.id,label:r.name,onselect:function(){i(r.id)},group:"sidebar-tabs"}),t[r.id]=r,!1!==r.visible&&e.addTab(t[r.id])},removeTab:function(n){e.removeTab(n),$(t[n].wrapper).remove(),t[n].footer&&t[n].footer.remove(),delete t[n],RED.menu.removeItem("menu-item-view-menu-"+n)},show:i,containsTab:a,toggleSidebar:o}}(),RED.palette=function(){var e=["config","unknown","deprecated"],t=["subflows","input","output","function","social","mobile","storage","analysis","advanced"],n={};function o(e,t){t=(t||e).replace(/_/g," ");var o=$('<div id="palette-container-'+e+'" class="palette-category palette-close hide"><div id="palette-header-'+e+'" class="palette-header"><i class="expanded fa fa-angle-down"></i><span>'+t+'</span></div><div class="palette-content" id="palette-base-category-'+e+'"><div id="palette-'+e+'-input"></div><div id="palette-'+e+'-output"></div><div id="palette-'+e+'-function"></div></div></div>').appendTo("#palette-container");n[e]={container:o,close:function(){o.removeClass("palette-open"),o.addClass("palette-closed"),$("#palette-base-category-"+e).slideUp(),$("#palette-header-"+e+" i").removeClass("expanded")},open:function(){o.addClass("palette-open"),o.removeClass("palette-closed"),$("#palette-base-category-"+e).slideDown(),$("#palette-header-"+e+" i").addClass("expanded")},toggle:function(){o.hasClass("palette-open")?n[e].close():n[e].open()}},$("#palette-header-"+e).on("click",function(t){n[e].toggle()})}function i(e,t,n,o){for(var i=n.split(/[ -]/),a=[],s=i[0],r=(RED.view.calculateTextWidth(s,"palette_label",0),1);r<i.length;r++){var d=RED.view.calculateTextWidth(s+" "+i[r],"palette_label",0);d<82?(s+=" "+i[r],d):(a.push(s),s=i[r],RED.view.calculateTextWidth(s,"palette_label",0))}a.push(s);var l,c=a.join("<br/>"),p=8+20*a.length;t.css({height:p+"px"}),t.find(".palette_label").html(c).attr("dir",RED.text.bidi.resolveBaseTextDir(c)),t.find(".palette_port").css({top:p/2-5+"px"});try{var u="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b></p>";n!=e&&(u="<p><b>"+RED.text.bidi.enforceTextDirectionWithUCC(n)+"</b><br/><i>"+e+"</i></p>"),l=$(u+(o||($("script[data-help-name='"+e+"']").html()||"<p>"+RED._("palette.noInfo")+"</p>")).trim()).filter(function(e){return 1==this.nodeType&&"P"==this.nodeName||3==this.nodeType&&this.textContent.trim().length>0}).slice(0,2)}catch(t){console.log("Error generating pop-over label for ",e),console.log(t.toString()),l="<p><b>"+n+"</b></p><p>"+RED._("palette.noInfo")+"</p>"}t.data("popover").setContent(l)}function a(e){return e.replace(" ","_").replace(".","_").replace(":","_")}function s(s,r){var d=a(s);if(!$("#palette_node_"+d).length&&-1===e.indexOf(r.category)){var l=r.category.replace(/ /g,"_"),c=l.split("-")[0],p=document.createElement("div");p.id="palette_node_"+d,p.type=s;var u=/^(.*?)([ -]in|[ -]out)?$/.exec(s)[1];if(void 0!==r.paletteLabel)try{u=("function"==typeof r.paletteLabel?r.paletteLabel.call(r):r.paletteLabel)||""}catch(e){console.log("Definition error: "+s+".paletteLabel",e)}if($("<div/>",{class:"palette_label"+("right"==r.align?" palette_label_right":"")}).appendTo(p),p.className="palette_node",r.icon){var f=RED.utils.getNodeIcon(r),h=$("<div/>",{class:"palette_icon_container"+("right"==r.align?" palette_icon_container_right":"")}).appendTo(p);$("<div/>",{class:"palette_icon",style:"background-image: url("+f+")"}).appendTo(h)}if(p.style.backgroundColor=r.color,r.outputs>0){var g=document.createElement("div");g.className="palette_port palette_port_output",p.appendChild(g)}if(r.inputs>0){var v=document.createElement("div");v.className="palette_port palette_port_input",p.appendChild(v)}if(0===$("#palette-base-category-"+c).length)if(-1!==t.indexOf(c))o(c,RED._("node-red:palette.label."+c,{defaultValue:c}));else{var m=r.set.id;o(c,RED._(m+":palette.label."+c,{defaultValue:c}))}$("#palette-container-"+c).show(),0===$("#palette-"+l).length&&$("#palette-base-category-"+c).append('<div id="palette-'+l+'"></div>'),$("#palette-"+l).append(p),p.onmousedown=function(e){e.preventDefault()};var b=RED.popover.create({target:$(p),trigger:"hover",width:"300px",content:"hi",delay:{show:750,hide:50}});$(p).data("popover",b),$(p).click(function(){var e;RED.view.focus(),e=0===s.indexOf("subflow:")?marked(RED.nodes.subflow(s.substring(8)).info||""):$("script[data-help-name='"+p.type+"']").html()||"",RED.sidebar.info.set(e)});var y,w,D,E,R=$("#chart"),k=R.offset(),x=$("#chart>svg").get(0);$(p).draggable({helper:"clone",appendTo:"body",revert:!0,revertDuration:50,containment:"#main-container",start:function(){RED.view.focus()},stop:function(){d3.select(".link_splice").classed("link_splice",!1),E&&(clearTimeout(E),E=null)},drag:function(e,t){t.position.left+=17.5,r.inputs>0&&r.outputs>0&&(w=t.position.left+t.helper.width()/2-k.left+R.scrollLeft(),D=t.position.top+t.helper.height()/2-k.top+R.scrollTop(),E||(E=setTimeout(function(){var e=[],n=1/0,o=null;if(x.getIntersectionList){var i=x.createSVGRect();i.x=w,i.y=D,i.width=1,i.height=1,e=x.getIntersectionList(i,x),w/=RED.view.scale(),D/=RED.view.scale()}else w/=RED.view.scale(),D/=RED.view.scale(),e=RED.view.getLinksAtPoint(w,D);for(var a=0;a<e.length;a++)if(d3.select(e[a]).classed("link_background"))for(var s=e[a].getTotalLength(),r=0;r<s;r+=10){var d=e[a].getPointAtLength(r),l=(d.x-w)*(d.x-w)+(d.y-D)*(d.y-D);l<200&&l<n&&(n=l,o=e[a])}y&&y!==o&&d3.select(y.parentNode).classed("link_splice",!1),o?d3.select(o.parentNode).classed("link_splice",!0):d3.select(".link_splice").classed("link_splice",!1),y!==o&&(o?$(t.helper).data("splice",d3.select(o).data()[0]):$(t.helper).removeData("splice")),y=o,E=null},200)))}});var _=null;"subflows"==r.category&&($(p).dblclick(function(e){RED.workspaces.show(s.substring(8)),e.preventDefault()}),_=marked(r.info||"")),i(s,$(p),u,_),1===$("#palette-container-"+l).find(".palette_node").length&&n[l].open()}}function r(e){var t=a(e),n=$("#palette_node_"+t),o=n.closest(".palette-category");n.remove(),0===o.find(".palette_node").length&&o.find("i").hasClass("expanded")&&(o.find(".palette-content").slideToggle(),o.find("i").toggleClass("expanded"))}function d(e){var t=a(e),n=$("#palette_node_"+t);n.hide();for(var o=n.closest(".palette-category"),i=o.find(".palette_node"),s=0,r=0;r<i.length;r++)"none"===$(i[r]).css("display")&&(s+=1);s===i.length&&o.hide()}function l(e){var t=a(e),n=$("#palette_node_"+t);n.closest(".palette-category").show(),n.show()}return{init:function(){RED.events.on("registry:node-type-added",function(e){var t=RED.nodes.getType(e);s(e,t),t.onpaletteadd&&"function"==typeof t.onpaletteadd&&t.onpaletteadd.call(t)}),RED.events.on("registry:node-type-removed",function(e){r(e)}),RED.events.on("registry:node-set-enabled",function(e){for(var t=0;t<e.types.length;t++){l(e.types[t]);var n=RED.nodes.getType(e.types[t]);n.onpaletteadd&&"function"==typeof n.onpaletteadd&&n.onpaletteadd.call(n)}}),RED.events.on("registry:node-set-disabled",function(e){for(var t=0;t<e.types.length;t++){d(e.types[t]);var n=RED.nodes.getType(e.types[t]);n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),RED.events.on("registry:node-set-removed",function(e){if(e.added)for(var t=0;t<e.types.length;t++){r(e.types[t]);var n=RED.nodes.getType(e.types[t]);n.onpaletteremove&&"function"==typeof n.onpaletteremove&&n.onpaletteremove.call(n)}}),$("#palette > .palette-spinner").show(),$("#palette-search input").searchBox({delay:100,change:function(){!function(e){var t=new RegExp(e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),"i");$("#palette-container .palette_node").each(function(n,o){var i=$(o).find(".palette_label").text();""===e||t.test(o.id)||t.test(i)?$(this).show():$(this).hide()});for(var o in n)n.hasOwnProperty(o)&&(0===n[o].container.find(".palette_node").filter(function(){return"none"!==$(this).css("display")}).length?n[o].close():n[o].open())}($(this).val())}});var e=t;RED.settings.paletteCategories?e=RED.settings.paletteCategories:RED.settings.theme("palette.categories")&&(e=RED.settings.theme("palette.categories")),Array.isArray(e)||(e=t),e.forEach(function(e){o(e,RED._("palette.label."+e,{defaultValue:e}))}),$("#palette-collapse-all").on("click",function(e){e.preventDefault();for(var t in n)n.hasOwnProperty(t)&&n[t].close()}),$("#palette-expand-all").on("click",function(e){e.preventDefault();for(var t in n)n.hasOwnProperty(t)&&n[t].open()})},add:s,remove:r,hide:d,show:l,refresh:function(){RED.nodes.eachSubflow(function(e){var t=$("#palette_node_subflow_"+e.id.replace(".","_")),n=t.find(".palette_port_input"),o=t.find(".palette_port_output");if(0===n.length&&e.in.length>0){var a=document.createElement("div");a.className="palette_port palette_port_input",t.append(a)}else 0!==n.length&&0===e.in.length&&n.remove();if(0===o.length&&e.out.length>0){var s=document.createElement("div");s.className="palette_port palette_port_output",t.append(s)}else 0!==o.length&&0===e.out.length&&o.remove();i(e.type+":"+e.id,t,e.name,marked(e.info||""))})}}}(),RED.sidebar.info=function(){var e,t,n,o,i;marked.setOptions({renderer:new marked.Renderer,gfm:!0,tables:!0,breaks:!1,pedantic:!1,sanitize:!0,smartLists:!0,smartypants:!1});var a={property:!1};function s(){RED.sidebar.show("info")}function r(e){t.show(),$(n.content).empty(),$(o.content).empty();var i,s,r=$('<table class="node-info"></table>'),l=$("<tbody>").appendTo(r);if("tab"===e.type)n.title.html(RED._("sidebar.info.flow")),i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.tabName")+"</td><td></td></tr>").appendTo(l),$(i.children()[1]).html("&nbsp;"+(e.label||"")),i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.id")+"</td><td></td></tr>").appendTo(l),RED.utils.createObjectElement(e.id).appendTo(i.children()[1]),i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.status")+"</td><td></td></tr>").appendTo(l),$(i.children()[1]).html(e.disabled?RED._("sidebar.info.disabled"):RED._("sidebar.info.enabled"));else{n.title.html(RED._("sidebar.info.node")),"subflow"!==e.type&&e.name&&$('<tr class="node-info-node-row"><td>'+RED._("common.label.name")+'</td><td>&nbsp;<span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e.name)+'">'+e.name+"</span></td></tr>").appendTo(l),$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.type")+"</td><td>&nbsp;"+e.type+"</td></tr>").appendTo(l),i=$('<tr class="node-info-node-row"><td>'+RED._("sidebar.info.id")+"</td><td></td></tr>").appendTo(l),RED.utils.createObjectElement(e.id).appendTo(i.children()[1]);var c=/^subflow(:(.+))?$/.exec(e.type);if(!c&&"subflow"!=e.type&&"comment"!=e.type&&e._def){var p=0,u=e._def.defaults;for(var f in u)if("name"!=f&&u.hasOwnProperty(f)){var h=e[f];if(p++,i=$('<tr class="node-info-property-row'+(a.property?"":" hide")+'"><td>'+f+"</td><td></td></tr>").appendTo(l),u[f].type){var g=RED.nodes.node(h);if(g){var v=RED.utils.getNodeLabel(g,h),m=i.children()[1],b=$("<span>",{class:""}).appendTo(m),y=$("<div>",{class:"palette_node palette_node_small"}).appendTo(b),w=g._def.color,D=RED.utils.getNodeIcon(g._def);y.css({backgroundColor:w,cursor:"pointer"});var E=$("<div/>",{class:"palette_icon_container"}).appendTo(y);$("<div/>",{class:"palette_icon",style:"background-image: url("+D+")"}).appendTo(E);$("<span></span>").css({verticalAlign:"top",marginLeft:"6px"}).html(v).appendTo(m);y.on("dblclick",function(){RED.editor.editConfig("",g.type,g.id)})}else RED.utils.createObjectElement(void 0).appendTo(i.children()[1])}else RED.utils.createObjectElement(h).appendTo(i.children()[1])}p>0&&$('<tr class="node-info-property-expand blank"><td colspan="2"><a href="#" class=" node-info-property-header'+(a.property?" expanded":"")+'"><span class="node-info-property-show-more">'+RED._("sidebar.info.showMore")+'</span><span class="node-info-property-show-less">'+RED._("sidebar.info.showLess")+'</span> <i class="fa fa-caret-down"></i></a></td></tr>').appendTo(l)}if(c){s=c[2]?RED.nodes.subflow(c[2]):e,$('<tr class="blank"><th colspan="2">'+RED._("sidebar.info.subflow")+"</th></tr>").appendTo(l);var R=0,k="subflow:"+s.id;RED.nodes.eachNode(function(e){e.type===k&&R++}),$('<tr class="node-info-subflow-row"><td>'+RED._("common.label.name")+'</td><td><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(s.name)+'">'+s.name+"</span></td></tr>").appendTo(l),$('<tr class="node-info-subflow-row"><td>'+RED._("sidebar.info.instances")+"</td><td>"+R+"</td></tr>").appendTo(l)}}$(r).appendTo(n.content);var x="";s||"comment"===e.type||"tab"===e.type?"tab"===e.type&&(x=marked(e.info||"")):x=$("script[data-help-name='"+e.type+"']").html()||"";if(s)x+=marked(s.info||"");else if(e._def&&e._def.info){var _=e._def.info,T="function"==typeof _?_.call(e):_;x+=marked(T)}x&&d(x),$(".node-info-property-header").click(function(e){e.preventDefault(),a.property=!a.property,$(this).toggleClass("expanded",a.property),$(".node-info-property-row").toggle(a.property)})}function d(e){var t,n=(t=$('<div class="node-help"><span class="bidiAware" dir="'+RED.text.bidi.resolveBaseTextDir(e)+'">'+e+"</span></div>"),$(t).find("a").each(function(e){var t=$(this).attr("href");/^https?:/.test(t)&&$(this).attr("target","_blank")}),t).appendTo(o.content);n.find(".bidiAware").contents().filter(function(){return 3===this.nodeType&&""!==this.textContent.trim()}).wrap("<span></span>");n.find("H3").wrapInner('<a class="node-info-header expanded" href="#"></a>').find("a").prepend('<i class="fa fa-angle-right">').click(function(e){e.preventDefault();for(var t=$(this).hasClass("expanded"),n=$(this).parent().next();1===n.length&&"H3"!==n[0].nodeName;)n.toggle(!t),n=n.next();$(this).toggleClass("expanded",!t)})}var l=function(){var e,t,n=!0,o=1e3,a=15e3,s=-1;function r(){for(var n,o=Math.floor(Math.random()*s),r=RED._("infotips:info.tip"+o);n=/({{(.*?)}})/.exec(r);){var l=RED.keyboard.getShortcut(n[2]);if(!l)return;r=r.replace(n[1],RED.keyboard.formatKey(l.key))}for(;n=/(\[(.*?)\])/.exec(r);)r=r.replace(n[1],RED.keyboard.formatKey(n[2]));i.html(r).fadeIn(200),e&&(e=null,t=setInterval(d,a))}function d(){i.fadeOut(300,function(){r()})}function l(){if($(".sidebar-node-info").addClass("show-tips"),n&&!e&&!t){if(-1===s)do{s++}while(RED._("infotips:info.tip"+s)!=="infotips:info.tip"+s);e=setTimeout(r,o)}}function c(){$(".sidebar-node-info").removeClass("show-tips"),clearInterval(t),clearTimeout(e),t=null,e=null}return RED.actions.add("core:toggle-show-tips",function(e){void 0===e?RED.userSettings.toggle("view-show-tips"):(n=e)?l():c()}),{start:l,stop:c,next:function(){clearInterval(t),e=!0,r()},enabled:function(){return n}}}();function c(){t.hide()}return RED.events.on("view:selection-changed",function(e){if(e.nodes){if(1==e.nodes.length){var t=e.nodes[0];"subflow"===t.type&&t.direction?r(RED.nodes.subflow(t.z)):r(t)}}else{var n=RED.workspaces.active(),o=RED.nodes.workspace(n)||RED.nodes.subflow(n);if(o)r(o);else{var i=RED.nodes.workspace(RED.workspaces.active());i&&i.info?r(i):c()}}}),{init:function(){(e=document.createElement("div")).className="sidebar-node-info",RED.actions.add("core:show-info-tab",s);var a=$("<div>",{class:"sidebar-node-info-stack"}).appendTo(e);t=RED.stack.create({container:a}).hide(),n=t.add({title:RED._("sidebar.info.node"),collapsible:!1}),(o=t.add({title:RED._("sidebar.info.information"),collapsible:!1})).content.css("padding","6px"),o.container.css("border-bottom","none");var r=$('<div class="node-info-tips"></div>').appendTo(e);i=$('<div class="node-info-tip"></div>').appendTo(r);var d=$('<div class="node-info-tips-buttons"></div>').appendTo(r);$('<a href="#" class="workspace-footer-button"><i class="fa fa-refresh"></a>').appendTo(d).click(function(e){e.preventDefault(),l.next()}),$('<a href="#" class="workspace-footer-button"><i class="fa fa-times"></a>').appendTo(d).click(function(e){e.preventDefault(),RED.actions.invoke("core:toggle-show-tips"),RED.notify(RED._("sidebar.info.showTips"))}),RED.sidebar.addTab({id:"info",label:RED._("sidebar.info.label"),name:RED._("sidebar.info.name"),content:e,enableOnEdit:!0}),l.enabled()?l.start():l.stop()},show:s,refresh:r,clear:c,set:function(e){t.show(),n.container.hide(),$(o.content).empty(),d(e),$(".sidebar-node-info-stack").scrollTop(0)}}}(),RED.sidebar.config=function(){var e=document.createElement("div");e.className="sidebar-node-config",$('<div class="button-group sidebar-header"><a class="sidebar-header-button-toggle selected" id="workspace-config-node-filter-all" href="#"><span data-i18n="sidebar.config.filterAll"></span></a><a class="sidebar-header-button-toggle" id="workspace-config-node-filter-unused" href="#"><span data-i18n="sidebar.config.filterUnused"></span></a> </div>').appendTo(e);var t=$('<div><a class="sidebar-footer-button" id="workspace-config-node-collapse-all" href="#"><i class="fa fa-angle-double-up"></i></a> <a class="sidebar-footer-button" id="workspace-config-node-expand-all" href="#"><i class="fa fa-angle-double-down"></i></a></div>'),n=$("<div>").appendTo(e),o=$("<div>").appendTo(e),i=$("<div>").appendTo(e),a=!1,s={};function r(e,t,n){if(e=e.replace(/\./i,"-"),s[e])s[e].label!==n&&(s[e].list.parent().find(".config-node-label").text(n),s[e].label=n);else{var o=$('<div class="palette-category workspace-config-node-category" id="workspace-config-node-category-'+e+'"></div>').appendTo(t),i=$('<div class="workspace-config-node-tray-header palette-header"><i class="fa fa-angle-down expanded"></i></div>').appendTo(o);n?$('<span class="config-node-label"/>').text(n).appendTo(i):$('<span class="config-node-label" data-i18n="sidebar.config.'+e+'">').appendTo(i),$('<span class="config-node-filter-info"></span>').appendTo(i),category=$('<ul class="palette-content config-node-list"></ul>').appendTo(o),o.i18n();var a=i.find("i"),r={label:n,list:category,size:function(){return r.list.find("li:not(.config_node_none)").length},open:function(e){a.hasClass("expanded")||(a.addClass("expanded"),e?r.list.show():r.list.slideDown())},close:function(e){a.hasClass("expanded")&&(a.removeClass("expanded"),e?r.list.hide():r.list.slideUp())},isOpen:function(){return a.hasClass("expanded")}};i.on("click",function(e){r.isOpen()?r.close():r.open()}),s[e]=r}return s[e]}function d(e,t){var n=r(e.replace(/\./i,"-")),o=n.list;if(t.sort(function(e,t){return e.type<t.type?-1:e.type>t.type?1:0}),a){var i=t.length;(i-=(t=t.filter(function(e){return!1!==e._def.hasUsers&&0===e.users.length})).length)>0?o.parent().find(".config-node-filter-info").text(RED._("sidebar.config.filtered",{count:i})).show():o.parent().find(".config-node-filter-info").hide()}else o.parent().find(".config-node-filter-info").hide();if(o.empty(),0===t.length)$('<li class="config_node_none" data-i18n="sidebar.config.none">NONE</li>').i18n().appendTo(o),n.close(!0);else{var s="";t.forEach(function(e){var t=RED.utils.getNodeLabel(e,e.id);e.type!=s&&($('<li class="config_node_type">'+e.type+"</li>").appendTo(o),s=e.type);var n=$('<li class="palette_node config_node palette_node_id_'+e.id.replace(/\./g,"-")+'"></li>').appendTo(o);if($('<div class="palette_label"></div>').text(t).appendTo(n),!1!==e._def.hasUsers){$("<div/>",{class:"palette_icon_container  palette_icon_container_right"}).text(e.users.length).appendTo(n);0===e.users.length&&n.addClass("config_node_unused")}n.on("click",function(t){RED.sidebar.info.refresh(e)}),n.on("dblclick",function(t){RED.editor.editConfig("",e.type,e.id)});var i=e.users.map(function(e){return e.id});n.on("mouseover",function(e){RED.nodes.eachNode(function(e){-1!=i.indexOf(e.id)&&(e.highlighted=!0,e.dirty=!0)}),RED.view.redraw()}),n.on("mouseout",function(e){RED.nodes.eachNode(function(e){e.highlighted&&(e.highlighted=!1,e.dirty=!0)}),RED.view.redraw()})}),n.open(!0)}}function l(){var e={global:!0};r("global",n),RED.nodes.eachWorkspace(function(t){e[t.id.replace(/\./g,"-")]=!0,r(t.id,o,t.label)}),RED.nodes.eachSubflow(function(t){e[t.id.replace(/\./g,"-")]=!0,r(t.id,i,t.name)}),$(".workspace-config-node-category").each(function(){var t=$(this).attr("id").substring("workspace-config-node-category-".length);e[t]||($(this).remove(),delete s[t])});var t=[],a={};RED.nodes.eachConfig(function(e){e.z?(a[e.z.replace(/\./g,"-")]=a[e.z.replace(/\./g,"-")]||[],a[e.z.replace(/\./g,"-")].push(e)):e.z||t.push(e)});for(var l in e)e.hasOwnProperty(l)&&d(l,a[l]||[]);d("global",t)}return{init:function(){RED.sidebar.addTab({id:"config",label:RED._("sidebar.config.label"),name:RED._("sidebar.config.name"),content:e,toolbar:t,closeable:!0,visible:!1,onchange:function(){l()}}),RED.actions.add("core:show-config-tab",function(){RED.sidebar.show("config")}),$("#workspace-config-node-collapse-all").on("click",function(e){e.preventDefault();for(var t in s)s.hasOwnProperty(t)&&s[t].close()}),$("#workspace-config-node-expand-all").on("click",function(e){e.preventDefault();for(var t in s)s.hasOwnProperty(t)&&s[t].size()>0&&s[t].open()}),$("#workspace-config-node-filter-all").on("click",function(e){e.preventDefault(),a&&($(this).addClass("selected"),$("#workspace-config-node-filter-unused").removeClass("selected"),a=!a,l())}),$("#workspace-config-node-filter-unused").on("click",function(e){e.preventDefault(),a||($(this).addClass("selected"),$("#workspace-config-node-filter-all").removeClass("selected"),a=!a,l())})},show:function(e){"boolean"==typeof e&&(e?$("#workspace-config-node-filter-unused").click():$("#workspace-config-node-filter-all").click()),l(),"string"==typeof e&&($("#workspace-config-node-filter-all").click(),e=e.replace(/\./g,"-"),setTimeout(function(){var t=$(".palette_node_id_"+e),n=t.position().top,o=t.height(),i=$(".sidebar-node-config"),a=i.height();n+o>a?i.animate({scrollTop:"-="+(a-(n+o)-30)},150):n<0&&i.animate({scrollTop:"+="+(n-10)},150);var s=21,r=function(){s%2==0?t.removeClass("node_highlighted"):t.addClass("node_highlighted"),--s>=0&&setTimeout(r,100)};r()},100)),RED.sidebar.show("config")},refresh:l}}(),RED.palette.editor=function(){var e,t,n,o,i,a,s=[],r=[],d={},l={},c={},p={},u="";function f(e,t){var n=Date.now()-e;n=n<300?300:0,setTimeout(function(){t()},n)}function h(e,t,n,o){n.show();var i=Date.now();$.ajax({url:"nodes/"+e,type:"PUT",data:JSON.stringify({enabled:t}),contentType:"application/json; charset=utf-8"}).done(function(e,t,a){f(i,function(){n.hide(),o()})}).fail(function(e,t,a){f(i,function(){n.hide(),o(e)})})}function g(e,t,n,o){var i={module:e};void 0===o?(o=n,n=t):i.version=t,n.show(),$.ajax({url:"nodes",type:"POST",data:JSON.stringify(i),contentType:"application/json; charset=utf-8"}).done(function(e,t,i){n.hide(),o()}).fail(function(e,t,i){n.hide(),o(e)})}function v(e){p.hasOwnProperty(e)||(p[e]=setTimeout(function(){delete p[e],b(e)},100))}function m(e){var t=/^rgba?\(\s*(\d+),\s*(\d+),\s*(\d+)[,)]/.exec(e);if(t){var n=parseInt(t[1]),o=parseInt(t[2]),i=parseInt(t[3]);if((299*n+587*o+114*i)/1e3>160)return"rgb("+(n=Math.floor(.8*n))+","+(o=Math.floor(.8*o))+","+(i=Math.floor(.8*i))+")"}return e}function b(e){if(c.hasOwnProperty(e)){var t=c[e].info,n=c[e].elements;if(n){var i=0,a=0;c[e].totalUseCount=0,c[e].setUseCount={};for(var s in t.sets)if(t.sets.hasOwnProperty(s)){var r=0,p=t.sets[s],u=n.sets[s];p.enabled&&(i+=p.types.length),a+=p.types.length;for(var f=0;f<t.sets[s].types.length;f++){var h=t.sets[s].types[f];r+=l[h]||0;var g=u.swatches[h];if(p.enabled){var v=RED.nodes.getType(h);v&&v.color?(g.css({background:v.color}),g.css({border:"1px solid "+m(g.css("backgroundColor"))})):g.css({background:"#eee",border:"1px dashed #999"})}else g.css({background:"#eee",border:"1px dashed #999"})}c[e].setUseCount[s]=r,c[e].totalUseCount+=r,r>0?(u.enableButton.html(RED._("palette.editor.inuse")),u.enableButton.addClass("disabled")):(u.enableButton.removeClass("disabled"),p.enabled?u.enableButton.html(RED._("palette.editor.disable")):u.enableButton.html(RED._("palette.editor.enable"))),u.setRow.toggleClass("palette-module-set-disabled",!p.enabled)}var b=i===a?a:i+" / "+a;n.setCount.html(RED._("palette.editor.nodeCount",{count:a,label:b})),c[e].totalUseCount>0?(n.enableButton.html(RED._("palette.editor.inuse")),n.enableButton.addClass("disabled"),n.removeButton.hide()):(n.enableButton.removeClass("disabled"),t.local&&n.removeButton.css("display","inline-block"),0===i?n.enableButton.html(RED._("palette.editor.enableall")):n.enableButton.html(RED._("palette.editor.disableall")),n.container.toggleClass("disabled",0===i))}t.pending_version?(n.versionSpan.html(t.version+' <i class="fa fa-long-arrow-right"></i> '+t.pending_version).appendTo(n.metaRow),n.updateButton.html(RED._("palette.editor.updated")).addClass("disabled").show()):d.hasOwnProperty(e)&&1===function(e,t){for(var n=e.split(".").map(function(e){return parseInt(e)}),o=t.split(".").map(function(e){return parseInt(e)}),i=0;i<3;i++){var a=n[i]-o[i];if(a<0)return-1;if(a>0)return 1}return 0}(d[e].version,t.version)?(n.updateButton.show(),n.updateButton.html(RED._("palette.editor.update",{version:d[e].version}))):n.updateButton.hide()}else{c[e]={info:RED.nodes.registry.getModule(e)};var y=[e];for(var w in c[e].info.sets)c[e].info.sets.hasOwnProperty(w)&&(y.push(w),y=y.concat(c[e].info.sets[w].types));c[e].index=y.join(",").toLowerCase(),o.editableList("addItem",c[e])}}var y,w,D=[],E=!1,R=T;function k(e,t,o,i){if(D.push(e||i),e?E=!0:(i.modules&&(i.modules.forEach(function(e){d[e.id]=e,e.index=[e.id],e.keywords&&(e.index=e.index.concat(e.keywords)),e.updated_at?e.timestamp=new Date(e.updated_at).getTime():e.timestamp=0,e.index=e.index.join(",").toLowerCase()}),s=s.concat(i.modules)),n.searchBox("count",s.length)),a>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>"+D.length+"/"+a),D.length===a){E&&RED.notify(RED._("palette.editor.errors.catalogLoadFailed",{url:t}),"error",!1,8e3);var r=250-(Date.now()-y);setTimeout(function(){$("#palette-module-install-shade").hide()},Math.max(r,0))}}function x(){if(0===s.length){s=[],d={},i.editableList("empty"),$(".palette-module-shade-status").html(RED._("palette.editor.loading"));var e=RED.settings.theme("palette.catalogues")||["https://catalogue.nodered.org/catalogue.json"];D=[],E=!1,a=e.length,e.length>1&&$(".palette-module-shade-status").html(RED._("palette.editor.loading")+"<br>0/"+e.length),$("#palette-module-install-shade").show(),y=Date.now();var t=0;e.forEach(function(e,o){$.getJSON(e,{_:(new Date).getTime()},function(t){k(null,e,0,t),function(){for(var e in c)c.hasOwnProperty(e)&&b(e)}()}).fail(function(t,n,o){k(t,e)}).always(function(){++t===a&&n.searchBox("change")})})}}function _(){if(i.editableList("empty"),""!==n.searchBox("value").trim()){r.sort(R);for(var e=0;e<Math.min(10,r.length);e++)i.editableList("addItem",r[e]);0===r.length&&i.editableList("addItem",{}),r.length>10&&i.editableList("addItem",{start:10,more:r.length-10})}else i.editableList("addItem",{count:s.length})}function T(e,t){return e.info.id.localeCompare(t.info.id)}function C(e,t){return-1*(e.info.timestamp-t.info.timestamp)}function O(){return x(),e.activateTab("nodes"),w}return{init:function(){!1!==RED.settings.theme("palette.editable")&&(function(){w=$('<div id="user-settings-tab-palette"></div>');var a=$('<div id="palette-editor"><ul id="palette-editor-tabs"></ul></div>').appendTo(w);e=RED.tabs.create({element:w.find("#palette-editor-tabs"),onchange:function(e){a.find(".palette-editor-tab").hide(),e.content.show(),t&&t.searchBox("value",""),n&&n.searchBox("value",""),"install"===e.id?n&&n.focus():t&&t.focus()},minimumActiveTabWidth:110});var l=$("<div>",{class:"palette-editor-tab"}).appendTo(a);e.addTab({id:"nodes",label:RED._("palette.editor.tab-nodes"),content:l});var p=$("<div>",{class:"palette-search"}).appendTo(l);t=$('<input type="text" data-i18n="[placeholder]palette.filter"></input>').appendTo(p).searchBox({delay:200,change:function(){!function(e){u=e.toLowerCase();var n=o.editableList("filter"),i=o.editableList("length");""===e?t.searchBox("count"):t.searchBox("count",n+" / "+i)}($(this).val())}}),o=$("<ol>",{id:"palette-module-list",style:"position: absolute;top: 35px;bottom: 0;left: 0;right: 0px;"}).appendTo(l).editableList({addButton:!1,scrollOnAdd:!1,sort:function(e,t){return e.info.name.localeCompare(t.info.name)},filter:function(e){return""===u||""===u||e.index.indexOf(u)>-1},addItem:function(e,t,n){var o=n.info;if(o){var i=$("<div>",{class:"palette-module-header"}).appendTo(e),a=$('<div class="palette-module-meta palette-module-name"><i class="fa fa-cube"></i></div>').appendTo(i);$("<span>").html(o.name).appendTo(a);var s=$('<div class="palette-module-meta palette-module-version"><i class="fa fa-tag"></i></div>').appendTo(i),r=$("<span>").html(o.version).appendTo(s),l=$("<div>",{class:"palette-module-meta"}).appendTo(i),c=$('<a href="#" class="editor-button editor-button-small palette-module-set-button"><i class="fa fa-angle-right palette-module-node-chevron"></i> </a>').appendTo(l),p=$("<span>").appendTo(c),u=$("<div>",{class:"palette-module-button-group"}).appendTo(l),f=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.update")).appendTo(u);f.attr("id","up_"+Math.floor(1e9*Math.random())),f.click(function(e){e.preventDefault(),$(this).hasClass("disabled")||($("#palette-module-install-confirm").data("module",o.name),$("#palette-module-install-confirm").data("version",d[o.name].version),$("#palette-module-install-confirm").data("shade",y),$("#palette-module-install-confirm-body").html(o.local?RED._("palette.editor.confirm.update.body"):RED._("palette.editor.confirm.cannotUpdate.body")),$(".palette-module-install-confirm-button-install").hide(),$(".palette-module-install-confirm-button-remove").hide(),o.local?$(".palette-module-install-confirm-button-update").show():$(".palette-module-install-confirm-button-update").hide(),$("#palette-module-install-confirm").dialog("option","title",RED._("palette.editor.confirm.update.title")).dialog("open"))});var g=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.remove")).appendTo(u);g.attr("id","up_"+Math.floor(1e9*Math.random())),g.click(function(e){e.preventDefault(),$("#palette-module-install-confirm").data("module",o.name),$("#palette-module-install-confirm").data("shade",y),$("#palette-module-install-confirm-body").html(RED._("palette.editor.confirm.remove.body")),$(".palette-module-install-confirm-button-install").hide(),$(".palette-module-install-confirm-button-remove").show(),$(".palette-module-install-confirm-button-update").hide(),$("#palette-module-install-confirm").dialog("option","title",RED._("palette.editor.confirm.remove.title")).dialog("open")}),o.local||g.hide();var m=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.disableall")).appendTo(u),b=$("<div>",{class:"palette-module-content"}).appendTo(e),y=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(e);n.elements={updateButton:f,removeButton:g,enableButton:m,setCount:p,container:e,shade:y,versionSpan:r,sets:{}},c.click(function(t){t.preventDefault(),e.hasClass("expanded")?(e.removeClass("expanded"),b.slideUp()):(e.addClass("expanded"),b.slideDown())});var w=Object.keys(o.sets);w.sort(function(e,t){return e.toLowerCase().localeCompare(t.toLowerCase())}),w.forEach(function(e){var t=o.sets[e],i=$("<div>",{class:"palette-module-set"}).appendTo(b),a=$("<div>",{class:"palette-module-set-button-group"}).appendTo(i),s={};t.types.forEach(function(e){var t=$("<div>",{class:"palette-module-type"}).appendTo(i);s[e]=$("<span>",{class:"palette-module-type-swatch"}).appendTo(t),$("<span>",{class:"palette-module-type-node"}).html(e).appendTo(t)});var r=$('<a href="#" class="editor-button editor-button-small"></a>').appendTo(a);r.click(function(o){if(o.preventDefault(),0===n.setUseCount[e]){var i=RED.nodes.registry.getNodeSet(t.id);y.show();var a=!i.enabled;h(t.id,a,y,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors."+(a?"enable":"disable")+"Failed",{module:id,message:e.responseJSON.message}))})}}),n.elements.sets[t.name]={setRow:i,enableButton:r,swatches:s}}),m.click(function(t){t.preventDefault(),0===n.totalUseCount&&h(o.name,e.hasClass("disabled"),y,function(e){e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:id,message:e.responseJSON.message}))})}),v(o.name)}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(e)}});var f=$("<div>",{class:"palette-editor-tab hide"}).appendTo(a);e.addTab({id:"install",label:RED._("palette.editor.tab-install"),content:f});var m=$("<div>",{class:"palette-editor-toolbar"}).appendTo(f),b=$("<div>",{class:"palette-search"}).appendTo(f);n=$('<input type="text" data-i18n="[placeholder]palette.search"></input>').appendTo(b).searchBox({delay:300,change:function(){var e=$(this).val().trim().toLowerCase();e.length>0?(r=s.filter(function(t){return t.index.indexOf(e)>-1}).map(function(e){return{info:e}}),_(),n.searchBox("count",r.length+" / "+s.length)):(n.searchBox("count",s.length),i.editableList("empty"),i.editableList("addItem",{count:s.length}))}}),$("<span>").html(RED._("palette.editor.sort")+" ").appendTo(m);var y=$('<span class="button-group"></span>').appendTo(m),D=$('<a href="#" class="sidebar-header-button-toggle selected" data-i18n="palette.editor.sortAZ"></a>').appendTo(y),E=$('<a href="#" class="sidebar-header-button-toggle" data-i18n="palette.editor.sortRecent"></a>').appendTo(y);D.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),E.removeClass("selected"),R=T,_())}),E.click(function(e){e.preventDefault(),$(this).hasClass("selected")||($(this).addClass("selected"),D.removeClass("selected"),R=C,_())});var k=$("<span>").appendTo(m);$('<a href="#" class="sidebar-header-button"><i class="fa fa-refresh"></i></a>').appendTo(k).click(function(e){e.preventDefault(),s=[],d={},x()}),i=$("<ol>",{style:"position: absolute;top: 78px;bottom: 0;left: 0;right: 0px;"}).appendTo(f).editableList({addButton:!1,scrollOnAdd:!1,addItem:function(e,t,n){if(n.count)$("<div>",{class:"red-ui-search-empty"}).html(RED._("palette.editor.moduleCount",{count:n.count})).appendTo(e);else if(n.more){e.addClass("palette-module-more");var o=$("<div>",{class:"palette-module-header palette-module"}).appendTo(e),a=$('<a href="#"></a>').html(RED._("palette.editor.more",{count:n.more})).appendTo(o);a.click(function(e){e.preventDefault(),i.editableList("removeItem",n);for(var t=n.start;t<Math.min(n.start+10,n.start+n.more);t++)i.editableList("addItem",r[t]);n.more>10&&i.editableList("addItem",{start:n.start+10,more:n.more-10})})}else if(n.info){var s=n.info,d=$("<div>",{class:"palette-module-header"}).appendTo(e),l=$('<div class="palette-module-meta"><i class="fa fa-cube"></i></div>').appendTo(d);$("<span>",{class:"palette-module-name"}).html(s.name||s.id).appendTo(l),$('<a target="_blank" class="palette-module-link"><i class="fa fa-external-link"></i></a>').attr("href",s.url).appendTo(l);var p=$('<div class="palette-module-meta"></div>').appendTo(d);$("<div>",{class:"palette-module-description"}).html(s.description).appendTo(p);var u=$('<div class="palette-module-meta"></div>').appendTo(d);$('<span class="palette-module-version"><i class="fa fa-tag"></i> '+s.version+"</span>").appendTo(u),$('<span class="palette-module-updated"><i class="fa fa-calendar"></i> '+function(e){new Date,new Date(e);var t=(Date.now()-new Date(e).getTime())/1e3;if(t<60)return RED._("palette.editor.times.seconds");if((t=Math.floor(t/60))<10)return RED._("palette.editor.times.minutes");if(t<60)return RED._("palette.editor.times.minutesV",{count:t});if((t=Math.floor(t/60))<24)return RED._("palette.editor.times.hoursV",{count:t});if((t=Math.floor(t/24))<7)return RED._("palette.editor.times.daysV",{count:t});var n=Math.floor(t/7);if(n<4)return RED._("palette.editor.times.weeksV",{count:n});var o=Math.floor(n/4);if(n%=4,o<12)return RED._("palette.editor.times.monthsV",{count:o});var i=Math.floor(o/12);return 0==(o%=12)?RED._("palette.editor.times.yearsV",{count:i}):RED._("palette.editor.times.year"+(i>1?"s":"")+"MonthsV",{y:i,count:o})}(s.updated_at)+"</span>").appendTo(u);var f=$("<div>",{class:"palette-module-meta"}).appendTo(d),h=$("<div>",{class:"palette-module-button-group"}).appendTo(f),g=$('<div class="palette-module-shade hide"><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(e),v=$('<a href="#" class="editor-button editor-button-small"></a>').html(RED._("palette.editor.install")).appendTo(h);v.click(function(e){e.preventDefault(),$(this).hasClass("disabled")||($("#palette-module-install-confirm").data("module",s.id),$("#palette-module-install-confirm").data("version",s.version),$("#palette-module-install-confirm").data("url",s.url),$("#palette-module-install-confirm").data("shade",g),$("#palette-module-install-confirm-body").html(RED._("palette.editor.confirm.install.body")),$(".palette-module-install-confirm-button-install").show(),$(".palette-module-install-confirm-button-remove").hide(),$(".palette-module-install-confirm-button-update").hide(),$("#palette-module-install-confirm").dialog("option","title",RED._("palette.editor.confirm.install.title")).dialog("open"))}),c.hasOwnProperty(s.id)&&(v.addClass("disabled"),v.html(RED._("palette.editor.installed"))),n.elements={installButton:v}}else $("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(e)}}),$('<div id="palette-module-install-shade" class="palette-module-shade hide"><div class="palette-module-shade-status"></div><img src="red/images/spin.svg" class="palette-spinner"/></div>').appendTo(f),$('<div id="palette-module-install-confirm" class="hide"><form class="form-horizontal"><div id="palette-module-install-confirm-body" class="node-dialog-confirm-row"></div></form></div>').appendTo(document.body),$("#palette-module-install-confirm").dialog({title:RED._("palette.editor.confirm.title"),modal:!0,autoOpen:!1,width:550,height:"auto",buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("palette.editor.confirm.button.review"),class:"primary palette-module-install-confirm-button-install",click:function(){var e=$(this).data("url");window.open(e)}},{text:RED._("palette.editor.confirm.button.install"),class:"primary palette-module-install-confirm-button-install",click:function(){var e=$(this).data("module"),t=$(this).data("version"),n=$(this).data("shade");g(e,t,n,function(t){t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.installFailed",{module:e,message:t.responseJSON.message}))}),$(this).dialog("close")}},{text:RED._("palette.editor.confirm.button.remove"),class:"primary palette-module-install-confirm-button-remove",click:function(){var e,t,n=$(this).data("module"),o=$(this).data("shade");o.show(),e=n,t=function(e){o.hide(),e&&e.responseJSON&&RED.notify(RED._("palette.editor.errors.removeFailed",{module:n,message:e.responseJSON.message}))},$.ajax({url:"nodes/"+e,type:"DELETE"}).done(function(e,n,o){t()}).fail(function(e,n,o){t(e)}),$(this).dialog("close")}},{text:RED._("palette.editor.confirm.button.update"),class:"primary palette-module-install-confirm-button-update",click:function(){var e=$(this).data("module"),t=$(this).data("version"),n=$(this).data("shade");n.show(),g(e,t,n,function(t){t&&t.responseJSON&&RED.notify(RED._("palette.editor.errors.updateFailed",{module:e,message:t.responseJSON.message}))}),$(this).dialog("close")}}]})}(),RED.userSettings.add({id:"palette",title:RED._("palette.editor.palette"),get:O,close:function(){w.detach()},focus:function(){e.resize(),setTimeout(function(){t.focus()},200)}}),RED.actions.add("core:manage-palette",function(){RED.userSettings.show("palette")}),RED.events.on("registry:module-updated",function(e){v(e.module)}),RED.events.on("registry:node-set-enabled",function(e){v(e.module)}),RED.events.on("registry:node-set-disabled",function(e){v(e.module)}),RED.events.on("registry:node-type-added",function(e){/^subflow:/.test(e)||v(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-type-removed",function(e){/^subflow:/.test(e)||v(RED.nodes.registry.getNodeSetForType(e).module)}),RED.events.on("registry:node-set-added",function(e){v(e.module);for(var t=0;t<r.length;t++)if(r[t].info.id===e.module){var n=r[t].elements.installButton;n.addClass("disabled"),n.html(RED._("palette.editor.installed"));break}}),RED.events.on("registry:node-set-removed",function(e){if(!RED.nodes.registry.getModule(e.module)){var t=c[e.module];if(t){o.editableList("removeItem",t),delete c[e.module];for(var n=0;n<r.length;n++)if(r[n].info.id===e.module){var i=r[n].elements.installButton;i.removeClass("disabled"),i.html(RED._("palette.editor.install"));break}}}}),RED.events.on("nodes:add",function(e){/^subflow:/.test(e.type)||(l[e.type]=(l[e.type]||0)+1,1===l[e.type]&&v(RED.nodes.registry.getNodeSetForType(e.type).module))}),RED.events.on("nodes:remove",function(e){l.hasOwnProperty(e.type)&&(l[e.type]--,0===l[e.type]&&(delete l[e.type],v(RED.nodes.registry.getNodeSetForType(e.type).module)))}))}}}(),RED.editor=function(){var e=[],t={};function n(e){var t,i,a,s=e.valid,r=e.changed;if(e.valid=!0,0===e.type.indexOf("subflow:"))i=(t=RED.nodes.subflow(e.type.substring(8))).valid,a=t.changed,void 0===i&&(i=n(t),a=t.changed),e.valid=i,e.changed=e.changed||a;else if(e._def)e.valid=o(e,e._def.defaults,e),e._def._creds&&(e.valid=e.valid&&o(e,e._def.credentials,e._def._creds));else if("subflow"==e.type){for(var d=RED.nodes.filterNodes({z:e.id}),l=0;l<d.length;l++)i=d[l].valid,a=d[l].changed,void 0===i&&(i=n(d[l]),a=d[l].changed),e.valid=e.valid&&i,e.changed=e.changed||a;var c=RED.nodes.filterNodes({type:"subflow:"+e.id}),p={};for(l=0;l<c.length;l++)c[l].valid=e.valid,c[l].changed=c[l].changed||e.changed,c[l].dirty=!0,p[c[l].z]=!0;Object.keys(p).forEach(function(e){var t=RED.nodes.subflow(e);t&&n(t)})}return s===e.valid&&r===e.changed||(e.dirty=!0,(t=RED.nodes.subflow(e.z))&&n(t)),e.valid}function o(e,t,n){var o=!0;for(var a in t)t.hasOwnProperty(a)&&(i(e,t,a,n[a])||(o=!1));return o}function i(e,t,n,o){var i=!0;if(/^\$\([a-zA-Z_][a-zA-Z0-9_]*\)$/.test(o))return!0;if("required"in t[n]&&t[n].required&&(i=""!==o),i&&"validate"in t[n])try{i=t[n].validate.call(e,o)}catch(t){console.log("Validation error:",e.type,e.id,"property: "+n,"value:",o,t)}if(i&&t[n].type&&RED.nodes.getType(t[n].type)&&!("validate"in t[n]))if(o&&"_ADD_"!=o){var a=RED.nodes.node(o);i=null!==a&&(null==a.valid||a.valid)}else i=t[n].hasOwnProperty("required")&&!t[n].required;return i}function a(e,t){for(var n in e._def.defaults)e._def.defaults.hasOwnProperty(n)&&s(e,e._def.defaults,n,t);if(e._def.credentials)for(n in e._def.credentials)e._def.credentials.hasOwnProperty(n)&&s(e,e._def.credentials,n,t)}function s(e,t,n,o){var a=$("#"+o+"-"+n);if(a.length>0){var s=a.val();t[n].hasOwnProperty("format")&&""!==t[n].format&&"DIV"===a[0].nodeName&&(s=a.text()),i(e,t,n,s)?a.removeClass("input-error"):a.addClass("input-error")}}function r(e,t){e.resize=!0,e.dirty=!0;var n=[];if(e.ports)if(t&&RED.nodes.eachLink(function(o){o.source===e&&t.hasOwnProperty(o.sourcePort)&&("-1"===t[o.sourcePort]?n.push(o):o.sourcePort=t[o.sourcePort])}),e.outputs<e.ports.length){for(;e.outputs<e.ports.length;)e.ports.pop();RED.nodes.eachLink(function(t){t.source===e&&t.sourcePort>=e.outputs&&-1===n.indexOf(t)&&n.push(t)})}else if(e.outputs>e.ports.length)for(;e.outputs>e.ports.length;)e.ports.push(e.ports.length);0===e.inputs&&n.concat(RED.nodes.filterLinks({target:e}));for(var o=0;o<n.length;o++)RED.nodes.removeLink(n[o]);return n}function d(e,t,n,o){var i=$("#"+o+"-"+t);if(0!==i.length){var a,s=i.width(),r=i.attr("style");s=null!==(a=/width\s*:\s*(\d+(%|[a-z]+))/i.exec(r))?a[1]:"70%";var d=$("<div></div>").css({display:"inline-block",position:"relative"}),l=$("<div></div>").css({position:"absolute",left:0,right:"40px"}).appendTo(d),c=$('<select id="'+o+"-"+t+'"></select>').appendTo(l);d.width(s).height(i.height()),0===d.width()&&d.width("70%"),i.replaceWith(d),c.attr("style","width:100%"),D(t,n,e[t],o),$('<a id="'+o+"-lookup-"+t+'" class="editor-button"><i class="fa fa-pencil"></i></a>').css({position:"absolute",right:0,top:0}).appendTo(d),$("#"+o+"-lookup-"+t).click(function(e){y(t,n,c.find(":selected").val(),o),e.preventDefault()});var p="",u=RED.nodes.node(e[t]);RED.nodes.getType(n);u&&(p=RED.utils.getNodeLabel(u,u.id)),i.val(p)}}function l(e,t,n,o){var i=$("#"+o+"-"+t);i.val(e[t]),i.attr("type","hidden");var a=$("<a>",{id:o+"-edit-"+t,class:"editor-button"});i.after(a),e[t]?a.text(RED._("editor.configEdit")):a.text(RED._("editor.configAdd")),a.click(function(e){y(t,n,i.val()||"_ADD_",o),e.preventDefault()})}function c(e,t,n,o){var i=$("#"+n+"-"+t);if(0!==i.length)if("checkbox"===i.attr("type"))i.prop("checked",e[t]);else{var a=e[t];null==a&&(a=""),void 0!==o&&o[t].hasOwnProperty("format")&&""!==o[t].format&&"DIV"===i[0].nodeName?(i.html(RED.text.format.getHtml(a,o[t].format,{},!1,"en")),RED.text.format.attach(i[0],o[t].format,{},!1,"en")):(i.val(a),"INPUT"!==i[0].nodeName&&"TEXTAREA"!==i[0].nodeName||RED.text.bidi.prepareInput(i))}}function p(e,t,n,o){var i=$("#"+o+"-"+n);void 0!==t&&"format"in t[n]&&""!==t[n].format&&"DIV"===i[0].nodeName?$("#"+o+"-"+n).on("change keyup",function(t,n){n||a(e,o)}):$("#"+o+"-"+n).change(function(t,n){n||a(e,o)})}function u(e,t,n,o){var i;for(i in t)t.hasOwnProperty(i)&&("password"==t[i].type?n[i]?$("#"+o+"-"+i).val(n[i]):n["has_"+i]?$("#"+o+"-"+i).val("__PWRD__"):$("#"+o+"-"+i).val(""):c(n,i,o,t),p(e,t,i,o))}function f(e,t,n){var o=!1;e.credentials||(e.credentials={_:{}});for(var i in t)if(t.hasOwnProperty(i)){var a=$("#"+n+"-"+i).val();if("password"==t[i].type){if(e.credentials["has_"+i]=""!==a,"__PWRD__"==a)continue;o=!0}e.credentials[i]=a,a!=e.credentials._[i]&&(o=!0)}return o}function h(e,t,n,o){for(var i in t.defaults)if(t.defaults.hasOwnProperty(i)){if(t.defaults[i].type){var s=RED.nodes.getType(t.defaults[i].type);s?s.exclusive?l(e,i,t.defaults[i].type,n):d(e,i,t.defaults[i].type,n):(console.log("Unknown type:",t.defaults[i].type),c(e,i,n,t.defaults))}else c(e,i,n,t.defaults);p(e,t.defaults,i,n)}var r,f,h=function(){if(t.oneditprepare)try{t.oneditprepare.call(e)}catch(t){console.log("oneditprepare",e.id,e.type,t.toString())}for(var i in t.defaults)t.defaults.hasOwnProperty(i)&&$("#"+n+"-"+i).trigger("change",[!0]);if(t.credentials)for(i in t.credentials)t.credentials.hasOwnProperty(i)&&$("#"+n+"-"+i).trigger("change",[!0]);a(e,n),o&&o()};t.credentials?e.credentials?(u(e,t.credentials,e.credentials,n),h()):$.getJSON((r=e.type,f=e.id,"credentials/"+r.replace(/\s+/g,"-")+"/"+f),function(o){e.credentials=o,e.credentials._=$.extend(!0,{},o),u(e,t.credentials,e.credentials,n),h()}):h()}function g(){for(var t='<ul class="editor-tray-breadcrumbs">',n=0;n<e.length;n++){var o=e[n],i=o.type;if("_expression"===o.type)i=RED._("expressionEditor.title");else if("_json"===o.type)i=RED._("jsonEditor.title");else if("_buffer"===o.type)i=RED._("bufferEditor.title");else if("subflow"===o.type)i=RED._("subflow.editSubflow",{name:o.name});else if(0===o.type.indexOf("subflow:")){var a=RED.nodes.subflow(o.type.substring(8));i=RED._("subflow.editSubflow",{name:a.name})}else{if(void 0!==o._def.paletteLabel)try{i=("function"==typeof o._def.paletteLabel?o._def.paletteLabel.call(o._def):o._def.paletteLabel)||""}catch(e){console.log("Definition error: "+o.type+".paletteLabel",e)}n===e.length-1&&(i=RED.nodes.node(o.id)?RED._("editor.editNode",{type:i}):RED._("editor.addNewConfig",{type:i}))}t+="<li>"+i+"</li>"}return t+="</ul>"}function v(e,t,n,o){var i=$('<form id="'+t+'" class="form-horizontal" autocomplete="off"></form>').appendTo(e);return i.html($("script[data-template-name='"+n+"']").html()),o=o||"node-red",i.find("[data-i18n]").each(function(){for(var e=$(this).attr("data-i18n").split(";"),t=0;t<e.length;t++){var n=e[t];if(-1===n.indexOf(":")){var i="";if(0===n.indexOf("[")){var a=n.split("]");i=a[0]+"]",n=a[1]}e[t]=i+o+":"+n}}$(this).attr("data-i18n",e.join(";"))}),$('<input type="password" style="display: none;" />').prependTo(i),$('<input type="text" style="display: none;" />').prependTo(i),i.submit(function(e){e.preventDefault()}),i}function m(e,t,n,o){var i=$("<div>",{class:"node-label-form-row"});if(void 0===e)$("<span>").html(RED._("editor.noDefaultLabel")).appendTo(i),i.addClass("node-label-form-none");else{i.addClass("");var a="node-label-form-"+e+"-"+t;$("<label>",{for:a}).html(t+1+".").appendTo(i);var s=$("<input>",{type:"text",id:a,placeholder:o}).val(n).appendTo(i);$('<button class="editor-button editor-button-small"><i class="fa fa-times"></i></button>').appendTo(i).click(function(e){e.preventDefault(),s.val("")})}return i}function b(e,t){var n=$('<form class="dialog-form form-horizontal" autocomplete="off"></form>').appendTo(e),o=t.inputs||t._def.inputs||0,i=t.outputs||t._def.outputs||0;"subflow"===t.type&&(o=t.in.length,i=t.out.length);var a,s=t.inputLabels||[],r=t.outputLabels||[],d=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),l=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel");$('<div class="form-row"><span data-i18n="editor.labelInputs"></span><div id="node-label-form-inputs"></div></div>').appendTo(n);var c=$("#node-label-form-inputs");if(o>0)for(a=0;a<o;a++)m("input",a,s[a],d).appendTo(c);else m().appendTo(c);$('<div class="form-row"><span data-i18n="editor.labelOutputs"></span><div id="node-label-form-outputs"></div></div>').appendTo(n);var p=$("#node-label-form-outputs");if(i>0)for(a=0;a<i;a++)m("output",a,r[a],l).appendTo(p);else m().appendTo(p)}function y(t,o,i,a){var s,r="_ADD_"==i,d=RED.nodes.getType(o),l=RED.nodes.node(i);s="node-red"===d.set.module?"node-red":d.set.id;var c="",p=RED.nodes.subflow(RED.workspaces.active());if(p&&(c=p.id),null==l){l={id:RED.nodes.id(),_def:d,type:o,z:c,users:[]};for(var u in d.defaults)d.defaults[u].value&&(l[u]=JSON.parse(JSON.stringify(d.defaults[u].value)));l._=d._}e.push(l),RED.view.state(RED.state.EDITING);var m={title:g(),resize:function(){if(l&&l._def.oneditresize){var e=$("#node-config-dialog-edit-form");try{l._def.oneditresize.call(l,{width:e.width(),height:e.height()})}catch(e){console.log("oneditresize",l.id,l.type,e.toString())}}},open:function(e,t){e.find(".editor-tray-header");var n=e.find(".editor-tray-footer");!1!==d.hasUsers&&n.prepend('<div id="node-config-dialog-user-count"><i class="fa fa-info-circle"></i> <span></span></div>'),n.append('<span id="node-config-dialog-scope-container"><span id="node-config-dialog-scope-warning" data-i18n="[title]editor.errors.scopeChange"><i class="fa fa-warning"></i></span><select id="node-config-dialog-scope"></select></span>');var i=v(e.find(".editor-tray-body"),"node-config-dialog-edit-form",o,s);h(l,d,"node-config-input",function(){l._def.exclusive?$("#node-config-dialog-scope").hide():$("#node-config-dialog-scope").show(),$("#node-config-dialog-scope-warning").hide();var e={};l.users.forEach(function(t){e[t.z]=!0});var n=Object.keys(e).length,o=$("#node-config-dialog-scope").empty();o.off("change"),o.append('<option value=""'+(l.z?"":" selected")+' data-i18n="sidebar.config.global"></option>'),o.append('<option disabled data-i18n="sidebar.config.flows"></option>'),RED.nodes.eachWorkspace(function(t){var n=t.label;e[t.id]&&(n="* "+n),o.append('<option value="'+t.id+'"'+(t.id==l.z?" selected":"")+">"+n+"</option>")}),o.append('<option disabled data-i18n="sidebar.config.subflows"></option>'),RED.nodes.eachSubflow(function(t){var n=t.name;e[t.id]&&(n="* "+n),o.append('<option value="'+t.id+'"'+(t.id==l.z?" selected":"")+">"+n+"</option>")}),n>0&&o.on("change",function(){var t=$(this).val();""===t?$("#node-config-dialog-scope-warning").hide():!e[t]||n>1?$("#node-config-dialog-scope-warning").show():$("#node-config-dialog-scope-warning").hide()}),o.i18n(),i.i18n(),!1!==d.hasUsers&&$("#node-config-dialog-user-count").find("span").html(RED._("editor.nodesUse",{count:l.users.length})).parent().show(),t()})},close:function(){RED.workspaces.refresh(),e.pop()},show:function(){l&&RED.sidebar.info.refresh(l)}};m.buttons=[{id:"node-config-dialog-cancel",text:RED._("common.label.cancel"),click:function(){var e=o,t=l.id,n=RED.nodes.getType(e);if(n.oneditcancel&&n.oneditcancel){var i=RED.nodes.node(t);if(i)try{n.oneditcancel.call(i,!1)}catch(e){console.log("oneditcancel",i.id,i.type,e.toString())}else try{n.oneditcancel.call({id:t},!0)}catch(n){console.log("oneditcancel",t,e,n.toString())}}RED.tray.close()}},{id:"node-config-dialog-ok",text:r?RED._("editor.configAdd"):RED._("editor.configUpdate"),class:"primary",click:function(){var e,i,s=t,d=(l.id,o),c=r,p=RED.nodes.getType(d),u=$("#node-config-dialog-scope").val();if(p.oneditsave)try{p.oneditsave.call(l)}catch(e){console.log("oneditsave",l.id,l.type,e.toString())}for(e in p.defaults){var h;if(p.defaults.hasOwnProperty(e))if(null!=(h="checkbox"===(i=$("#node-config-input-"+e)).attr("type")?i.prop("checked"):"format"in p.defaults[e]&&""!==p.defaults[e].format&&"DIV"===i[0].nodeName?i.text():i.val())&&h!==l[e]){if(l._def.defaults[e].type){"_ADD_"==h&&(h="");var g=RED.nodes.node(l[e]);if(g){var v=g.users;v.splice(v.indexOf(l),1)}(g=RED.nodes.node(h))&&g.users.push(l)}l[e]=h}}l.label=p.label,l.z=u,u&&(l.users=l.users.filter(function(e){var t=!0;for(var o in e._def.defaults)e._def.defaults.hasOwnProperty(o)&&e._def.defaults[o].type===l.type&&e[o]===l.id&&e.z!==u&&(t=!1,e[o]=null,e.dirty=!0,e.changed=!0,n(e));return t})),c&&RED.nodes.add(l),p.credentials&&f(l,p.credentials,"node-config-input"),n(l);var m={};m[l.id]=!0;for(var b=l.users.slice();b.length>0;){var y=b.pop();m[y.id]||(m[y.id]=!0,y.users&&(b=b.concat(y.users)),n(y))}RED.nodes.dirty(!0),RED.view.redraw(!0),c||RED.events.emit("editor:save",l),RED.tray.close(function(){D(s,d,l.id,a)})}}],r||m.buttons.unshift({class:"leftButton",text:RED._("editor.configDelete"),click:function(){var e=t,i=l.id,s=o,r=RED.nodes.getType(s);try{r.ondelete&&(console.log("Deprecated API warning: config node type ",s," has an ondelete function - should be oneditdelete"),r.ondelete.call(l)),r.oneditdelete&&r.oneditdelete.call(l)}catch(e){console.log("oneditdelete",l.id,l.type,e.toString())}for(var d={t:"delete",nodes:[l],changes:{},dirty:RED.nodes.dirty()},c=0;c<l.users.length;c++){var p=l.users[c];d.changes[p.id]={changed:p.changed,valid:p.valid};for(var u in p._def.defaults)p._def.defaults.hasOwnProperty(u)&&p[u]==i&&(d.changes[p.id][u]=i,p[u]="",p.changed=!0,p.dirty=!0);n(p)}RED.nodes.remove(i),RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(d),RED.tray.close(function(){D(e,s,"",a)})}}),RED.tray.show(m)}function w(e,t){return e.__label__<t.__label__?-1:e.__label__>t.__label__?1:0}function D(e,t,n,o){if(o){var i=$("#"+o+"-edit-"+e);if(i.length)n?i.text(RED._("editor.configEdit")):i.text(RED._("editor.configAdd")),$("#"+o+"-"+e).val(n);else{var a=$("#"+o+"-"+e),s=RED.nodes.getType(t);a.children().remove();var r=RED.nodes.workspace(RED.workspaces.active());r||(r=RED.nodes.subflow(RED.workspaces.active()));var d=[];RED.nodes.eachConfig(function(e){if(e.type==t&&(!e.z||e.z===r.id)){var n=RED.utils.getNodeLabel(e,e.id);e.__label__=n,d.push(e)}});var l=w;"function"==typeof s.sort&&(l=s.sort);try{d.sort(l)}catch(e){console.log("Definition error: "+s.type+".sort",e)}d.forEach(function(e){a.append('<option value="'+e.id+'"'+(n==e.id?" selected":"")+">"+RED.text.bidi.enforceTextDirectionWithUCC(e.__label__)+"</option>"),delete e.__label__}),a.append('<option value="_ADD_"'+(""===n?" selected":"")+">"+RED._("editor.addNewType",{type:t})+"</option>"),window.setTimeout(function(){a.change()},50)}}}var E={};return{init:function(){RED.tray.init(),RED.actions.add("core:confirm-edit-tray",function(){$("#node-dialog-ok").click(),$("#node-config-dialog-ok").click()}),RED.actions.add("core:cancel-edit-tray",function(){$("#node-dialog-cancel").click(),$("#node-config-dialog-cancel").click()})},edit:function(o){var i=o;e.push(o),RED.view.state(RED.state.EDITING);var a=o.type;"subflow:"==o.type.substring(0,8)&&(a="subflow");var s={title:g(),buttons:[{id:"node-dialog-delete",class:"leftButton",text:RED._("common.label.delete"),click:function(){var e=RED.nodes.dirty(),t=[],n=[],o=RED.nodes.remove(i.id);t.push(i);var a={t:"delete",nodes:t=t.concat(o.nodes),links:n=n.concat(o.links),changes:{},dirty:e};RED.nodes.dirty(!0),RED.view.redraw(!0),RED.history.push(a),RED.tray.close()}},{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){if(i._def){if(i._def.oneditcancel)try{i._def.oneditcancel.call(i)}catch(e){console.log("oneditcancel",i.id,i.type,e.toString())}for(var e in i._def.defaults)if(i._def.defaults.hasOwnProperty(e)){var t=i._def.defaults[e];if(t.type){var n=RED.nodes.getType(t.type);if(n&&n.exclusive){var o=$("#node-input-"+e).val()||"";""===o||i[e]||RED.nodes.remove(o)}}}}RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){var e,t,o,a={},s=!1,d=RED.nodes.dirty();if(i._def.oneditsave){var l={};for(e in i._def.defaults)i._def.defaults.hasOwnProperty(e)&&("string"==typeof i[e]||"number"==typeof i[e]?l[e]=i[e]:l[e]=$.extend(!0,{},{v:i[e]}).v);try{!0===i._def.oneditsave.call(i)&&(s=!0)}catch(e){console.log("oneditsave",i.id,i.type,e.toString())}for(e in i._def.defaults)i._def.defaults.hasOwnProperty(e)&&(null===l[e]||"string"==typeof l[e]||"number"==typeof l[e]?l[e]!==i[e]&&(a[e]=l[e],s=!0):JSON.stringify(l[e])!==JSON.stringify(i[e])&&(a[e]=l[e],s=!0))}if(i._def.defaults)for(e in i._def.defaults)if(i._def.defaults.hasOwnProperty(e)){var c=$("#node-input-"+e);if(null!=(o="checkbox"===c.attr("type")?c.prop("checked"):"format"in i._def.defaults[e]&&""!==i._def.defaults[e].format&&"DIV"===c[0].nodeName?c.text():c.val())){if("outputs"===e){if(""===o.trim())continue;if(isNaN(o)){t=JSON.parse(o);var p=0,u=!1;Object.keys(t).forEach(function(e){isNaN(e)?(p++,delete t[e]):(t[e]=t[e]+"","-1"!==t[e]?(p++,t[e]!==e?u=!0:delete t[e]):u=!0)}),o=p,u&&(s=!0)}}if(i[e]!=o){if(i._def.defaults[e].type){"_ADD_"==o&&(o="");var h=RED.nodes.node(i[e]);if(h){var g=h.users;g.splice(g.indexOf(i),1)}(h=RED.nodes.node(o))&&h.users.push(i)}a[e]=i[e],i[e]=o,s=!0}}}if(i._def.credentials){var v=i._def.credentials,m=f(i,v,"node-input");s=s||m}var b=r(i,t),y=$("#node-label-form-inputs").children().find("input"),w=$("#node-label-form-outputs").children().find("input"),D=!1;if(o=y.map(function(){var e=$(this).val();return D=D||""!==e,e}).toArray().slice(0,i.inputs),(void 0===i.inputLabels&&D||void 0!==i.inputLabels&&JSON.stringify(o)!==JSON.stringify(i.inputLabels))&&(a.inputLabels=i.inputLabels,i.inputLabels=o,s=!0),D=!1,o=new Array(i.outputs),w.each(function(){var e=$(this).attr("id").substring(23);if(!t||!t.hasOwnProperty(e)||-1!==(e=parseInt(t[e]))){var n=$(this).val();D=D||""!==n,o[e]=n}}),(void 0===i.outputLabels&&D||void 0!==i.outputLabels&&JSON.stringify(o)!==JSON.stringify(i.outputLabels))&&(a.outputLabels=i.outputLabels,i.outputLabels=o,s=!0),s){var E=i.changed;i.changed=!0,RED.nodes.dirty(!0);var R=null;RED.nodes.subflow(RED.workspaces.active())&&(R=[],RED.nodes.eachNode(function(e){e.type=="subflow:"+RED.workspaces.active()&&(R.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,r(e))}));var k={t:"edit",node:i,changes:a,links:b,dirty:d,changed:E};t&&(k.outputMap=t),R&&(k.subflow={instances:R}),RED.history.push(k)}i.dirty=!0,n(i),RED.events.emit("editor:save",i),RED.tray.close()}}],resize:function(e){t[a]=e.width,$(".editor-tray-content").height(e.height-78);var n=$(".editor-tray-content form").height(e.height-78-40);if(i&&i._def.oneditresize)try{i._def.oneditresize.call(i,{width:n.width(),height:n.height()})}catch(e){console.log("oneditresize",i.id,i.type,e.toString())}},open:function(e,t){e.find(".editor-tray-footer");var n=e.find(".editor-tray-body");n.parent().css("overflow","hidden");var s=RED.stack.create({container:n,singleExpanded:!0}),r=s.add({title:RED._("editor.nodeProperties"),expanded:!0});r.content.addClass("editor-tray-content");var d,l=s.add({title:RED._("editor.portLabels"),onexpand:function(){!function(e,t){var n,o,i=t._def.inputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),a=t._def.outputLabels?RED._("editor.defaultLabel"):RED._("editor.noDefaultLabel"),s=$("#node-label-form-inputs"),r=$("#node-label-form-outputs"),d=t.inputs||t._def.inputs||0,l=s.children(),c=l.length;if(1===c&&$(l[0]).hasClass("node-label-form-none")&&c--,c<d)for(0===c&&$(l[0]).remove(),o=c;o<d;o++)m("input",o,"",i).appendTo(s);else if(c>d){for(o=d;o<c;o++)$(l[o]).remove();0===n&&m().appendTo(s)}var p=$("#node-input-outputs").val();if(void 0===p)n=t.outputs||t._def.outputs||0;else if(isNaN(p)){var u=JSON.parse(p),f=Object.keys(u);l=r.children(),1===(c=l.length)&&$(l[0]).hasClass("node-label-form-none")&&c--,n=0;var h=[];f.forEach(function(e){var t=$("#node-label-form-output-"+e).parent();0===t.length&&-1!==u[e]?(0===c&&($(l[0]).remove(),c=-1),t=m("output",e,"",a)):t.detach(),-1!==u[e]&&(n++,h.push({i:parseInt(u[e]),r:t}))}),h.sort(function(e,t){return e.i-t.i}),h.forEach(function(e,t){e.r.find("label").html(t+1+"."),e.r.appendTo(r)}),0===h.length&&m("output",o,"").appendTo(r)}else n=Math.max(0,parseInt(p));if(l=r.children(),1===(c=l.length)&&$(l[0]).hasClass("node-label-form-none")&&c--,c<n)for(0===c&&$(l[0]).remove(),o=c;o<n;o++)m("output",o,"").appendTo(r);else if(c>n){for(o=n;o<c;o++)$(l[o]).remove();0===n&&m().appendTo(r)}}(this.content,o)}});l.content.addClass("editor-tray-content"),i&&RED.sidebar.info.refresh(i),d="node-red"===o._def.set.module?"node-red":o._def.set.id,v(r.content,"dialog-form",a,d),b(l.content,o),h(o,o._def,"node-input",function(){n.i18n(),t()})},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),i&&RED.sidebar.info.refresh(i),RED.workspaces.refresh(),RED.view.redraw(!0),e.pop()},show:function(){i&&RED.sidebar.info.refresh(i)}};if(t.hasOwnProperty(a)&&(s.width=t[a]),"subflow"===a){var d=i.type.substring(8);s.buttons.unshift({class:"leftButton",text:RED._("subflow.edit"),click:function(){RED.workspaces.show(d),$("#node-dialog-ok").click()}})}RED.tray.show(s)},editConfig:y,editSubflow:function(t){var n,o=t;e.push(t),RED.view.state(RED.state.EDITING);var i={title:g(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",class:"primary",text:RED._("common.label.done"),click:function(){var e={},t=!1,i=RED.nodes.dirty(),a=$("#subflow-input-name").val();a!=o.name&&(e.name=o.name,o.name=a,t=!0);var s=n.getValue();s!=o.info&&(e.info=o.info,o.info=s,t=!0);var d=$("#node-label-form-inputs").children().find("input"),l=$("#node-label-form-outputs").children().find("input"),c=d.map(function(){return $(this).val()}).toArray().slice(0,o.inputs);if(JSON.stringify(c)!==JSON.stringify(o.inputLabels)&&(e.inputLabels=o.inputLabels,o.inputLabels=c,t=!0),c=l.map(function(){return $(this).val()}).toArray().slice(0,o.outputs),JSON.stringify(c)!==JSON.stringify(o.outputLabels)&&(e.outputLabels=o.outputLabels,o.outputLabels=c,t=!0),RED.palette.refresh(),t){var p=[];RED.nodes.eachNode(function(e){e.type=="subflow:"+o.id&&(p.push({id:e.id,changed:e.changed}),e.changed=!0,e.dirty=!0,r(e))});var u=o.changed;o.changed=!0,RED.nodes.dirty(!0);var f={t:"edit",node:o,changes:e,dirty:i,changed:u,subflow:{instances:p}};RED.history.push(f)}o.dirty=!0,RED.tray.close()}}],resize:function(e){$(".editor-tray-content").height(e.height-78),$(".editor-tray-content form").height(e.height-78-40);for(var t=$("#dialog-form>div:not(.node-text-editor-row)"),o=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),i=0;i<t.size();i++)o-=$(t[i]).outerHeight(!0);o-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",o+"px"),n.resize()},open:function(e){e.find(".editor-tray-footer");var i=e.find(".editor-tray-body");i.parent().css("overflow","hidden");var a=RED.stack.create({container:i,singleExpanded:!0}),s=a.add({title:RED._("editor.nodeProperties"),expanded:!0});s.content.addClass("editor-tray-content");var r=a.add({title:RED._("editor.portLabels")});r.content.addClass("editor-tray-content"),o&&RED.sidebar.info.refresh(o),v(s.content,"dialog-form","subflow-template"),n=RED.editor.createEditor({id:"subflow-input-info-editor",mode:"ace/mode/markdown",value:""}),$("#subflow-input-name").val(t.name),RED.text.bidi.prepareInput($("#subflow-input-name")),n.getSession().setValue(t.info||"",-1);var d=0,l="subflow:"+o.id;RED.nodes.eachNode(function(e){e.type===l&&d++}),$("#subflow-dialog-user-count").html(RED._("subflow.subflowInstances",{count:d})).show(),b(r.content,t),i.i18n()},close:function(){RED.view.state()!=RED.state.IMPORT_DRAGGING&&RED.view.state(RED.state.DEFAULT),RED.sidebar.info.refresh(o),RED.workspaces.refresh(),n.destroy(),e.pop(),o=null},show:function(){}};RED.tray.show(i)},editExpression:function(n){var o="_";e.length>0&&(o=e[e.length-1].id);var i,a,s,r,d=n.value,l=n.complete,c="_expression";e.push({type:c}),RED.view.state(RED.state.EDITING);var p={title:g(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){$("#node-input-expression-help").html(""),l(i.getValue()),RED.tray.close()}}],resize:function(e){e&&(t[c]=e.width);var n=$("#dialog-form").height();r&&r.resize(n)},open:function(e){e.find(".editor-tray-body").addClass("node-input-expression-editor");var t=v(e.find(".editor-tray-body"),"dialog-form","_expression","editor"),n=$("#node-input-expression-func");Object.keys(jsonata.functions).forEach(function(e){n.append($("<option></option>").val(e).text(e))}),n.change(function(e){var t=$(this).val(),n="<h5>"+t+"("+RED._("jsonata:"+t+".args",{defaultValue:""})+")</h5>",o=marked(RED._("jsonata:"+t+".desc",{defaultValue:""}));$("#node-input-expression-help").html(n+"<p>"+o+"</p>")});var l=null,c=-1;(i=RED.editor.createEditor({id:"node-input-expression",value:"",mode:"ace/mode/jsonata",options:{enableBasicAutocompletion:!0,enableSnippets:!0,enableLiveAutocompletion:!0}})).getSession().setValue(d||"",-1),i.on("changeSelection",function(){var e=i.getCursorPosition(),t=i.getSession().getTokenAt(e.row,e.column);if(t!==l||t&&/paren/.test(t.type)&&e.column!==c){var o,a;l=t;var s=null;if(t&&"keyword"===t.type)o=e.row,s=t;else{var r=0,d=!1;for(t?("paren.rparen"===t.type&&(c=e.column,r=e.column-(t.start+t.value.length)),o=e.row,a=t.index):(o=e.row-1,a=-1);null===s&&o>-1;){var p=i.getSession().getTokens(o);for(-1===a&&(a=p.length-1);a>-1;){var u=p[a].type;if(d){if("keyword"===u){s=p[a];break}d=!1}"paren.lparen"===u?r-=p[a].value.length:"paren.rparen"===u&&(r+=p[a].value.length),r<0&&(d=!0,r=0),a--}s||o--}}i.session.removeMarker(null),s&&n.val(s.value).change()}}),t.i18n(),$("#node-input-expression-func-insert").click(function(e){e.preventDefault(),i.getCursorPosition();var t=n.val(),o=jsonata.getFunctionSnippet(t);i.insertSnippet(o),i.focus()}),$("#node-input-expression-reformat").click(function(e){e.preventDefault();var t=i.getValue()||"";try{t=jsonata.format(t)}catch(e){}i.getSession().setValue(t||"",-1)});var u,f=RED.tabs.create({element:$("#node-input-expression-tabs"),onchange:function(e){$(".node-input-expression-tab-content").hide(),e.content.show(),p.resize()}});f.addTab({id:"expression-help",label:RED._("expressionEditor.functionReference"),content:$("#node-input-expression-tab-help")}),f.addTab({id:"expression-tests",label:RED._("expressionEditor.test"),content:$("#node-input-expression-tab-test")}),a=RED.editor.createEditor({id:"node-input-expression-test-data",value:E[o]||'{\n    "payload": "hello world"\n}',mode:"ace/mode/json",lineNumbers:!1}),$(".node-input-expression-legacy").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("expressionEditor.compatModeDesc")),RED.sidebar.info.show()});var h=function(){var e,t,n=a.getValue(),o=i.getValue(),r=!1,d=/(^|[^a-zA-Z0-9_'"])msg([^a-zA-Z0-9_'"]|$)/.test(o);$(".node-input-expression-legacy").toggle(d);try{(t=jsonata(o)).assign("flowContext",function(e){return r=!0,null}),t.assign("globalContext",function(e){return r=!0,null})}catch(e){return void s.setValue(RED._("expressionEditor.errors.invalid-expr",{message:e.message}),-1)}try{e=JSON.parse(n)}catch(e){return void s.setValue(RED._("expressionEditor.errors.invalid-msg",{message:e.toString()}))}try{var l,c=t.evaluate(d?{msg:e}:e);if(r)return void s.setValue(RED._("expressionEditor.errors.context-unsupported"),-1);l=void 0!==c?JSON.stringify(c,null,4):RED._("expressionEditor.noMatch"),s.setValue(l,-1)}catch(e){s.setValue(RED._("expressionEditor.errors.eval",{message:e.message}),-1)}};a.getSession().on("change",function(){clearTimeout(u),u=setTimeout(h,200),E[o]=a.getValue()}),i.getSession().on("change",function(){clearTimeout(u),u=setTimeout(h,200)}),s=RED.editor.createEditor({id:"node-input-expression-test-result",value:"",mode:"ace/mode/json",lineNumbers:!1,readOnly:!0}),r=RED.panels.create({id:"node-input-expression-panels",resize:function(e,t){var n=$("#node-input-expression-panel-expr");e-=$(n.children()[0]).outerHeight(!0);var o=$(n.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-expression").css("height",e-5+"px"),i.resize(),t-=$("#node-input-expression-panel-info > .form-row > div:first-child").outerHeight(!0)+20,$(".node-input-expression-tab-content").height(t),$("#node-input-expression-test-data").css("height",t-5+"px"),a.resize(),$("#node-input-expression-test-result").css("height",t-5+"px"),s.resize()}}),$("#node-input-example-reformat").click(function(e){e.preventDefault();var t=a.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}a.getSession().setValue(t||"",-1)}),h()},close:function(){e.pop(),i.destroy(),a.destroy()},show:function(){}};t.hasOwnProperty(c)&&(p.width=t[c]),RED.tray.show(p)},editJSON:function(n){var o,i=n.value,a=n.complete,s="_json";e.push({type:s}),RED.view.state(RED.state.EDITING);var r={title:g(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){a(o.getValue()),RED.tray.close()}}],resize:function(e){t[s]=e.width;for(var n=$("#dialog-form>div:not(.node-text-editor-row)"),i=($("#dialog-form>div.node-text-editor-row"),$("#dialog-form").height()),a=0;a<n.size();a++)i-=$(n[a]).outerHeight(!0);i-=parseInt($("#dialog-form").css("marginTop"))+parseInt($("#dialog-form").css("marginBottom")),$(".node-text-editor").css("height",i+"px"),o.resize()},open:function(e){e.find(".editor-tray-body");var t=v(e.find(".editor-tray-body"),"dialog-form",s,"editor");(o=RED.editor.createEditor({id:"node-input-json",value:"",mode:"ace/mode/json"})).getSession().setValue(i||"",-1),$("#node-input-json-reformat").click(function(e){e.preventDefault();var t=o.getValue()||"";try{t=JSON.stringify(JSON.parse(t),null,4)}catch(e){}o.getSession().setValue(t||"",-1)}),t.i18n()},close:function(){e.pop(),o.destroy()},show:function(){}};t.hasOwnProperty(s)&&(r.width=t[s]),RED.tray.show(r)},editBuffer:function(n){var o=n.value,i=n.complete,a="_buffer";e.push({type:a}),RED.view.state(RED.state.EDITING);var s,r,d=[],l={title:g(),buttons:[{id:"node-dialog-cancel",text:RED._("common.label.cancel"),click:function(){RED.tray.close()}},{id:"node-dialog-ok",text:RED._("common.label.done"),class:"primary",click:function(){i(JSON.stringify(s)),RED.tray.close()}}],resize:function(e){e&&(t[a]=e.width);var n=$("#dialog-form").height();r&&r.resize(n)},open:function(e){e.find(".editor-tray-body");var t,n=v(e.find(".editor-tray-body"),"dialog-form",a,"editor");(d=RED.editor.createEditor({id:"node-input-buffer-str",value:"",mode:"ace/mode/text"})).getSession().setValue(o||"",-1),bufferBinEditor=RED.editor.createEditor({id:"node-input-buffer-bin",value:"",mode:"ace/mode/text",readOnly:!0});var i=function(e){var t=!0,n="string"==typeof e,o=[],i=0,a=(s=n?function(e){var t=[],n=0,o=e.length;for(n=0;n<o;n++){var i=e.charCodeAt(n);i<128?t.push(i):i<2048?(t.push(192|i>>6),t.push(128|63&i)):i<55296||i>=57344?(t.push(224|i>>12),t.push(128|i>>6&63),t.push(128|63&i)):(n++,i=65536+((1023&i)<<10|1023&e.charAt(n)),t.push(240|i>>18),t.push(128|i>>12&63),t.push(128|i>>6&63),t.push(128|63&i))}return t}(e):e).length;for(i=0;i<a;i++){var r=parseInt(s[i]);if(!n&&(isNaN(r)||r<0||r>255)){t=!1;break}i>0&&(i%8==0?i%16==0?o.push("\n"):o.push("  "):o.push(" ")),o.push((r<16?"0":"")+r.toString(16).toUpperCase())}return t&&($("#node-input-buffer-type-string").toggle(n),$("#node-input-buffer-type-array").toggle(!n),bufferBinEditor.setValue(o.join(""),1)),t},l=function(){var e=d.getValue(),t=!1;if(/^[\s]*\[[\s\S]*\][\s]*$/.test(e)){t=!0;try{var n=JSON.parse(e);t=i(n)}catch(e){t=!1}}t||i(e)};d.getSession().on("change",function(){clearTimeout(t),t=setTimeout(l,200)}),l(),n.i18n(),r=RED.panels.create({id:"node-input-buffer-panels",resize:function(e,t){var n=$("#node-input-buffer-panel-str");e-=$(n.children()[0]).outerHeight(!0);var o=$(n.children()[1]);e-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-str").css("height",e-5+"px"),d.resize();var i=$("#node-input-buffer-panel-bin");o=$(i.children()[0]),t-=parseInt(o.css("marginTop"))+parseInt(o.css("marginBottom")),$("#node-input-buffer-bin").css("height",t-5+"px"),bufferBinEditor.resize()}}),$(".node-input-buffer-type").click(function(e){e.preventDefault(),RED.sidebar.info.set(RED._("bufferEditor.modeDesc")),RED.sidebar.info.show()})},close:function(){e.pop(),d.destroy(),bufferBinEditor.destroy()},show:function(){}};t.hasOwnProperty(a)&&(l.width=t[a]),RED.tray.show(l)},validateNode:n,updateNodeProperties:r,createEditor:function(e){var t=ace.edit(e.id);t.setTheme("ace/theme/tomorrow");var n=t.getSession();return e.mode&&n.setMode(e.mode),e.foldStyle?n.setFoldStyle(e.foldStyle):n.setFoldStyle("markbeginend"),e.options?t.setOptions(e.options):t.setOptions({enableBasicAutocompletion:!0,enableSnippets:!0}),e.readOnly&&(t.setOption("readOnly",e.readOnly),t.container.classList.add("ace_read-only")),e.hasOwnProperty("lineNumbers")&&t.renderer.setOption("showGutter",e.lineNumbers),t.$blockScrolling=1/0,e.value&&n.setValue(e.value,-1),e.globals&&setTimeout(function(){n.$worker&&n.$worker.send("setOptions",[{globals:e.globals,esversion:6}])},100),t}}}(),RED.tray=function(){var e=[],t=$("#editor-stack"),n=!1;function o(o){var a=$('<div class="editor-tray"></div>'),s=$('<div class="editor-tray-header"></div>').appendTo(a),r=$('<div class="editor-tray-body-wrapper"></div>').appendTo(a),d=$('<div class="editor-tray-body"></div>').appendTo(r),l=$('<div class="editor-tray-footer"></div>').appendTo(a),c=$('<div class="editor-tray-resize-handle"></div>').appendTo(a);o.title&&$('<div class="editor-tray-titlebar">'+o.title+"</div>").appendTo(s),o.width===1/0&&(o.maximized=!0,c.addClass("editor-tray-resize-maximised"));var p,u=$('<div class="editor-tray-toolbar"></div>').appendTo(s);if(o.buttons)for(var f=0;f<o.buttons.length;f++){var h=o.buttons[f],g=$("<button>").button().appendTo(u);h.id&&g.attr("id",h.id),h.text&&g.html(h.text),h.click&&g.click(function(e){return function(t){$(this).hasClass("disabled")||e(t)}}(h.click)),h.class&&(g.addClass(h.class),"primary"===h.class&&(p=h))}a.appendTo(t);var v={tray:a,header:s,body:d,footer:l,options:o,primaryButton:p};function m(){$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$(".sidebar-shade").show(),v.preferredWidth=Math.max(a.width(),500),d.css({minWidth:v.preferredWidth-40}),o.width?(o.width>$("#editor-stack").position().left-8&&(o.width=$("#editor-stack").position().left-8),a.width(o.width)):a.width(v.preferredWidth),v.width=a.width(),v.width>$("#editor-stack").position().left-8&&(v.width=Math.max(0,$("#editor-stack").position().left-8),a.width(v.width)),a.css({right:-(a.width()+10)+"px",transition:"right 0.25s ease"}),$("#workspace").scrollLeft(0),i(),n=!0,setTimeout(function(){setTimeout(function(){o.width||a.width(Math.min(v.preferredWidth,$("#editor-stack").position().left-8)),o.resize&&o.resize({width:a.width()}),o.show&&o.show(),setTimeout(function(){n=!1},200),d.find(":focusable:first").focus()},150),a.css({right:0})},0)}e.push(v),o.maximized||a.draggable({handle:c,axis:"x",start:function(e,t){a.width("auto")},drag:function(e,n){var o=t.position().left+n.position.left;o<7?n.position.left+=7-o:n.position.left>-v.preferredWidth-1&&(n.position.left=-Math.min(t.position().left-7,v.preferredWidth-1)),v.options.resize&&setTimeout(function(){v.options.resize({width:-n.position.left})},0),v.width=-n.position.left},stop:function(e,t){a.width(-t.position.left),a.css({left:""}),v.options.resize&&v.options.resize({width:-t.position.left}),v.width=-t.position.left}}),o.open?1===o.open.length?(o.open(a),m()):o.open(a,m):m()}function i(){if(e.length>0){var t=e[e.length-1],n=t.tray.height()-t.header.outerHeight()-t.footer.outerHeight();t.body.height(n),t.options.maximized||t.width>$("#editor-stack").position().left-8?(t.width=$("#editor-stack").position().left-8,t.tray.width(t.width)):t.width<t.preferredWidth&&(t.width=Math.min($("#editor-stack").position().left-8,t.preferredWidth),t.tray.width(t.width)),t.options.resize&&t.options.resize({width:t.width,height:n})}}return{init:function(){$(window).resize(i),RED.events.on("sidebar:resize",i),$("#editor-shade").click(function(){if(!n){var t=e[e.length-1];t&&t.primaryButton&&t.primaryButton.click()}})},show:function(t){if(e.length>0){var n=e[e.length-1];n.tray.css({right:-(n.tray.width()+10)+"px"}),setTimeout(function(){n.tray.detach(),o(t)},250)}else RED.events.emit("editor:open"),o(t)},close:function(t){if(e.length>0){var n=e.pop();n.tray.css({right:-(n.tray.width()+10)+"px"}),setTimeout(function(){if(n.options.close&&n.options.close(),n.tray.remove(),e.length>0){var o=e[e.length-1];o.tray.appendTo("#editor-stack"),setTimeout(function(){i(),o.tray.css({right:0}),o.options.show&&o.options.show()},0)}t&&t(),0===e.length&&($("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$(".sidebar-shade").hide(),RED.events.emit("editor:close"),RED.view.focus())},250)}}}}(),RED.clipboard=function(){var e,t,n,o,i=!1;function a(){var e=$("#clipboard-import"),t=e.val();t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1);try{JSON.parse(t),e.removeClass("input-error"),e.val(t),$("#clipboard-dialog-ok").button("enable")}catch(n){""!==t&&e.addClass("input-error"),$("#clipboard-dialog-ok").button("disable")}}function s(){i||(t.empty(),t.append($(o)),t.i18n(),$("#clipboard-dialog-ok").show(),$("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-close").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-ok").button("disable"),$("#clipboard-import").keyup(a),$("#clipboard-import").on("paste",function(){setTimeout(a,10)}),$("#import-tab > a").click(function(e){e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected")||($(this).parent().children().removeClass("selected"),$(this).addClass("selected"))}),e.dialog("option","title",RED._("clipboard.importNodes")).dialog("open"))}function r(){if(!i){t.empty(),t.append($(n)),t.i18n();var o=RED.settings.flowFilePretty?"export-format-full":"export-format-mini";$("#export-format-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$("#clipboard-export").val();if(t.length>0){var n=JSON.parse(t);t="export-format-full"===(o=$(this).attr("id"))?JSON.stringify(n,null,4):JSON.stringify(n),$("#clipboard-export").val(t),$("#clipboard-export").focus()}}}),$("#export-range-group > a").click(function(e){if(e.preventDefault(),$(this).hasClass("disabled")||$(this).hasClass("selected"))$("#clipboard-export").focus();else{$(this).parent().children().removeClass("selected"),$(this).addClass("selected");var t=$(this).attr("id"),n="",i=null;if("export-range-selected"===t){var a=RED.view.selection();i=RED.nodes.createExportableNodeSet(a.nodes.filter(function(e){return"subflow"!==e.type}))}else if("export-range-flow"===t){var s=RED.workspaces.active();i=RED.nodes.filterNodes({z:s});var r=RED.nodes.workspace(s)||RED.nodes.subflow(s);i.unshift(r),i=RED.nodes.createExportableNodeSet(i)}else"export-range-full"===t&&(i=RED.nodes.createCompleteNodeSet(!1));null!==i&&(n="export-format-full"===o?JSON.stringify(i,null,4):JSON.stringify(i)),n.length>0?$("#export-copy").removeClass("disabled"):$("#export-copy").addClass("disabled"),$("#clipboard-export").val(n),$("#clipboard-export").focus()}}),$("#clipboard-dialog-ok").hide(),$("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-copy").hide(),$("#clipboard-dialog-close").hide(),RED.view.selection().nodes?$("#export-range-selected").click():($("#export-range-selected").addClass("disabled").removeClass("selected"),$("#export-range-flow").click()),"export-format-full"===o?$("#export-format-full").click():$("#export-format-mini").click(),$("#clipboard-export").focus(function(){var e=$(this);e.select(),e.mouseup(function(){return e.unbind("mouseup"),!1})}),e.dialog("option","title",RED._("clipboard.exportNodes")).dialog("open"),$("#clipboard-export").focus(),document.queryCommandSupported("copy")?($("#clipboard-dialog-cancel").show(),$("#clipboard-dialog-copy").show()):($("#clipboard-dialog-cancel").hide(),$("#clipboard-dialog-close").show())}}function d(){$("#dropTarget").hide(),RED.keyboard.remove("escape")}return{init:function(){e=$('<div id="clipboard-dialog" class="hide node-red-dialog"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,buttons:[{id:"clipboard-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-close",class:"primary",text:RED._("common.label.close"),click:function(){$(this).dialog("close")}},{id:"clipboard-dialog-copy",class:"primary",text:RED._("clipboard.export.copy"),click:function(){$("#clipboard-export").select(),document.execCommand("copy"),document.getSelection().removeAllRanges(),RED.notify(RED._("clipboard.nodesExported")),$(this).dialog("close")}},{id:"clipboard-dialog-ok",class:"primary",text:RED._("common.label.import"),click:function(){RED.view.importNodes($("#clipboard-import").val(),"import-tab-new"===$("#import-tab > a.selected").attr("id")),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}}),t=e.children(".dialog-form"),n='<div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.export.copy"></label><span id="export-range-group" class="button-group"><a id="export-range-selected" class="editor-button toggle" href="#" data-i18n="clipboard.export.selected"></a><a id="export-range-flow" class="editor-button toggle" href="#" data-i18n="clipboard.export.current"></a><a id="export-range-full" class="editor-button toggle" href="#" data-i18n="clipboard.export.all"></a></span></div><div class="form-row"><textarea readonly style="resize: none; width: 100%; border-radius: 4px;font-family: monospace; font-size: 12px; background:#f3f3f3; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-export" rows="5"></textarea></div><div class="form-row" style="text-align: right;"><span id="export-format-group" class="button-group"><a id="export-format-mini" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.compact"></a><a id="export-format-full" class="editor-button editor-button-small toggle" href="#" data-i18n="clipboard.export.formatted"></a></span></div>',o='<div class="form-row"><textarea style="resize: none; width: 100%; border-radius: 0px;font-family: monospace; font-size: 12px; background:#eee; padding-left: 0.5em; box-sizing:border-box;" id="clipboard-import" rows="5" placeholder="'+RED._("clipboard.pasteNodes")+'"></textarea></div><div class="form-row"><label style="width:auto;margin-right: 10px;" data-i18n="clipboard.import.import"></label><span id="import-tab" class="button-group"><a id="import-tab-current" class="editor-button toggle selected" href="#" data-i18n="clipboard.export.current"></a><a id="import-tab-new" class="editor-button toggle" href="#" data-i18n="clipboard.import.newFlow"></a></span></div>',$('<input type="text" id="clipboard-hidden">').appendTo("body"),RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),RED.actions.add("core:show-export-dialog",r),RED.actions.add("core:show-import-dialog",s),RED.events.on("editor:open",function(){i=!0}),RED.events.on("editor:close",function(){i=!1}),RED.events.on("search:open",function(){i=!0}),RED.events.on("search:close",function(){i=!1}),RED.events.on("type-search:open",function(){i=!0}),RED.events.on("type-search:close",function(){i=!1}),$("#chart").on("dragenter",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||($("#dropTarget").css({display:"table"}),RED.keyboard.add("*","escape",d))}),$("#dropTarget").on("dragover",function(e){-1==$.inArray("text/plain",e.originalEvent.dataTransfer.types)&&-1==$.inArray("Files",e.originalEvent.dataTransfer.types)||e.preventDefault()}).on("dragleave",function(e){d()}).on("drop",function(e){if(-1!=$.inArray("text/plain",e.originalEvent.dataTransfer.types)){var t=e.originalEvent.dataTransfer.getData("text/plain");t=t.substring(t.indexOf("["),t.lastIndexOf("]")+1),RED.view.importNodes(t)}else if(-1!=$.inArray("Files",e.originalEvent.dataTransfer.types)){var n=e.originalEvent.dataTransfer.files;if(1===n.length){var o=n[0],i=new FileReader;i.onload=function(e){RED.view.importNodes(e.target.result)},i.readAsText(o)}}d(),e.preventDefault()})},import:s,export:r,copyText:function(e,t,n){var o=!1;"string"!=typeof e&&(e=JSON.stringify(e,function(e,t){return null!==t&&"object"==typeof t&&t.__encoded__&&t.hasOwnProperty("data")&&t.hasOwnProperty("length")?(o=t.data.length!==t.length,t.data):t})),o&&(n+="_truncated"),$("#clipboard-hidden").val(e).select();var i=document.execCommand("copy");if(i&&t){var a=RED.popover.create({target:t,direction:"left",size:"small",content:RED._(n)});setTimeout(function(){a.close()},1e3),a.open()}return i}}}(),RED.library=function(){var e;function t(){$.getJSON("library/flows",function(e){var t,n=function(e,t){var o,i,a,s=document.createElement("ul");if(""===t&&(s.id="menu-item-import-library-submenu"),s.className="dropdown-menu",e.d)for(o in e.d)if(e.d.hasOwnProperty(o)){(i=document.createElement("li")).className="dropdown-submenu pull-left",(a=document.createElement("a")).href="#";var r=o.replace(/^node-red-contrib-/,"").replace(/^node-red-node-/,"").replace(/-/," ").replace(/_/," ");a.innerHTML=r,i.appendChild(a),i.appendChild(n(e.d[o],t+(""!==t?"/":"")+o)),s.appendChild(i)}if(e.f)for(o in e.f)e.f.hasOwnProperty(o)&&(i=document.createElement("li"),(a=document.createElement("a")).href="#",a.innerHTML=e.f[o],a.flowName=t+(""!==t?"/":"")+e.f[o],a.onclick=function(){$.get("library/flows/"+this.flowName,function(e){RED.view.importNodes(e)})},i.appendChild(a),s.appendChild(i));return s};e.d&&e.d._examples_&&(t=e.d._examples_,delete e.d._examples_);var o=n(e,"");$("#menu-item-import-examples").remove(),t&&(RED.menu.addItem("menu-item-import",{id:"menu-item-import-examples",label:RED._("menu.label.examples"),options:[]}),$("#menu-item-import-examples-submenu").replaceWith(n(t,"_examples_"))),$("#menu-item-import-library-submenu").replaceWith(o)})}function n(){var t=RED.nodes.createExportableNodeSet(RED.view.selection().nodes);$("#node-input-library-filename").attr("nodes",JSON.stringify(t)),e.dialog("open")}return{init:function(){RED.actions.add("core:library-export",n),RED.events.on("view:selection-changed",function(e){e.nodes?(RED.menu.setDisabled("menu-item-export",!1),RED.menu.setDisabled("menu-item-export-clipboard",!1),RED.menu.setDisabled("menu-item-export-library",!1)):(RED.menu.setDisabled("menu-item-export",!0),RED.menu.setDisabled("menu-item-export-clipboard",!0),RED.menu.setDisabled("menu-item-export-library",!0))}),!1!==RED.settings.theme("menu.menu-item-import-library")&&t(),(e=$('<div id="library-dialog" class="hide"><form class="dialog-form form-horizontal"></form></div>').appendTo("body").dialog({modal:!0,autoOpen:!1,width:500,resizable:!1,title:RED._("library.exportToLibrary"),buttons:[{id:"library-dialog-cancel",text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{id:"library-dialog-ok",class:"primary",text:RED._("common.label.export"),click:function(){var e=$("#node-input-library-filename").val();/^\s*$/.test(e)||$.ajax({url:"library/flows/"+e,type:"POST",data:$("#node-input-library-filename").attr("nodes"),contentType:"application/json; charset=utf-8"}).done(function(){RED.library.loadFlowLibrary(),RED.notify(RED._("library.savedNodes"),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")}),$(this).dialog("close")}}],open:function(e){$(this).parent().find(".ui-dialog-titlebar-close").hide()},close:function(e){}})).children(".dialog-form").append($('<div class="form-row"><label for="node-input-library-filename" data-i18n="[append]editor:library.filename"><i class="fa fa-file"></i> </label><input type="text" id="node-input-library-filename" data-i18n="[placeholder]editor:library.fullFilenamePlaceholder"><input type="text" style="display: none;" /></div>'))},create:function(e){var t=null,n=null;function o(e){var t=document.createElement("li");return t.onmouseover=function(e){$(this).addClass("list-hover")},t.onmouseout=function(e){$(this).removeClass("list-hover")},t}function i(a,s){for(var r,d=document.createElement("ul"),l=0;l<s.length;l++){var c=s[l];"string"==typeof c?((r=o()).onclick=function(){var t=c;return function(n){var o=$('<li class="active"><span class="divider">/</span> <a href="#">'+t+"</a></li>");$("a",o).click(function(n){$(this).parent().nextAll().remove(),$.getJSON("library/"+e.url+a+t,function(e){$("#node-select-library").children().first().replaceWith(i(a+t+"/",e))}),n.stopPropagation()});var s=$("#node-dialog-library-breadcrumbs");$(".active",s).removeClass("active"),s.append(o),$.getJSON("library/"+e.url+a+t,function(e){$("#node-select-library").children().first().replaceWith(i(a+t+"/",e))})}}(),r.innerHTML='<i class="fa fa-folder"></i> '+c+"</i>",d.appendChild(r)):((r=o()).innerHTML=c.name,r.onclick=function(){var o=c;return function(i){$(".list-selected",d).removeClass("list-selected"),$(this).addClass("list-selected"),$.get("library/"+e.url+a+o.fn,function(e){t=o,n.setValue(e,-1)})}}(),d.appendChild(r))}return d}function a(t){var n=$("#node-input-name").val().replace(/(^\s*)|(\s*$)/g,"");""===n&&(n=RED._("library.unnamedType",{type:e.type}));var o=$("#node-dialog-library-save-filename").val().replace(/(^\s*)|(\s*$)/g,""),i=$("#node-dialog-library-save-folder").val().replace(/(^\s*)|(\s*$)/g,"");if(""!==o&&/.+\.js$/.test(o)){for(var a=i+(""===i?"":"/")+o,s={},r=0;r<e.fields.length;r++){var d=e.fields[r];"name"==d?s.name=n:s[d]=$("#node-input-"+d).val()}s.text=e.editor.getValue(),$.ajax({url:"library/"+e.url+"/"+a,type:"POST",data:JSON.stringify(s),contentType:"application/json; charset=utf-8"}).done(function(t,n,o){RED.notify(RED._("library.savedType",{type:e.type}),"success")}).fail(function(e,t,n){401===e.status?RED.notify(RED._("library.saveFailed",{message:RED._("user.notAuthorized")}),"error"):RED.notify(RED._("library.saveFailed",{message:e.responseText}),"error")})}else RED.notify(RED._("library.invalidFilename"),"warning")}e.editor.setText&&(e.editor.setValue=function(t,n){e.editor.setText.call(e.editor,t)}),e.editor.getText&&(e.editor.getValue=e.editor.getText),$("#node-input-name").css("width","66%").after('<div class="btn-group" style="margin-left: 5px;"><a id="node-input-'+e.type+'-lookup" class="editor-button" data-toggle="dropdown"><i class="fa fa-book"></i> <i class="fa fa-caret-down"></i></a><ul class="dropdown-menu pull-right" role="menu"><li><a id="node-input-'+e.type+'-menu-open-library" tabindex="-1" href="#">'+RED._("library.openLibrary")+'</a></li><li><a id="node-input-'+e.type+'-menu-save-library" tabindex="-1" href="#">'+RED._("library.saveToLibrary")+"</a></li></ul></div>"),$("#node-input-"+e.type+"-menu-open-library").click(function(t){$("#node-select-library").children().remove(),$("#node-dialog-library-breadcrumbs").children().first().nextAll().remove(),n.setValue("",-1),$.getJSON("library/"+e.url,function(e){$("#node-select-library").append(i("/",e)),$("#node-dialog-library-breadcrumbs a").click(function(t){$(this).parent().nextAll().remove(),$("#node-select-library").children().first().replaceWith(i("/",e)),t.stopPropagation()}),$("#node-dialog-library-lookup").dialog("open")}),t.preventDefault()}),$("#node-input-"+e.type+"-menu-save-library").click(function(t){var n=$("#node-input-name").val().replace(/(^\s*)|(\s*$)/g,"");$("#node-dialog-library-save-folder").attr("value","");var o=n.replace(/[^\w-]/g,"-");""===o&&(o="unnamed-"+e.type),$("#node-dialog-library-save-filename").attr("value",o+".js"),$("#node-dialog-library-save").dialog("open"),t.preventDefault()}),(n=ace.edit("node-select-library-text")).setTheme("ace/theme/tomorrow"),e.mode&&n.getSession().setMode(e.mode),n.setOptions({readOnly:!0,highlightActiveLine:!1,highlightGutterLine:!1}),n.renderer.$cursorLayer.element.style.opacity=0,n.$blockScrolling=1/0,$("#node-dialog-library-lookup").dialog({title:RED._("library.typeLibrary",{type:e.type}),modal:!0,autoOpen:!1,width:800,height:450,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.load"),class:"primary",click:function(){if(t){for(var o=0;o<e.fields.length;o++){var i=e.fields[o];$("#node-input-"+i).val(t[i])}e.editor.setValue(n.getValue(),-1)}$(this).dialog("close")}}],open:function(e){var t=$("form",this);t.height(t.parent().height()-30),$("#node-select-library-text").height("100%"),$(".form-row:last-child",t).children().height(t.height()-60)},resize:function(e){var t=$("form",this);t.height(t.parent().height()-30),$(".form-row:last-child",t).children().height(t.height()-60)}}),$("#node-dialog-library-save-confirm").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){a(),$(this).dialog("close")}}]}),$("#node-dialog-library-save").dialog({title:RED._("library.saveToLibrary"),modal:!0,autoOpen:!1,width:530,height:230,buttons:[{text:RED._("common.label.cancel"),click:function(){$(this).dialog("close")}},{text:RED._("common.label.save"),class:"primary",click:function(){a(),$(this).dialog("close")}}]})},loadFlowLibrary:t,export:n}}(),RED.notify=function(){var e=[],t=0;return function(n,o,i,a){if(e.length>4)for(var s=e.length,r=0;s>4&&r<e.length;r+=1){var d=e[r];d.fixed||(window.clearTimeout(d.timeoutid),d.close(),s-=1)}var l,c,p,u=document.createElement("div");return u.id="red-notification-"+t,u.className="notification",u.fixed=i,o&&(u.className="notification notification-"+o),u.style.display="none","string"==typeof n?u.innerHTML=n:$(u).append(n),$("#notifications").append(u),$(u).slideDown(300),u.close=(l=u,function(){e.splice(e.indexOf(l),1),$(l).slideUp(300,function(){l.parentNode.removeChild(l)})}),u.update=(c=u,function(e,t){"string"==typeof e?c.innerHTML=e:$(c).empty().append(e),void 0!==t&&t>0?(window.clearTimeout(c.timeoutid),c.timeoutid=window.setTimeout(c.close,t)):window.clearTimeout(c.timeoutid)}),i||($(u).click((p=u,function(){p.close(),window.clearTimeout(p.timeoutid)})),u.timeoutid=window.setTimeout(u.close,a||3e3)),e.push(u),t+=1,u}}(),RED.search=function(){var e,t,n=!1,o=null,i=-1,a=!1,s={},r=[],d=[];function l(e){var t=RED.utils.getNodeLabel(e);t&&(t=(""+t).toLowerCase(),s[t]=s[t]||{},s[t][e.id]={node:e,label:t}),t=t||e.label||e.name||e.id||"";var n=["id","type","name","label","info"];e._def&&e._def.defaults&&(n=n.concat(Object.keys(e._def.defaults)));for(var o=0;o<n.length;o++)if(e.hasOwnProperty(n[o])){var i=e[n[o]];"string"!=typeof i&&"number"!=typeof i||(i=(""+i).toLowerCase(),s[i]=s[i]||{},s[i][e.id]={node:e,label:t})}}function c(){var e=t.find("li.selected");if(1===e.length){var n=t.parent(),o=n.height(),i=(n.scrollTop(),e.position().top),a=e.height();i+a>o?n.animate({scrollTop:"-="+(o-(i+a)-10)},50):i<0&&n.animate({scrollTop:"+="+(i-10)},50)}}function p(){o=$("<div>",{id:"red-ui-search",class:"red-ui-search"}).appendTo("#main-container");var n=$("<div>",{class:"red-ui-search-container"}).appendTo(o);(e=$('<input type="text" data-i18n="[placeholder]menu.label.searchInput">').appendTo(n).searchBox({delay:200,change:function(){!function(e){if(t.editableList("empty"),i=-1,d=[],e.length>0){var n,o;e=e.toLowerCase();var a=[],l={};for(n=0;n<r.length;n++){var c=r[n],p=r[n].indexOf(e);if(p>-1)for(o=0;o<s[c].length;o++){var u=s[c][o];l[u.node.id]=l[u.node.id]=u,l[u.node.id].index=Math.min(l[u.node.id].index||1/0,p)}}for((a=Object.keys(l)).sort(function(e,t){return l[e].index-l[t].index}),n=0;n<a.length;n++)d.push(l[a[n]]);if(d.length>0)for(n=0;n<Math.min(d.length,25);n++)t.editableList("addItem",d[n]);else t.editableList("addItem",{})}}($(this).val())}})).on("keydown",function(e){var n;d.length>0&&(40===e.keyCode?(n=t.children(),i<n.length-1&&(i>-1&&$(n[i]).removeClass("selected"),i++),$(n[i]).addClass("selected"),c(),e.preventDefault()):38===e.keyCode?(n=t.children(),i>0&&(i<n.length&&$(n[i]).removeClass("selected"),i--),$(n[i]).addClass("selected"),c(),e.preventDefault()):13===e.keyCode&&d.length>0&&u(d[Math.max(0,i)].node))}),e.i18n();var a=$("<div>",{class:"red-ui-search-results-container"}).appendTo(o);t=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 5px;bottom: 5px;left: 5px;right: 5px;"}).appendTo(a).editableList({addButton:!1,addItem:function(e,t,n){var o=n.node;if(void 0===o)$("<div>",{class:"red-ui-search-empty"}).html(RED._("search.empty")).appendTo(e);else{var i=o._def,a=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),s=$("<div>",{class:"red-ui-search-result-node"}).appendTo(a),r=i.color,d=RED.utils.getNodeIcon(i,o);"tab"===o.type&&(r="#C0DEED"),s.css("backgroundColor",r);var l=$("<div/>",{class:"palette_icon_container"}).appendTo(s);$("<div/>",{class:"palette_icon",style:"background-image: url("+d+")"}).appendTo(l);var c=$("<div>",{class:"red-ui-search-result-description"}).appendTo(a);if(o.z){var p=RED.nodes.workspace(o.z);p=p?"flow:"+p.label:"subflow:"+(p=RED.nodes.subflow(o.z)).name,$("<div>",{class:"red-ui-search-result-node-flow"}).html(p).appendTo(c)}$("<div>",{class:"red-ui-search-result-node-label"}).html(n.label||o.id).appendTo(c),$("<div>",{class:"red-ui-search-result-node-type"}).html(o.type).appendTo(c),$("<div>",{class:"red-ui-search-result-node-id"}).html(o.id).appendTo(c),a.click(function(e){e.preventDefault(),u(o)})}},scrollOnAdd:!1})}function u(e){h(),RED.view.reveal(e.id)}function f(){n||(a||(RED.keyboard.add("*","escape",function(){h()}),$("#header-shade").show(),$("#editor-shade").show(),$("#palette-shade").show(),$("#sidebar-shade").show(),$("#sidebar-separator").hide(),s={},RED.nodes.eachWorkspace(l),RED.nodes.eachSubflow(l),RED.nodes.eachConfig(l),RED.nodes.eachNode(l),(r=Object.keys(s)).sort(),r.forEach(function(e){s[e]=Object.keys(s[e]).map(function(t){return s[e][t]})}),null===o&&p(),o.slideDown(300),RED.events.emit("search:open"),a=!0),e.focus())}function h(){a&&(RED.keyboard.remove("escape"),a=!1,$("#header-shade").hide(),$("#editor-shade").hide(),$("#palette-shade").hide(),$("#sidebar-shade").hide(),$("#sidebar-separator").show(),null!==o&&o.slideUp(200,function(){e.searchBox("value","")}),RED.events.emit("search:close"))}return{init:function(){RED.actions.add("core:search",f),RED.events.on("editor:open",function(){n=!0}),RED.events.on("editor:close",function(){n=!1}),RED.events.on("type-search:open",function(){n=!0}),RED.events.on("type-search:close",function(){n=!1}),$("#header-shade").on("mousedown",h),$("#editor-shade").on("mousedown",h),$("#palette-shade").on("mousedown",h),$("#sidebar-shade").on("mousedown",h)},show:f,hide:h}}(),RED.typeSearch=function(){var e,t,n,o,i=null,a=-1,s=!1,r="",d={};function l(){var e=t.find("li.selected");if(1===e.length){var n=t.parent(),o=n.height(),i=(n.scrollTop(),e.position().top),a=e.height();i+a>o?n.animate({scrollTop:"-="+(o-(i+a)-10)},50):i<0&&n.animate({scrollTop:"+="+(i-10)},50)}}function c(){i=$("<div>",{id:"red-ui-type-search",class:"red-ui-search red-ui-type-search"}).appendTo("#main-container");var o=$("<div>",{class:"red-ui-search-container"}).appendTo(i);(e=$('<input type="text">').attr("placeholder",RED._("search.addNode")).appendTo(o).searchBox({delay:50,change:function(){var e;e=$(this).val(),r=e.toLowerCase(),t.editableList("filter"),setTimeout(function(){a=0,t.children().removeClass("selected"),t.children(":visible:first").addClass("selected")},100)}})).on("keydown",function(e){var n=t.children(":visible");if(n.length>0)if(40===e.keyCode)a<n.length-1&&(a>-1&&$(n[a]).removeClass("selected"),a++),$(n[a]).addClass("selected"),l(),e.preventDefault();else if(38===e.keyCode)a>0&&(a<n.length&&$(n[a]).removeClass("selected"),a--),$(n[a]).addClass("selected"),l(),e.preventDefault();else if(13===e.keyCode){var o=Math.max(0,a);o<n.length&&p($(n[o]).find(".red-ui-editableList-item-content").data("data"))}}),n=$("<div>",{class:"red-ui-search-results-container"}).appendTo(i),t=$("<ol>",{id:"search-result-list",style:"position: absolute;top: 0;bottom: 0;left: 0;right: 0;"}).appendTo(n).editableList({addButton:!1,filter:function(e){return""===r||!e.recent&&!e.common&&(""===r||e.index.indexOf(r)>-1)},addItem:function(e,t,n){var o=n.def;n.index=n.type.toLowerCase(),n.separator&&e.addClass("red-ui-search-result-separator");var i=$("<a>",{href:"#",class:"red-ui-search-result"}).appendTo(e),a=$("<div>",{class:"red-ui-search-result-node"}).appendTo(i),s=o.color,r=RED.utils.getNodeIcon(o);a.css("backgroundColor",s);var d=$("<div/>",{class:"palette_icon_container"}).appendTo(a);$("<div/>",{class:"palette_icon",style:"background-image: url("+r+")"}).appendTo(d),o.inputs>0&&$("<div/>",{class:"red-ui-search-result-node-port"}).appendTo(a),o.outputs>0&&$("<div/>",{class:"red-ui-search-result-node-port red-ui-search-result-node-output"}).appendTo(a);var l=$("<div>",{class:"red-ui-search-result-description"}).appendTo(i),c=n.label;n.index+="|"+c.toLowerCase(),$("<div>",{class:"red-ui-search-result-node-label"}).html(c).appendTo(l),i.click(function(e){e.preventDefault(),p(n)})},scrollOnAdd:!1})}function p(e){f(),d[e.type]=Date.now(),o(e.type)}function u(e){if(s){for(var t=$(e.target);"body"!==t.prop("nodeName").toLowerCase();){if("red-ui-type-search"===t.attr("id"))return;t=t.parent()}f(!0)}}function f(t){s&&(RED.keyboard.remove("escape"),s=!1,null!==i&&n.slideUp(t?50:200,function(){i.hide(),e.searchBox("value","")}),RED.events.emit("type-search:close"),RED.view.focus(),$(document).off("mousedown.type-search"),$(document).off("mouseup.type-search"),$(document).off("click.type-search"))}function h(e,t){var n=e;if(void 0!==t.paletteLabel)try{n=("function"==typeof t.paletteLabel?t.paletteLabel.call(t):t.paletteLabel)||"",n+=" ("+e+")"}catch(t){console.log("Definition error: "+e+".paletteLabel",t)}return n}return{show:function(r){s?(i.hide(),n.hide()):(RED.keyboard.add("*","escape",function(){f()}),null===i&&c(),s=!0,setTimeout(function(){$(document).on("mousedown.type-search",u),$(document).on("mouseup.type-search",u),$(document).on("click.type-search",u)},200)),function(){var n;t.editableList("empty"),e.searchBox("value",""),a=-1;var o=["inject","debug","function","change","switch"],i=Object.keys(d);i.sort(function(e,t){return d[t]-d[e]}),i=i.filter(function(e){return-1===o.indexOf(e)});var s,r=[];for(RED.nodes.registry.getNodeTypes().forEach(function(e){var t=RED.nodes.getType(e);"config"!==t.category&&"unknown"!==e&&"tab"!==e&&r.push({type:e,def:t,label:h(e,t)})}),r.sort(function(e,t){var n=e.label.toLowerCase(),o=t.label.toLowerCase();return n<o?-1:n===o?0:1}),n=0;n<o.length;n++){var l=RED.nodes.getType(o[n]);l&&((s={type:o[n],common:!0,def:l}).label=h(s.type,s.def),n===o.length-1&&(s.separator=!0),t.editableList("addItem",s))}for(n=0;n<Math.min(5,i.length);n++)(s={type:i[n],def:RED.nodes.getType(i[n]),recent:!0}).label=h(s.type,s.def),n===i.length-1&&(s.separator=!0),t.editableList("addItem",s);for(n=0;n<r.length;n++)t.editableList("addItem",r[n]);setTimeout(function(){a=0,t.children(":first").addClass("selected")},100)}(),o=r.add,RED.events.emit("type-search:open"),i.css({left:r.x+"px",top:r.y+"px"}).show(),n.slideDown(300),setTimeout(function(){n.find(".red-ui-editableList-container").scrollTop(0),e.focus()},100)},hide:f}}(),RED.subflow=function(){function e(e,t){var n={x:50,y:30};t||(n.x+=110);for(var o=0;o<e.out.length+e.in.length;o++){var i;(i=o<e.out.length?e.out[o]:e.in[o-e.out.length]).x==n.x&&i.y==n.y&&(n.x+=55,o=0)}return n}function t(){var e=RED.nodes.subflow(RED.workspaces.active());if(0!==e.in.length){var t=e.in[0],n=[];return RED.nodes.eachLink(function(o){"subflow"==o.source.type&&o.source.z==e.id&&o.source.i==t.i?n.push(o):o.target.type=="subflow:"+e.id&&n.push(o)}),n.forEach(function(e){RED.nodes.removeLink(e)}),e.in=[],$("#workspace-subflow-input-add").removeClass("active"),$("#workspace-subflow-input-remove").addClass("active"),e.changed=!0,{subflowInputs:[t],links:n}}}function n(e){var t=RED.nodes.subflow(RED.workspaces.active());if(0!==t.out.length){void 0===e&&(e=[t.out[t.out.length-1]]);var n=[];for(e.sort(function(e,t){return t.i-e.i}),i=0;i<e.length;i++){var o=e[i];t.out.splice(o.i,1);var a=[],s=[];RED.nodes.eachLink(function(e){"subflow"==e.target.type&&e.target.z==t.id&&e.target.i==o.i&&a.push(e),e.source.type=="subflow:"+t.id&&(e.sourcePort==o.i?a.push(e):e.sourcePort>o.i&&s.push(e))}),a.forEach(function(e){RED.nodes.removeLink(e)}),s.forEach(function(e){e.sourcePort--}),n=n.concat(a);for(var r=o.i;r<t.out.length;r++)t.out[r].i--,t.out[r].dirty=!0}return t.changed=!0,{subflowOutputs:e,links:n}}}function o(e){var t=RED.nodes.subflow(RED.workspaces.active());a(t);var n=[];if(t)return RED.nodes.filterNodes({type:"subflow:"+t.id}).forEach(function(o){for(n.push({id:o.id,changed:o.changed}),e&&(o.changed=!0),o.inputs=t.in.length,o.outputs=t.out.length;o.outputs<o.ports.length;)o.ports.pop();o.resize=!0,o.dirty=!0,RED.editor.updateNodeProperties(o)}),RED.editor.validateNode(t),{instances:n}}function a(e){e&&($("#workspace-subflow-input-add").toggleClass("active",0!==e.in.length),$("#workspace-subflow-input-remove").toggleClass("active",0===e.in.length),$("#workspace-subflow-output .spinner-value").html(e.out.length))}function s(i){var s=$("#workspace-toolbar");s.empty(),$('<a class="button" id="workspace-subflow-edit" href="#" data-i18n="[append]subflow.editSubflowProperties"><i class="fa fa-pencil"></i> </a>').appendTo(s),$('<span style="margin-left: 5px;" data-i18n="subflow.input"></span> <div style="display: inline-block;" class="button-group"><a id="workspace-subflow-input-remove" class="button active" href="#">0</a><a id="workspace-subflow-input-add" class="button" href="#">1</a></div>').appendTo(s),$('<span style="margin-left: 5px;" data-i18n="subflow.output"></span> <div id="workspace-subflow-output" style="display: inline-block;" class="button-group spinner-group"><a id="workspace-subflow-output-remove" class="button" href="#"><i class="fa fa-minus"></i></a><div class="spinner-value">3</div><a id="workspace-subflow-output-add" class="button" href="#"><i class="fa fa-plus"></i></a></div>').appendTo(s),$('<a class="button" id="workspace-subflow-delete" href="#" data-i18n="[append]subflow.deleteSubflow"><i class="fa fa-trash"></i> </a>').appendTo(s),s.i18n(),$("#workspace-subflow-output-remove").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),a=i.changed,s=n();if(s){var r=o(!0);RED.history.push({t:"delete",links:s.links,subflowOutputs:s.subflowOutputs,changed:a,dirty:t,subflow:{instances:r.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-output-add").click(function(t){t.preventDefault(),function(t){var n=RED.nodes.subflow(RED.workspaces.active()),i=e(n,!1),a={type:"subflow",direction:"out",z:n.id,i:n.out.length,x:i.x,y:i.y,id:RED.nodes.id()},s=n.out.length;n.out.push(a),n.dirty=!0;var r=RED.nodes.dirty(),d=n.changed;n.changed=!0;var l={t:"edit",node:n,dirty:r,changed:d,subflow:{outputCount:s,instances:o(!0).instances}};RED.history.push(l),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-output .spinner-value").html(n.out.length)}()}),$("#workspace-subflow-input-add").click(function(t){t.preventDefault(),function(){var t=RED.nodes.subflow(RED.workspaces.active());if(1!==t.in.length){var n=e(t,!0),i={type:"subflow",direction:"in",z:t.id,i:t.in.length,x:n.x,y:n.y,id:RED.nodes.id()},a=t.in.length;t.in.push(i),t.dirty=!0;var s=RED.nodes.dirty(),r=t.changed;t.changed=!0;var d={t:"edit",node:t,dirty:s,changed:r,subflow:{inputCount:a,instances:o(!0).instances}};RED.history.push(d),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(),$("#workspace-subflow-input-add").addClass("active"),$("#workspace-subflow-input-remove").removeClass("active")}}()}),$("#workspace-subflow-input-remove").click(function(e){e.preventDefault();var n=RED.nodes.dirty(),a=i.changed;i.changed=!0;var s=t();if(s){var r=o(!0);RED.history.push({t:"delete",links:s.links,changed:a,subflowInputs:s.subflowInputs,dirty:n,subflow:{instances:r.instances}}),RED.view.select(),RED.nodes.dirty(!0),RED.view.redraw(!0)}}),$("#workspace-subflow-edit").click(function(e){RED.editor.editSubflow(RED.nodes.subflow(RED.workspaces.active())),e.preventDefault()}),$("#workspace-subflow-delete").click(function(e){e.preventDefault();var t=RED.nodes.dirty(),n=r(RED.workspaces.active());n.t="delete",n.dirty=t,RED.history.push(n)}),a(i),$("#chart").css({"margin-top":"40px"}),$("#workspace-toolbar").show()}function r(e){var t=[],n=[],o=RED.nodes.subflow(e);RED.nodes.eachNode(function(e){e.type=="subflow:"+o.id&&t.push(e),e.z==o.id&&t.push(e)}),RED.nodes.eachConfig(function(e){e.z==o.id&&t.push(e)});for(var i=[],a=0;a<t.length;a++){var s=RED.nodes.remove(t[a].id);n=n.concat(s.links),i=i.concat(s.nodes)}return t=t.concat(i),RED.nodes.removeSubflow(o),RED.workspaces.remove(o),RED.nodes.dirty(!0),RED.view.redraw(),{nodes:t,links:n,subflow:{subflow:o}}}function d(){var e=0;RED.nodes.eachSubflow(function(t){var n=new RegExp("^Subflow (\\d+)$").exec(t.name);n&&(e=Math.max(e,n[1]))});var t="Subflow "+(e+1),n=RED.nodes.id(),o={type:"subflow",id:n,name:t,info:"",in:[],out:[]};RED.nodes.addSubflow(o),RED.history.push({t:"createSubflow",subflow:{subflow:o},dirty:RED.nodes.dirty()}),RED.workspaces.show(n),RED.nodes.dirty(!0)}function l(){var e=RED.view.selection();if(e.nodes){var t,n,o={},i=[],a=[],s=[],r=[],d={},l=[e.nodes[0].x,e.nodes[0].y,e.nodes[0].x,e.nodes[0].y];for(t=0;t<e.nodes.length;t++)n=e.nodes[t],o[n.id]={n:n,outputs:{}},l=[Math.min(l[0],n.x),Math.min(l[1],n.y),Math.max(l[2],n.x),Math.max(l[3],n.y)];var c=[(l[2]+l[0])/2,(l[3]+l[1])/2];RED.nodes.eachLink(function(e){o[e.source.id]&&o[e.target.id],o[e.source.id]&&!o[e.target.id]&&(r.push(e),a.push(e)),!o[e.source.id]&&o[e.target.id]&&(s.push(e),d[e.target.id]=e.target,a.push(e))});var p={};if((r=r.filter(function(e){return p[e.source.id+":"+e.sourcePort]?(p[e.source.id+":"+e.sourcePort].targets.push(e.target),!1):(e.targets=[],e.targets.push(e.target),p[e.source.id+":"+e.sourcePort]=e,!0)})).sort(function(e,t){return e.source.y-t.source.y}),Object.keys(d).length>1)RED.notify(RED._("subflow.errors.multipleInputsToSelection"),"error");else{var u=0;RED.nodes.eachSubflow(function(e){var t=new RegExp("^Subflow (\\d+)$").exec(e.name);t&&(u=Math.max(u,t[1]))});var f="Subflow "+(u+1),h=RED.nodes.id(),g={type:"subflow",id:h,name:f,info:"",in:Object.keys(d).map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:d[e].x-d[e].w/2-80,y:d[e].y,z:h,i:n,id:RED.nodes.id(),wires:[{id:d[e].id}]}}),out:r.map(function(e,t){var n=t;return{type:"subflow",direction:"in",x:e.source.x+e.source.w/2+80,y:e.source.y,z:h,i:n,id:RED.nodes.id(),wires:[{id:e.source.id,port:e.sourcePort}]}})};RED.nodes.addSubflow(g);var v={id:RED.nodes.id(),type:"subflow:"+g.id,x:c[0],y:c[1],z:RED.workspaces.active(),inputs:g.in.length,outputs:g.out.length,h:Math.max(30,15*(g.out.length||0)),changed:!0};for(v._def=RED.nodes.getType(v.type),RED.editor.validateNode(v),RED.nodes.add(v),s.forEach(function(e){var t={source:e.source,sourcePort:e.sourcePort,target:v};i.push(t),RED.nodes.addLink(t)}),r.forEach(function(e,t){e.targets.forEach(function(e){var n={source:v,sourcePort:t,target:e};i.push(n),RED.nodes.addLink(n)})}),g.in.forEach(function(e){e.wires.forEach(function(t){var n={source:e,sourcePort:0,target:RED.nodes.node(t.id)};i.push(n),RED.nodes.addLink(n)})}),g.out.forEach(function(e,t){e.wires.forEach(function(t){var n={source:RED.nodes.node(t.id),sourcePort:t.port,target:e};i.push(n),RED.nodes.addLink(n)})}),t=0;t<a.length;t++)RED.nodes.removeLink(a[t]);for(t=0;t<e.nodes.length;t++)n=e.nodes[t],/^link /.test(n.type)&&(n.links=n.links.filter(function(e){var t=o.hasOwnProperty(e);if(!t){var i=RED.nodes.node(e);if(i&&i.links){var a=i.links.indexOf(n.id);a>-1&&i.links.splice(a,1)}}return t})),n.z=g.id;RED.history.push({t:"createSubflow",nodes:[v.id],links:i,subflow:{subflow:g},activeWorkspace:RED.workspaces.active(),removedLinks:a,dirty:RED.nodes.dirty()}),RED.view.select(null),RED.editor.validateNode(g),RED.nodes.dirty(!0),RED.view.redraw(!0)}}else RED.notify(RED._("subflow.errors.noNodesSelected"),"error")}return{init:function(){RED.events.on("workspace:change",function(e){var t=RED.nodes.subflow(e.workspace);t?s(t):($("#workspace-toolbar").hide().empty(),$("#chart").css({"margin-top":"0"}))}),RED.events.on("view:selection-changed",function(e){e.nodes?RED.menu.setDisabled("menu-item-subflow-convert",!1):RED.menu.setDisabled("menu-item-subflow-convert",!0)}),RED.actions.add("core:create-subflow",d),RED.actions.add("core:convert-to-subflow",l)},createSubflow:d,convertToSubflow:l,removeSubflow:r,refresh:o,removeInput:t,removeOutput:n}}(),RED.userSettings=function(){var e=700,t=!1,n=[];function o(e){n.push(e)}function i(o){if(!t){t=!0;var i={title:RED._("menu.label.userSettings"),buttons:[{id:"node-dialog-ok",text:RED._("common.label.close"),class:"primary",click:function(){RED.tray.close()}}],resize:function(t){e=t.width},open:function(e){var t=e.find(".editor-tray-body"),i=$("<div></div>").appendTo(t),a=$("<div></div>",{id:"user-settings-tabs-container"}).appendTo(i);$("<ul></ul>",{id:"user-settings-tabs"}).appendTo(a);var s=RED.tabs.create({id:"user-settings-tabs",vertical:!0,onchange:function(e){setTimeout(function(){$("#user-settings-tabs-content").children().hide(),$("#"+e.id).show(),e.pane.focus&&e.pane.focus()},50)}}),r=$("<div></div>",{id:"user-settings-tabs-content"}).appendTo(i);n.forEach(function(e){s.addTab({id:"user-settings-tab-"+e.id,label:e.title,pane:e}),e.get().hide().appendTo(r)}),i.i18n(),s.activateTab("user-settings-tab-"+(o||"view")),$("#sidebar-shade").show()},close:function(){t=!1,n.forEach(function(e){e.close&&e.close()}),$("#sidebar-shade").hide()},show:function(){}};null!==e&&(i.width=e),RED.tray.show(i)}}var a=[{title:"menu.label.view.grid",options:[{setting:"view-show-grid",oldSetting:"menu-menu-item-view-show-grid",label:"menu.label.view.showGrid",toggle:!0,onchange:"core:toggle-show-grid"},{setting:"view-snap-grid",oldSetting:"menu-menu-item-view-snap-grid",label:"menu.label.view.snapGrid",toggle:!0,onchange:"core:toggle-snap-grid"},{setting:"view-grid-size",label:"menu.label.view.gridSize",type:"number",default:20,onchange:RED.view.gridSize}]},{title:"menu.label.nodes",options:[{setting:"view-node-status",oldSetting:"menu-menu-item-status",label:"menu.label.displayStatus",default:!0,toggle:!0,onchange:"core:toggle-status"}]},{title:"menu.label.other",options:[{setting:"view-show-tips",oldSettings:"menu-menu-item-show-tips",label:"menu.label.showTips",toggle:!0,default:!0,onchange:"core:toggle-show-tips"}]}],s={};function r(){var e=$('<div id="user-settings-tab-view" class="node-help"></div>');return a.forEach(function(t){$("<h3></h3>").text(RED._(t.title)).appendTo(e),t.options.forEach(function(t){var n=RED.settings.get(t.setting),o=$('<div class="user-settings-row"></div>').appendTo(e);t.toggle?$('<label for="user-settings-'+t.setting+'"><input id="user-settings-'+t.setting+'" type="checkbox"> '+RED._(t.label)+"</label>").appendTo(o).find("input").prop("checked",n):($('<label for="user-settings-'+t.setting+'">'+RED._(t.label)+"</label>").appendTo(o),$('<input id="user-settings-'+t.setting+'" type="'+(t.type||"text")+'">').appendTo(o).val(n))})}),e}function d(e,t){var n=s[e];RED.settings.set(n.setting,t);var o=n.onchange;"string"==typeof o&&(o=RED.actions.get(o)),o&&o.call(n,t)}return{init:function(){RED.actions.add("core:show-user-settings",i),RED.actions.add("core:show-help",function(){i("keyboard")}),o({id:"view",title:RED._("menu.label.view.view"),get:r,close:function(){a.forEach(function(e){e.options.forEach(function(e){var t=$("#user-settings-"+e.setting);e.toggle?d(e.setting,t.prop("checked")):d(e.setting,t.val())})})}}),a.forEach(function(e){e.options.forEach(function(e){if(e.oldSetting){var t=RED.settings.get(e.oldSetting);void 0!==t&&null!==t&&(RED.settings.set(e.setting,t),RED.settings.remove(e.oldSetting))}if(s[e.setting]=e,e.onchange){var n=RED.settings.get(e.setting);null===n&&e.hasOwnProperty("default")&&(n=e.default,RED.settings.set(e.setting,n));var o=e.onchange;"string"==typeof o&&(o=RED.actions.get(o)),o&&o.call(e,n)}})})},toggle:function(e){var t=s[e];d(e,!RED.settings.get(t.setting))},show:i,add:o}}(),RED.touch=RED.touch||{},RED.touch.radialMenu=function(){var e=null,t=!1,n=!1,o=null;return{show:function(i,a,s){t=!0;try{$("body").width(),$("body").height();for(var r=(e=d3.select("body").append("div").style({position:"absolute",top:0,left:0,bottom:0,right:0,"z-index":1e3}).on("touchstart",function(){v(),d3.event.preventDefault()})).append("div").style({position:"absolute",top:a[1]-80+"px",left:a[0]-80+"px","border-radius":"80px",width:"160px",height:"160px",background:"rgba(255,255,255,0.6)",border:"1px solid #666"}),d=[],l=function(e,t,n){n.el=r.append("div").style({position:"absolute",top:t+80-25+"px",left:e+80-25+"px","border-radius":"20px",width:"50px",height:"50px",background:"#fff",border:"2px solid #666","text-align":"center","line-height":"50px"}),n.el.html(n.name),n.disabled&&n.el.style({"border-color":"#ccc",color:"#ccc"}),n.x=e,n.y=t,d.push(n),n.el.on("touchstart",function(){n.el.style("background","#999"),d3.event.preventDefault(),d3.event.stopPropagation()}),n.el.on("touchend",function(){v(),n.onselect(),d3.event.preventDefault(),d3.event.stopPropagation()})},c=s.length,p=Math.max(Math.PI/(c-1),Math.PI/4),u=Math.PI,f=0;f<c;f++){var h=Math.floor(80*Math.cos(u)),g=Math.floor(80*Math.sin(u));s[f].name&&l(h,g,s[f]),u+=p}var v=function(){t=!1,o=null,e.remove(),e=null};i.on("touchend.radial",function(){if(i.on("touchend.radial",null),i.on("touchmenu.radial",null),o){try{o.onselect()}catch(e){RED._debug(e)}v()}else n&&v()}),i.on("touchmove.radial",function(){try{for(var e=d3.event.touches.item(0),t=[e.pageX-a[0],e.pageY-a[1]],i=0;i<d.length;i++){var s=d[i];s.disabled||(t[0]>s.x-30&&t[0]<s.x+30&&t[1]>s.y-30&&t[1]<s.y+30?s!==o&&(s.el.style("background","#999"),o=s):s===o?(s.el.style("background","#fff"),o=null):s.el.style("background","#fff"))}if(!o){var r=Math.abs(t[0]*t[0]+t[1]*t[1]);n=r>6400}}catch(e){RED._debug(e)}})}catch(e){RED._debug(e)}},active:function(){return t}}}();